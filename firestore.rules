rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }

    // Allow each signed-in user to read their own allowlist entry
    // Path: system/allowlist/users/{uid}
    match /system/allowlist/users/{userId} {
      allow read: if isSelf(userId);
      // Writes should be managed by admins/backends only
      allow write: if false;
    }

    // Artifacts namespace (assessments UI reads from here)
    match /artifacts/{appId} {
      // Public data readable by signed-in users
      match /public/{document=**} {
        allow read: if isSignedIn();
        // Writes to public data via trusted backends only
        allow write: if false;
      }

      // Legacy per-user private profile/role doc (optional)
      match /private/users/{userId} {
        allow read: if isSelf(userId);
        allow create: if isSelf(userId);
        // Role updates must be via admin/backends
        allow update, delete: if false;
      }

      // Other private docs locked down
      match /private/{document=**} {
        allow read, write: if false;
      }
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}