rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helpers ---
    function isSignedIn() {
      return request.auth != null;
    }

    function allowlist(uid) {
      return get(/databases/$(database)/documents/system/allowlist/users/$(uid));
    }

    // Case-insensitive "admin"
    function allowlistRoleIsAdmin() {
      return (
        (allowlist(request.auth.uid).data.role is string &&
         allowlist(request.auth.uid).data.role.matches('^[Aa][Dd][Mm][Ii][Nn]$')) ||
        (allowlist(request.auth.uid).data.Role is string &&
         allowlist(request.auth.uid).data.Role.matches('^[Aa][Dd][Mm][Ii][Nn]$')) ||
        (allowlist(request.auth.uid).data.ROLE is string &&
         allowlist(request.auth.uid).data.ROLE.matches('^[Aa][Dd][Mm][Ii][Nn]$'))
      );
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        (allowlist(request.auth.uid).exists() && (
          allowlist(request.auth.uid).data.admin == true ||
          allowlistRoleIsAdmin()
        ))
      );
    }

    // --- Allowlist doc (read own only) ---
    match /system/allowlist/users/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow write: if false;
    }

    // --- Public data (read-only) ---
    match /artifacts/{app}/public/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // --- Admin-only (Task Dashboard etc.) ---
    match /artifacts/{app}/private/admin/{document=**} {
      allow read, write: if isAdmin();
    }
  }
}