<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Project Guardian – WERP Reports</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js (for radar) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- DOMPurify for safe HTML rendering in the report pane -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width: 100%; height: 460px; border-radius: 10px; }

    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid; }
    .pill.low { color:#065f46; background:#ecfdf5; border-color:#10b981; }
    .pill.medium { color:#92400e; background:#fffbeb; border-color:#f59e0b; }
    .pill.high { color:#991b1b; background:#fef2f2; border-color:#ef4444; }
    .pill.unknown { color:#334155; background:#f1f5f9; border-color:#cbd5e1; }

    /* Report content: keep it readable and contained */
    .report-prose { max-width: none; }
    .report-prose * { max-width: 100%; overflow-wrap: anywhere; word-break: break-word; }
    .report-prose p,
    .report-prose ul,
    .report-prose ol,
    .report-prose table,
    .report-prose pre,
    .report-prose blockquote,
    .report-prose h1,
    .report-prose h2,
    .report-prose h3,
    .report-prose h4,
    .report-prose h5,
    .report-prose h6 { margin-top: 0.5rem; margin-bottom: 0.5rem; }

    .report-prose img,
    .report-prose video,
    .report-prose iframe { max-width: 100%; height: auto; }

    .report-prose table { width: 100%; border-collapse: collapse; display: block; overflow-x: auto; }
    .report-prose th, .report-prose td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; vertical-align: top; }
    .report-prose th { background: #f9fafb; font-weight: 600; }

    .report-prose pre { white-space: pre-wrap; background: #f8fafc; padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .report-prose blockquote { margin: .5rem 0; padding-left: .75rem; border-left: 3px solid #e5e7eb; color:#374151; }

    .list-item { cursor: pointer; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; }
    .list-item:hover { background: #f9fafb; }
  </style>
</head>
<body class="bg-slate-50 text-gray-900">
  <!-- Header with logos (left), centered title, and auth/admin (right) -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-3 gap-3 items-center">
      <!-- Left: Logos -->
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Marinas Guardian Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Deeptrek Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
      </div>

      <!-- Center: Title -->
      <div class="text-center">
        <h1 class="text-lg sm:text-xl font-semibold">Project Guardian – WERP Reports</h1>
      </div>

      <!-- Right: Admin + user -->
      <div class="flex items-center justify-end gap-2">
        <a id="adminToolsBtn" href="/admin-tools.html" class="hidden bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-1.5 rounded" title="Open Admin Tools">Admin Tools</a>
        <span id="userName" class="hidden text-xs text-indigo-200"></span>
        <button id="signOutBtn" class="hidden bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1.5 rounded">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Signed-out auth -->
    <section id="signedOutContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 max-w-md mx-auto">
      <h2 class="text-xl font-semibold text-gray-800 mb-2 text-center">Welcome</h2>
      <p class="text-gray-600 mb-4 text-center">Sign in with your email and password to continue.</p>

      <div class="space-y-3">
        <label class="block">
          <span class="text-sm text-gray-700">Email</span>
          <input id="emailInput" type="email" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="you@example.com" autocomplete="email" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Password</span>
          <input id="passwordInput" type="password" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="••••••••" autocomplete="current-password" />
        </label>
        <p id="authMessage" class="text-sm h-5 text-center text-gray-500" aria-live="polite"></p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <button id="signInEmailBtn" class="flex-1 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Sign in</button>
          <button id="createAccountBtn" class="flex-1 px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Create account</button>
        </div>
        <button id="resetPasswordBtn" class="w-full text-sm text-indigo-700 hover:underline mt-1">Forgot password?</button>
      </div>
      <p class="text-xs text-gray-500 mt-6 text-center">
        New accounts start as read-only Users. Admin approval is required for Contributor access.
      </p>
    </section>

    <!-- App container -->
    <div id="appContainer" class="hidden space-y-6">
      <!-- Analyze single vessel -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-gray-800">Analyze New Vessel</h2>
          </div>
          <div class="flex items-center gap-2">
            <span id="roleBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-300">Role: —</span>
            <span id="contribHint" class="text-xs text-gray-500 hidden">Contributor access required</span>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <input type="text" id="vesselName" class="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., USS Chevalier" aria-label="Vessel name" />
          <button id="analyzeBtn" class="bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-800 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Run analysis (Contributors only)">
            <span id="analyzeText">Analyze Wreck</span>
          </button>
        </div>
        <p id="statusMessage" class="text-sm text-gray-500 mt-3 h-5" aria-live="polite"></p>
      </section>

      <!-- Filters -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="text-sm font-medium text-gray-800">Severity Filters</h3>
            <div class="flex items-center gap-4 mt-1 text-sm">
              <label class="flex items-center gap-2"><input id="sevHigh" type="checkbox" class="h-4 w-4" checked> High</label>
              <label class="flex items-center gap-2"><input id="sevMedium" type="checkbox" class="h-4 w-4" checked> Medium</label>
              <label class="flex items-center gap-2"><input id="sevLow" type="checkbox" class="h-4 w-4" checked> Low</label>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search vessel name..." class="w-64 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="clearSearch" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <div class="text-xs text-gray-600">Showing: <span id="visibleCounts">0</span></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Severity = (WCS + PHS + (ESI ÷ 3)) × RPM.</p>
      </section>

      <!-- Evidence: embedded screenshot to show current issue -->
      <!-- Save your screenshot at: public/assets/evidence-assessments.png -->
      <section id="evidenceSection" class="bg-white border border-amber-200 rounded-xl shadow p-4">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-amber-800">Evidence: Initial Assessments visible, severity values now present; full report previously overflowed</h3>
          <button id="toggleEvidenceBtn" class="text-xs text-amber-700 hover:underline">Hide</button>
        </div>
        <p class="text-xs text-amber-700 mt-1">If the image doesn't load, ensure the file exists at /assets/evidence-assessments.png.</p>
        <div id="evidenceWrapper" class="mt-3">
          <img id="evidenceImg" src="/assets/evidence-assessments.png" alt="Screenshot showing Initial Assessments list and severity values" class="w-full rounded border border-amber-200">
        </div>
      </section>

      <!-- No data banner -->
      <section id="noDataBanner" class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-md p-3 hidden">
        No assessments found at <span id="assessPathSpan" class="font-mono"></span> for appId
        <span id="appIdSpan" class="font-mono"></span>. Check the collection name and casing in Firestore.
      </section>

      <!-- Map -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-3">
        <div id="map"></div>
      </section>

      <!-- Lists -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Initial -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Initial Assessments</h2>
            <span id="initialCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="initialWreckList" class="space-y-2"></div>
          <div id="noInitialWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No initial assessments match your filters.</div>
        </div>

        <!-- Completed -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Completed Assessments</h2>
            <span id="completedCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="completedWreckList" class="space-y-2"></div>
          <div id="noCompletedWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No completed assessments match your filters.</div>
        </div>

        <!-- Reassessment -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Requiring Reassessment</h2>
            <span id="reassessCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="reassessList" class="space-y-2"></div>
          <div id="noReassessMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No reassessments match your filters.</div>
        </div>
      </section>

      <!-- Full report panel -->
      <section id="reportContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 hidden">
        <h2 id="reportTitle" class="text-2xl font-bold mb-4 text-center text-gray-900"></h2>
        <div id="alert-display-section" class="hidden mb-4"></div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <!-- Make the left column scroll within the panel to prevent page growing indefinitely -->
          <div class="lg:col-span-3">
            <div id="reportScroll" class="max-h-[70vh] overflow-y-auto pr-2">
              <div id="reportContent" class="report-prose"></div>
            </div>
          </div>
          <div class="lg:col-span-2">
            <h3 class="text-base font-bold mb-3 text-center text-gray-900">WERP Risk Profile</h3>
            <canvas id="werSpiderChart" aria-label="WERP risk profile radar chart"></canvas>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
      authDomain: "project-guardian-agent.firebaseapp.com",
      projectId: "project-guardian-agent",
      storageBucket: "project-guardian-agent.firebasestorage.app",
      messagingSenderId: "84395007243",
      appId: "1:84395007243:web:b07e5f4c4264d27611160e",
      measurementId: "G-NRLH3WSCQ9"
    };

    // Set to your actual artifacts doc id
    const appId = 'guardian';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app, 'us-central1');

    // Callable functions
    const callGeminiFunction = httpsCallable(functions, 'callGeminiApi');

    // Assessments path (no capitalization)
    const assessmentsPath = `artifacts/${appId}/public/data/werpassessments`;

    // Debug flag (set to false to silence console logs)
    const DEBUG = true;

    // Evidence toggle
    const toggleEvidenceBtn = document.getElementById('toggleEvidenceBtn');
    const evidenceWrapper = document.getElementById('evidenceWrapper');
    toggleEvidenceBtn?.addEventListener('click', () => {
      const hidden = evidenceWrapper.classList.toggle('hidden');
      toggleEvidenceBtn.textContent = hidden ? 'Show' : 'Hide';
    });

    // Role helper: reads Role/role (case-insensitive) from allowlist, fallback to legacy private path
    async function fetchRoleFor(uid) {
      try {
        const allowDocRef = doc(db, 'system', 'allowlist', 'users', uid);
        const allowDoc = await getDoc(allowDocRef);
        if (allowDoc.exists()) {
          const d = allowDoc.data() || {};
          let r = d.role ?? d.Role ?? d.ROLE;
          if (typeof r === 'string' && r.trim()) {
            r = r.trim().toLowerCase();
            if (r.startsWith('admin')) return 'admin';
            if (r.startsWith('contrib')) return 'contributor';
            if (r === 'user' || r === 'reader' || r === 'viewer') return 'user';
          }
          if (d.admin === true) return 'admin';
          if (d.contributor === true) return 'contributor';
          if (d.allowed === true) return 'user';
        }
      } catch (e) { /* ignore */ }

      try {
        const legacyRef = doc(db, `artifacts/${appId}/private/users/${uid}`);
        const legacyDoc = await getDoc(legacyRef);
        if (legacyDoc.exists()) {
          const d = legacyDoc.data() || {};
          let r = d.role ?? d.Role ?? d.ROLE;
          if (typeof r === 'string' && r.trim()) {
            r = r.trim().toLowerCase();
            if (r.startsWith('admin')) return 'admin';
            if (r.startsWith('contrib')) return 'contributor';
            if (r === 'user' || r === 'reader' || r === 'viewer') return 'user';
          }
          if (d.admin === true) return 'admin';
          if (d.contributor === true) return 'contributor';
        }
      } catch (e) { /* ignore */ }

      return 'user';
    }

    // Helpers
    function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function isFiniteNum(n){ return typeof n === 'number' && Number.isFinite(n); }
    function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : null; }
    function getText(v) { if (v == null) return null; const s = String(v).trim(); return s.length ? s : null; }

    // Deep getter by path like "phase1.screening.WCS"
    function deepGet(obj, path) {
      const parts = path.split('.');
      let cur = obj;
      for (const p of parts) {
        if (cur == null) return undefined;
        cur = cur[p];
      }
      return cur;
    }

    // Try to coerce various shapes into a numeric value
    function coerceToNumber(val) {
      if (typeof val === 'number') return Number.isFinite(val) ? val : null;

      if (typeof val === 'string') {
        const s = val.trim();
        if (/^low$/i.test(s)) return 3;
        if (/^med(iu)?m$/i.test(s)) return 6;
        if (/^high$/i.test(s)) return 9;
        const m = s.match(/-?\d+(\.\d+)?/);
        if (m) return Number(m[0]);
        return null;
      }

      if (Array.isArray(val)) {
        for (const x of val) {
          const n = coerceToNumber(x);
          if (n != null) return n;
        }
        return null;
      }

      if (val && typeof val === 'object') {
        const candKeys = ['value','score','val','num','amount','rating','points','v','s'];
        for (const k of candKeys) {
          if (k in val) {
            const n = coerceToNumber(val[k]);
            if (n != null) return n;
          }
        }
        const bandStr = val.band ?? val.level ?? val.name ?? val.label;
        const t = getText(bandStr);
        if (t) {
          if (/^low$/i.test(t)) return 3;
          if (/^med(iu)?m$/i.test(t)) return 6;
          if (/^high$/i.test(t)) return 9;
          const m = t.match(/-?\d+(\.\d+)?/);
          if (m) return Number(m[0]);
        }
        for (const v of Object.values(val)) {
          const n = coerceToNumber(v);
          if (n != null) return n;
        }
      }

      return null;
    }

    // Read a number from nested paths, applying coercion for strings/objects
    function readNumberByPaths(obj, paths) {
      for (const p of paths) {
        const v = deepGet(obj, p);
        const n = coerceToNumber(v);
        if (n !== null) return n;
      }
      return null;
    }

    // Shallow merge common nested holders into top-level
    function normalizeDoc(d) {
      const out = { ...d };
      if (d && typeof d.data === 'object' && d.data) Object.assign(out, d.data);
      if (d && typeof d.payload === 'object' && d.payload) Object.assign(out, d.payload);
      if (d && typeof d.attributes === 'object' && d.attributes) Object.assign(out, d.attributes);
      if (d && typeof d.details === 'object' && d.details) Object.assign(out, d.details);
      if (d && typeof d.meta === 'object' && d.meta) out.meta = { ...d.meta };
      if (d && typeof d.metadata === 'object' && d.metadata) out.metadata = { ...d.metadata };
      return out;
    }

    // Flatten to heuristically find vessel names
    function flattenObject(obj, maxDepth = 3) {
      const out = [];
      function rec(cur, depth) {
        if (!cur || typeof cur !== 'object' || depth > maxDepth) return;
        for (const [k, v] of Object.entries(cur)) {
          out.push([k, v]);
          if (v && typeof v === 'object') rec(v, depth + 1);
        }
      }
      rec(obj, 0);
      return out;
    }

    // Heuristic vessel name resolver
    function getVesselName(it) {
      const direct = [
        it.vesselName, it.name, it.title, it.displayName, it.label,
        it.vessel?.name, it.ship?.name, it.wreck?.name, it.wreckName, it.shipName,
        it.meta?.vesselName, it.meta?.name, it.meta?.title,
        it.metadata?.vesselName, it.metadata?.name, it.metadata?.title,
        it.phase1?.screening?.vesselName,
        it['vessel_name'], it['Vessel Name'], it['VESSEL_NAME'],
        it['wreck_title'], it['ship_name'], it['Ship Name'], it['Name']
      ];
      for (const c of direct) { const t = getText(c); if (t) return t; }

      const pairs = flattenObject(it, 3);
      const keyRx = /(vessel|wreck|ship|name|title)/i;
      for (const [k, v] of pairs) { if (!keyRx.test(k)) continue; const t = getText(v); if (t) return t; }

      return getText(it.id) || 'Unknown';
    }

    // Compute severity value from multiple possible fields or from formula
    function computeFormulaSeverity(item) {
      const W = readNumberByPaths(item, [
        'severity.components.WCS','scores.WCS','wcs','WCS','risk.WCS',
        'phase2.scores.WCS','phase1.screening.WCS','metrics.WCS','values.WCS','phase1.WCS','screening.WCS','phase1.wcs'
      ]);
      const P = readNumberByPaths(item, [
        'severity.components.PHS','scores.PHS','phs','PHS','risk.PHS',
        'phase2.scores.PHS','phase1.screening.PHS','metrics.PHS','values.PHS','phase1.PHS','screening.PHS','phase1.phs'
      ]);
      const E = readNumberByPaths(item, [
        'severity.components.ESI','scores.ESI','esi','ESI','risk.ESI',
        'phase2.scores.ESI','phase1.screening.ESI','metrics.ESI','values.ESI','phase1.ESI','screening.ESI','phase1.esi'
      ]);
      const R = readNumberByPaths(item, [
        'severity.components.RPM','scores.RPM','rpm','RPM','risk.RPM',
        'phase2.scores.RPM','phase1.screening.RPM','metrics.RPM','values.RPM','phase1.RPM','screening.RPM','phase1.rpm'
      ]);

      if ([W,P,E,R].every(v => v !== null)) return (W + P + (E / 3)) * R;
      return null;
    }

    function getSeverityValue(item) {
      const direct = readNumberByPaths(item, [
        'severity.value','severityValue','severity_score','severityScore','score',
        'risk.severity','risk.score','metrics.severity','values.severity'
      ]);
      if (direct !== null) return direct;

      const formula = computeFormulaSeverity(item);
      if (formula !== null) return formula;

      const sevBandText = deepGet(item, 'severity.band') ?? deepGet(item, 'severity.level') ?? item.severity;
      const s = getText(sevBandText);
      if (s) {
        if (/^low$/i.test(s)) return 3;
        if (/^med(iu)?m$/i.test(s)) return 6;
        if (/^high$/i.test(s)) return 9;
        const m = s.match(/-?\d+(\.\d+)?/);
        if (m) return Number(m[0]);
      }

      return null;
    }

    function bandFromValue(val){
      const v = Number(val);
      if (!Number.isFinite(v)) return 'unknown';
      if (v >= 7.5) return 'high';
      if (v >= 4) return 'medium';
      return 'low';
    }

    // Role/permissions
    let currentRole = 'user';

    // Map and markers
    let map;
    let markers = new Map();

    // Chart instance
    let radarChart = null;

    // Data subscription
    let dataUnsub = null;
    let allItems = [];

    // DOM refs
    const signedOutContainer = document.getElementById('signedOutContainer');
    const appContainer = document.getElementById('appContainer');
    const adminToolsBtn = document.getElementById('adminToolsBtn');
    const userNameSpan = document.getElementById('userName');
    const signOutBtn = document.getElementById('signOutBtn');
    const roleBadge = document.getElementById('roleBadge');
    const contribHint = document.getElementById('contribHint');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeText = document.getElementById('analyzeText');
    const vesselNameInput = document.getElementById('vesselName');
    const statusMessage = document.getElementById('statusMessage');
    const authMessage = document.getElementById('authMessage');

    const sevHigh = document.getElementById('sevHigh');
    const sevMedium = document.getElementById('sevMedium');
    const sevLow = document.getElementById('sevLow');
    const searchBox = document.getElementById('searchBox');
    const clearSearch = document.getElementById('clearSearch');
    const visibleCounts = document.getElementById('visibleCounts');

    const initialList = document.getElementById('initialWreckList');
    const completedList = document.getElementById('completedWreckList');
    const reassessList = document.getElementById('reassessList');
    const initialCount = document.getElementById('initialCount');
    const completedCount = document.getElementById('completedCount');
    const reassessCount = document.getElementById('reassessCount');
    const noInitial = document.getElementById('noInitialWrecksMessage');
    const noCompleted = document.getElementById('noCompletedWrecksMessage');
    const noReassess = document.getElementById('noReassessMessage');

    const reportContainer = document.getElementById('reportContainer');
    const reportTitle = document.getElementById('reportTitle');
    const reportContent = document.getElementById('reportContent');

    const noDataBanner = document.getElementById('noDataBanner');
    const assessPathSpan = document.getElementById('assessPathSpan');
    const appIdSpan = document.getElementById('appIdSpan');

    appIdSpan.textContent = appId;
    assessPathSpan.textContent = assessmentsPath;

    // Auth UI
    document.getElementById('signInEmailBtn').addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      authMessage.textContent = '';
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMessage.textContent = e.message || 'Sign-in failed.';
      }
    });

    document.getElementById('createAccountBtn').addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      authMessage.textContent = '';
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        try {
          await setDoc(doc(db, `artifacts/${appId}/private/users/${cred.user.uid}`), {
            email,
            role: 'user',
            createdAt: serverTimestamp()
          }, { merge: true });
        } catch {}
        authMessage.textContent = 'Account created. You are signed in as User.';
      } catch (e) {
        authMessage.textContent = e.message || 'Account creation failed.';
      }
    });

    document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      if (!email) { authMessage.textContent = 'Enter your email first.'; return; }
      try {
        await sendPasswordResetEmail(auth, email);
        authMessage.textContent = 'Password reset email sent.';
      } catch (e) {
        authMessage.textContent = e.message || 'Password reset failed.';
      }
    });

    signOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); } catch {}
    });

    onAuthStateChanged(auth, async (user) => {
      if (dataUnsub) { try { dataUnsub(); } catch {} dataUnsub = null; }

      if (!user) {
        signedOutContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
        adminToolsBtn.classList.add('hidden');
        userNameSpan.classList.add('hidden');
        signOutBtn.classList.add('hidden');
        currentRole = 'user';
        roleBadge.textContent = 'Role: —';
        analyzeBtn.disabled = true;
        contribHint.classList.remove('hidden');
        return;
      }

      signedOutContainer.classList.add('hidden');
      appContainer.classList.remove('hidden');
      userNameSpan.textContent = user.email || user.uid;
      userNameSpan.classList.remove('hidden');
      signOutBtn.classList.remove('hidden');

      currentRole = await fetchRoleFor(user.uid);
      roleBadge.textContent = `Role: ${currentRole}`;
      const isAdmin = currentRole === 'admin';
      const isContributor = isAdmin || currentRole === 'contributor';
      if (isAdmin) adminToolsBtn.classList.remove('hidden'); else adminToolsBtn.classList.add('hidden');
      analyzeBtn.disabled = !isContributor;
      if (!isContributor) contribHint.classList.remove('hidden'); else contribHint.classList.add('hidden');

      initMap();
      await startData();
    });

    // Analyze action
    analyzeBtn.addEventListener('click', async () => {
      const name = vesselNameInput.value.trim();
      statusMessage.textContent = '';
      if (!name) { statusMessage.textContent = 'Enter a vessel name.'; return; }
      if (analyzeBtn.disabled) { statusMessage.textContent = 'Contributor access required.'; return; }

      analyzeBtn.disabled = true;
      analyzeText.textContent = 'Analyzing...';
      try {
        await callGeminiFunction({ vesselName: name, appId });
        statusMessage.textContent = 'Analysis requested. It may take a moment to appear.';
        vesselNameInput.value = '';
      } catch (e) {
        statusMessage.textContent = e.message || 'Failed to start analysis.';
      } finally {
        analyzeBtn.disabled = false;
        analyzeText.textContent = 'Analyze Wreck';
      }
    });

    // Map
    const MAPBOX_TOKEN = "pk.eyJ1IjoidXNoMjE0IiwiYSI6ImNtZmNnZzV1YjFxMG0ybHM2MnI5aGN6bzIifQ.0FPMf68cgCHTCOsolzB1_w";

    function initMap(){
      if (map) return;
      map = L.map('map').setView([10, 150], 3);
      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        id: 'mapbox/streets-v12',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: MAPBOX_TOKEN,
        attribution: '&copy; OpenStreetMap &copy; Mapbox'
      }).addTo(map);
    }

    function markerIconFor(band){
      const color = band === "high" ? "red" : band === "medium" ? "orange" : band === "low" ? "green" : "blue";
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });
    }

    function upsertMarker(item){
      const coords = item?.phase1?.screening?.coordinates || item?.coordinates || item?.location || item?.geo || item?.position;
      const id = item?.id;
      if (!id) return;

      const lat = coords?.latitude ?? coords?.lat ?? coords?.y;
      const lng = coords?.longitude ?? coords?.lng ?? coords?.x;
      if (lat == null || lng == null) return;

      const sv = getSeverityValue(item);
      const band = item?.severity?.band || bandFromValue(sv);
      const pos = [Number(lat), Number(lng)];
      const title = escapeHtml(getVesselName(item));
      const svTxt = isFiniteNum(sv) ? sv.toFixed(2) : 'N/A';
      const popupHtml = `<div><strong>${title}</strong><br/>Severity: ${(band||"").toUpperCase()} ${svTxt}</div>`;

      if (markers.has(id)) {
        const m = markers.get(id);
        m.setLatLng(pos);
        m.setIcon(markerIconFor(band));
        m.setPopupContent(popupHtml);
      } else {
        const m = L.marker(pos, { icon: markerIconFor(band) }).addTo(map).bindPopup(popupHtml);
        markers.set(id, m);
      }
    }

    function clearMarkers(){
      for (const m of markers.values()){
        try { map.removeLayer(m); } catch {}
      }
      markers = new Map();
    }

    // Radar chart
    function renderRadar(item) {
      const ctx = document.getElementById('werSpiderChart').getContext('2d');
      const wcs = readNumberByPaths(item, ['scores.WCS','wcs','WCS']) ?? 0;
      const phs = readNumberByPaths(item, ['scores.PHS','phs','PHS']) ?? 0;
      const esi = readNumberByPaths(item, ['scores.ESI','esi','ESI']) ?? 0;
      const rpm = readNumberByPaths(item, ['scores.RPM','rpm','RPM']) ?? 0;

      const data = {
        labels: ['WCS', 'PHS', 'ESI', 'RPM'],
        datasets: [{
          label: 'Risk',
          data: [wcs, phs, esi, rpm],
          fill: true,
          backgroundColor: 'rgba(79, 70, 229, 0.2)',
          borderColor: 'rgba(79, 70, 229, 1)',
          pointBackgroundColor: 'rgba(79, 70, 229, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
        }]
      };
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            suggestedMax: 10,
            grid: { color: 'rgba(0,0,0,0.1)' },
            angleLines: { color: 'rgba(0,0,0,0.1)' },
            pointLabels: { color: '#111827', font: { size: 12 } }
          }
        },
        plugins: { legend: { display: false } }
      };

      if (radarChart) { radarChart.destroy(); }
      radarChart = new Chart(ctx, { type: 'radar', data, options });
    }

    async function startData() {
      if (dataUnsub) return;
      const colRef = collection(db, assessmentsPath);

      let logCount = 0;
      dataUnsub = onSnapshot(colRef, (snap) => {
        allItems = [];
        snap.forEach(docSnap => {
          const raw = docSnap.data() || {};
          const d0 = normalizeDoc(raw);
          const d = { ...d0 };
          d.id = d.id || docSnap.id;

          const sv = getSeverityValue(d);
          if (!d.severity || typeof d.severity !== 'object') d.severity = {};
          d.severity.value = sv; // may be null
          d.severity.band = d.severity.band || bandFromValue(sv);

          if (DEBUG && logCount < 5) {
            const w = readNumberByPaths(d, ['scores.WCS','wcs','WCS']);
            const p = readNumberByPaths(d, ['scores.PHS','phs','PHS']);
            const e = readNumberByPaths(d, ['scores.ESI','esi','ESI']);
            const r = readNumberByPaths(d, ['scores.RPM','rpm','RPM']);
            console.log('[WERP] Sample doc', docSnap.id, {
              vesselNameResolved: getVesselName(d),
              severityValue: sv,
              extracted: { WCS: w, PHS: p, ESI: e, RPM: r },
              topLevelKeys: Object.keys(raw || {})
            });
            logCount++;
          }

          allItems.push(d);
        });

        if (DEBUG) console.log('[WERP] Loaded docs:', allItems.length, 'from', assessmentsPath);
        render();
      }, (err) => {
        console.error('Snapshot error', err);
      });
    }

    // Filtering + rendering
    [sevHigh, sevMedium, sevLow].forEach(cb => cb.addEventListener('change', render));
    searchBox.addEventListener('input', render);
    clearSearch.addEventListener('click', () => { searchBox.value = ''; render(); });

    function render() {
      noDataBanner.classList.toggle('hidden', allItems.length !== 0);

      const activeBands = new Set();
      if (sevHigh.checked) activeBands.add('high');
      if (sevMedium.checked) activeBands.add('medium');
      if (sevLow.checked) activeBands.add('low');
      const term = searchBox.value.trim().toLowerCase();

      const filtered = allItems.filter(it => {
        const band = it?.severity?.band || 'unknown';
        if (!activeBands.has(band) && band !== 'unknown') return false;
        if (term) {
          const name = getVesselName(it).toLowerCase();
          if (!name.includes(term)) return false;
        }
        return true;
      });

      const initial = [];
      const completed = [];
      const reassess = [];

      for (const it of filtered) {
        const needsRe = Boolean(it?.needsReassessment);
        const hasAlerts = Array.isArray(it?.alerts) && it.alerts.some(a => a && a.acknowledged === false);
        const reqReassess = needsRe || hasAlerts;

        const isCompleted = Boolean(it?.completed || it?.status === 'completed' || it?.phase3 || it?.finalizedAt);
        const isInitial = !isCompleted && !reqReassess;

        if (reqReassess) reassess.push(it);
        else if (isCompleted) completed.push(it);
        else initial.push(it);
      }

      const valOfSeverity = o => isFiniteNum(o?.severity?.value) ? o.severity.value : -Infinity;
      const bySeverity = (a, b) => valOfSeverity(b) - valOfSeverity(a);
      initial.sort(bySeverity);
      completed.sort(bySeverity);
      reassess.sort(bySeverity);

      drawList(initialList, initial);
      drawList(completedList, completed);
      drawList(reassessList, reassess);

      initialCount.textContent = String(initial.length);
      completedCount.textContent = String(completed.length);
      reassessCount.textContent = String(reassess.length);

      noInitial.classList.toggle('hidden', initial.length !== 0);
      noCompleted.classList.toggle('hidden', completed.length !== 0);
      noReassess.classList.toggle('hidden', reassess.length !== 0);

      clearMarkers();
      for (const it of filtered) upsertMarker(it);

      const total = allItems.length;
      const vis = filtered.length;
      visibleCounts.textContent = `${vis} of ${total}`;
    }

    function drawList(container, items) {
      container.innerHTML = '';
      for (const it of items) {
        const li = document.createElement('div');
        li.className = 'list-item flex items-center justify-between gap-3';
        const band = it?.severity?.band || 'unknown';
        const vessel = escapeHtml(getVesselName(it));
        const sv = it?.severity?.value;
        const svTxt = isFiniteNum(sv) ? sv.toFixed(2) : 'N/A';
        li.innerHTML = `
          <div class="min-w-0">
            <div class="text-sm font-semibold text-gray-900 truncate">${vessel || 'Unknown'}</div>
            <div class="text-xs text-gray-500">Severity: ${band.toUpperCase()} ${svTxt}</div>
          </div>
          <span class="pill ${band}">${band.toUpperCase()}</span>
        `;
        li.addEventListener('click', () => openReport(it));
        container.appendChild(li);
      }
    }

    // Clean and constrain incoming HTML so it doesn't blow up layout
    function sanitizeReportHtml(html) {
      // Basic sanitize
      let safe = DOMPurify.sanitize(html || '', {
        RETURN_TRUSTED_TYPE: false,
        WHOLE_DOCUMENT: false,
        USE_PROFILES: { html: true },
        FORBID_TAGS: ['script', 'style', 'link'],
        FORBID_ATTR: ['style', 'onerror', 'onload']
      });
      // Condense excessive <br> runs
      safe = safe.replace(/(?:<br\s*\/?>\s*){3,}/gi, '<br><br>');
      return safe;
    }

    function renderFallbackSummary(item) {
      // Use summary/finalSummary if present, otherwise a table with basics
      const texts = [
        item?.finalSummary, item?.summary, item?.phase1?.summary, item?.conclusion
      ].filter(t => typeof t === 'string' && t.trim().length);

      if (texts.length) {
        const blocks = texts.map(t => `<p>${escapeHtml(t).replace(/\n{2,}/g, '\n\n').replace(/\n/g, '<br>')}</p>`).join('');
        return `<div>${blocks}</div>`;
      }

      // Last resort summary table
      const vessel = escapeHtml(getVesselName(item));
      const sv = item?.severity?.value;
      const svTxt = isFiniteNum(sv) ? sv.toFixed(2) : 'N/A';
      return `
        <h3>Summary</h3>
        <table>
          <tr><th>Vessel</th><td>${vessel}</td></tr>
          <tr><th>Severity</th><td>${(item?.severity?.band || 'unknown').toUpperCase()} ${svTxt}</td></tr>
          <tr><th>Needs Reassessment</th><td>${Boolean(item?.needsReassessment) ? 'Yes' : 'No'}</td></tr>
          <tr><th>Alerts</th><td>${Array.isArray(item?.alerts) ? item.alerts.length : 0}</td></tr>
        </table>
      `;
    }

    function openReport(item) {
      const vessel = getVesselName(item);
      reportTitle.textContent = vessel || 'Assessment';

      // Prefer explicit HTML fields
      const rawHtml =
        item?.report?.html ||
        item?.html ||
        item?.reportHtml ||
        item?.report_markdown || // some sources store md/html here
        null;

      if (rawHtml && typeof rawHtml === 'string') {
        const safe = sanitizeReportHtml(rawHtml);
        document.getElementById('reportContent').innerHTML = safe;
      } else {
        // Fallback: render summaries cleanly
        document.getElementById('reportContent').innerHTML = renderFallbackSummary(item);
      }

      renderRadar(item);
      reportContainer.classList.remove('hidden');
      // Scroll the report panel into view but keep it from pushing the page height
      reportContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  </script>
</body>
</html>