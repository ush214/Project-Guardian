<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Project Guardian – WERP Reports</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js (for radar) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width: 100%; height: 460px; border-radius: 10px; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid; }
    .pill.low { color:#065f46; background:#ecfdf5; border-color:#10b981; }
    .pill.medium { color:#92400e; background:#fffbeb; border-color:#f59e0b; }
    .pill.high { color:#991b1b; background:#fef2f2; border-color:#ef4444; }
    .note { font-size: 12px; color:#6b7280; }
    .prose h3 { font-weight: 700; margin-top: 1rem; }
    .prose table { width: 100%; border-collapse: collapse; margin-top: .25rem; }
    .prose th, .prose td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; vertical-align: top; }
    .prose th { background: #f9fafb; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-50 text-gray-900">
  <!-- Header with logos (left), centered title, and auth/admin (right) -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-3 gap-3 items-center">
      <!-- Left: Logos (50% larger) -->
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Marinas Guardian Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Deeptrek Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
      </div>

      <!-- Center: Title anchored -->
      <div class="text-center">
        <h1 class="text-lg sm:text-xl font-semibold">Project Guardian – WERP Reports</h1>
      </div>

      <!-- Right: Admin + user -->
      <div class="flex items-center justify-end gap-2">
        <a id="adminToolsBtn" href="/admin-tools.html" class="hidden bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-1.5 rounded" title="Open Admin Tools">Admin Tools</a>
        <span id="userName" class="hidden text-xs text-indigo-200"></span>
        <button id="signOutBtn" class="hidden bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1.5 rounded">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Signed-out auth -->
    <section id="signedOutContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 max-w-md mx-auto">
      <h2 class="text-xl font-semibold text-gray-800 mb-2 text-center">Welcome</h2>
      <p class="text-gray-600 mb-4 text-center">Sign in with your email and password to continue.</p>

      <div class="space-y-3">
        <label class="block">
          <span class="text-sm text-gray-700">Email</span>
          <input id="emailInput" type="email" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="you@example.com" autocomplete="email" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Password</span>
          <input id="passwordInput" type="password" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="••••••••" autocomplete="current-password" />
        </label>
        <p id="authMessage" class="text-sm h-5 text-center text-gray-500" aria-live="polite"></p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <button id="signInEmailBtn" class="flex-1 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Sign in</button>
          <button id="createAccountBtn" class="flex-1 px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Create account</button>
        </div>
        <button id="resetPasswordBtn" class="w-full text-sm text-indigo-700 hover:underline mt-1">Forgot password?</button>
      </div>
      <p class="text-xs text-gray-500 mt-6 text-center">
        New accounts start as read-only Users. Admin approval is required for Contributor access.
      </p>
    </section>

    <!-- App container -->
    <div id="appContainer" class="hidden space-y-6">
      <!-- Analyze single vessel -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-gray-800">Analyze New Vessel</h2>
            <span id="modelNote" class="note"></span>
          </div>
          <div class="flex items-center gap-2">
            <span id="roleBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-300">Role: —</span>
            <span id="contribHint" class="text-xs text-gray-500 hidden">Contributor access required</span>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <input type="text" id="vesselName" class="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., USS Chevalier" aria-label="Vessel name" />
          <button id="analyzeBtn" class="bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-800 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Run analysis (Contributors only)">
            <span id="analyzeText">Analyze Wreck</span>
          </button>
        </div>
        <p id="statusMessage" class="text-sm text-gray-500 mt-3 h-5" aria-live="polite"></p>
      </section>

      <!-- Filters -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="text-sm font-medium text-gray-800">Severity Filters</h3>
            <div class="flex items-center gap-4 mt-1 text-sm">
              <label class="flex items-center gap-2"><input id="sevHigh" type="checkbox" class="h-4 w-4" checked> High</label>
              <label class="flex items-center gap-2"><input id="sevMedium" type="checkbox" class="h-4 w-4" checked> Medium</label>
              <label class="flex items-center gap-2"><input id="sevLow" type="checkbox" class="h-4 w-4" checked> Low</label>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search vessel name..." class="w-64 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="clearSearch" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <div class="text-xs text-gray-600">Showing: <span id="visibleCounts">0</span></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Severity = (WCS + PHS + (ESI ÷ 3)) × RPM.</p>
        <div id="authError" class="text-red-700 text-xs mt-3 hidden"></div>
      </section>

      <!-- Map -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-3">
        <div id="map"></div>
      </section>

      <!-- Lists -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Initial -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Initial Assessments</h2>
            <span id="initialCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="initialWreckList" class="space-y-2"></div>
          <div id="noInitialWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No initial assessments match your filters.</div>
        </div>

        <!-- Completed -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Completed Assessments</h2>
            <span id="completedCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="completedWreckList" class="space-y-2"></div>
          <div id="noCompletedWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No completed assessments match your filters.</div>
        </div>

        <!-- Reassessment -->
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Requiring Reassessment</h2>
            <span id="reassessCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="reassessList" class="space-y-2"></div>
          <div id="noReassessMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No reassessments match your filters.</div>
        </div>
      </section>

      <!-- Full report panel -->
      <section id="reportContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 hidden">
        <h2 id="reportTitle" class="text-2xl font-bold mb-4 text-center text-gray-900"></h2>
        <div id="alert-display-section" class="hidden mb-4"></div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <div id="reportContent" class="prose lg:col-span-3 max-w-none"></div>
          <div class="lg:col-span-2">
            <h3 class="text-base font-bold mb-3 text-center text-gray-900">WERP Risk Profile</h3>
            <canvas id="werSpiderChart" aria-label="WERP risk profile radar chart"></canvas>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      serverTimestamp,
      collection,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
      authDomain: "project-guardian-agent.firebaseapp.com",
      projectId: "project-guardian-agent",
      storageBucket: "project-guardian-agent.firebasestorage.app",
      messagingSenderId: "84395007243",
      appId: "1:84395007243:web:b07e5f4c4264d27611160e",
      measurementId: "G-NRLH3WSCQ9"
    };

    const appId = 'guardian-agent-default';
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app, 'us-central1');

    const callGeminiFunction = httpsCallable(functions, 'callGeminiApi');
    const repairWerpsFn    = httpsCallable(functions, 'repairWerps');

    const assessmentsCollection = collection(db, `artifacts/${appId}/public/data/werpassessments`);

    // Mapbox
    const MAPBOX_TOKEN = "pk.eyJ1IjoidXNoMjE0IiwiYSI6ImNtZmNnZzV1YjFxMG0ybHM2MnI5aGN6bzIifQ.0FPMf68cgCHTCOsolzB1_w";

    // UI refs
    const ui = {
      // containers
      appContainer: document.getElementById('appContainer'),
      signedOutContainer: document.getElementById('signedOutContainer'),
      // header/auth
      adminToolsBtn: document.getElementById('adminToolsBtn'),
      userName: document.getElementById('userName'),
      signOutBtn: document.getElementById('signOutBtn'),
      // auth form
      emailInput: document.getElementById('emailInput'),
      passwordInput: document.getElementById('passwordInput'),
      signInEmailBtn: document.getElementById('signInEmailBtn'),
      createAccountBtn: document.getElementById('createAccountBtn'),
      resetPasswordBtn: document.getElementById('resetPasswordBtn'),
      authMessage: document.getElementById('authMessage'),
      // analyze
      modelNote: document.getElementById('modelNote'),
      vesselNameInput: document.getElementById('vesselName'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      analyzeText: document.getElementById('analyzeText'),
      statusMessage: document.getElementById('statusMessage'),
      roleBadge: document.getElementById('roleBadge'),
      contribHint: document.getElementById('contribHint'),
      // filters
      sevHigh: document.getElementById('sevHigh'),
      sevMedium: document.getElementById('sevMedium'),
      sevLow: document.getElementById('sevLow'),
      searchBox: document.getElementById('searchBox'),
      clearSearch: document.getElementById('clearSearch'),
      authError: document.getElementById('authError'),
      visibleCounts: document.getElementById('visibleCounts'),
      // map
      mapContainer: document.getElementById('map'),
      // lists
      initialList: document.getElementById('initialWreckList'),
      completedList: document.getElementById('completedWreckList'),
      reassessList: document.getElementById('reassessList'),
      initialCount: document.getElementById('initialCount'),
      completedCount: document.getElementById('completedCount'),
      reassessCount: document.getElementById('reassessCount'),
      noInitialMsg: document.getElementById('noInitialWrecksMessage'),
      noCompletedMsg: document.getElementById('noCompletedWrecksMessage'),
      noReassessMsg: document.getElementById('noReassessMessage'),
      // report
      reportContainer: document.getElementById('reportContainer'),
      reportTitle: document.getElementById('reportTitle'),
      reportContent: document.getElementById('reportContent'),
      alertDisplaySection: document.getElementById('alert-display-section'),
    };

    // Auth handlers
    function setAuthMessage(msg, isError = false) {
      ui.authMessage.textContent = msg || "";
      ui.authMessage.style.color = isError ? '#ef4444' : '#6b7280';
    }
    async function handleSignInEmailPassword() {
      const email = ui.emailInput.value.trim();
      const password = ui.passwordInput.value;
      if (!email || !password) return setAuthMessage("Enter email and password.", true);
      try {
        setAuthMessage("Signing in...");
        await signInWithEmailAndPassword(auth, email, password);
        setAuthMessage("");
      } catch (e) {
        setAuthMessage(cleanAuthError(e), true);
      }
    }
    async function handleCreateAccount() {
      const email = ui.emailInput.value.trim();
      const password = ui.passwordInput.value;
      if (!email || !password) return setAuthMessage("Enter email and a password.", true);
      if (password.length < 6) return setAuthMessage("Password must be at least 6 characters.", true);
      try {
        setAuthMessage("Creating account...");
        await createUserWithEmailAndPassword(auth, email, password);
        setAuthMessage("");
      } catch (e) {
        setAuthMessage(cleanAuthError(e), true);
      }
    }
    async function handlePasswordReset() {
      const email = ui.emailInput.value.trim();
      if (!email) return setAuthMessage("Enter your email to reset password.", true);
      try {
        setAuthMessage("Sending reset email...");
        await sendPasswordResetEmail(auth, email);
        setAuthMessage("Password reset email sent.");
      } catch (e) {
        setAuthMessage(cleanAuthError(e), true);
      }
    }
    function cleanAuthError(e) {
      const code = e?.code || "";
      switch (code) {
        case "auth/invalid-email": return "Invalid email address.";
        case "auth/user-disabled": return "This account is disabled.";
        case "auth/user-not-found": return "No account found with that email.";
        case "auth/wrong-password": return "Incorrect password.";
        case "auth/email-already-in-use": return "Email already in use.";
        case "auth/weak-password": return "Password must be at least 6 characters.";
        default: return e?.message || "Authentication error.";
      }
    }

    // Role/permissions
    let currentRole = 'user';
    let roleUnsub = null;
    function updateRoleUI() {
      const roleText = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
      ui.roleBadge.textContent = `Role: ${roleText}`;
      ui.roleBadge.className = "text-xs px-2 py-1 rounded-full border " +
        ((currentRole === 'contributor' || currentRole === 'admin')
          ? "bg-green-50 text-green-700 border-green-300"
          : "bg-gray-100 text-gray-700 border-gray-300");
      ui.contribHint.classList.toggle('hidden', (currentRole === 'contributor' || currentRole === 'admin'));
      ui.adminToolsBtn?.classList.toggle('hidden', currentRole !== 'admin');
    }
    function applyPermissions() {
      const canContribute = (currentRole === 'contributor' || currentRole === 'admin');
      ui.analyzeBtn.disabled = !canContribute || isLoading;
      updateRoleUI();
    }

    // Map and markers
    let map;
    let markers = new Map();

    function initMap(){
      if (map) return;
      map = L.map('map').setView([10, 150], 3);

      // Mapbox tiles
      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        id: 'mapbox/streets-v12',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: MAPBOX_TOKEN,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://www.mapbox.com/about/maps/">Mapbox</a>'
      }).addTo(map);
    }

    function markerIconFor(band){
      const color = band === "high" ? "red" : band === "medium" ? "orange" : "green";
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });
    }

    function upsertMarker(item){
      const coords = item?.phase1?.screening?.coordinates;
      const id = item?.id;
      if (!id || !coords?.latitude || !coords?.longitude) return;

      const band = item?.severity?.band || "low";
      const pos = [coords.latitude, coords.longitude];
      const title = escapeHtml(item?.vesselName || item?.id || "Unknown");
      const popupHtml = `<div><strong>${title}</strong><br/>Severity: ${(band||"").toUpperCase()} ${num(item?.severity?.value)}</div>`;

      if (markers.has(id)) {
        const m = markers.get(id);
        m.setLatLng(pos);
        m.setIcon(markerIconFor(band));
        m.setPopupContent(popupHtml);
      } else {
        const m = L.marker(pos, { icon: markerIconFor(band) }).addTo(map).bindPopup(popupHtml);
        markers.set(id, m);
      }
    }

    function clearMarkers(){
      for (const m of markers.values()){
        try { map.removeLayer(m); } catch {}
      }
      markers = new Map();
    }

    // Utilities
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function num(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return "—";
      return n % 1 === 0 ? n.toFixed(0) : n.toFixed(1);
    }
    function clamp(n, lo, hi){
      n = Number(n);
      if (!Number.isFinite(n)) n = lo;
      return Math.min(hi, Math.max(lo, n));
    }
    function computeSeverity(doc){
      const wcs = clamp(doc?.wcs?.totalScore, 0, 20);
      const phs = clamp(doc?.phs?.totalWeightedScore, 0, 10);
      const esi = clamp(doc?.esi?.totalScore, 0, 30);
      const rpm = clamp(doc?.rpm?.finalMultiplier, 0.5, 2.5);
      const composite = (wcs + phs + (esi / 3)) * rpm; // ~0..100
      let band = "low";
      if (composite >= 70) band = "high";
      else if (composite >= 40) band = "medium";
      return { value: Number(composite.toFixed(1)), band };
    }
    function phase2Status(doc){
      const s = doc?.phase2?.latest?.status || doc?.phase2?.status || "";
      return String(s || "").toLowerCase();
    }
    // Tightened reassessment logic: only explicit flag OR unacknowledged alerts
    function needsReassessment(doc){
      if (doc?.needsReassessment === true) return true;
      if (Array.isArray(doc?.alerts) && doc.alerts.some(a => !a?.acknowledged)) return true;
      return false;
    }
    function matchesFilters(item){
      const band = item?.severity?.band || "low";
      if (band === "high" && !ui.sevHigh.checked) return false;
      if (band === "medium" && !ui.sevMedium.checked) return false;
      if (band === "low" && !ui.sevLow.checked) return false;

      const q = (ui.searchBox?.value || "").trim().toLowerCase();
      if (q) {
        const name = String(item?.vesselName || item?.id || "").toLowerCase();
        if (!name.includes(q)) return false;
      }
      return true;
    }

    // Lists rendering
    function makeRow(item){
      const sevClass = item?.severity?.band || "low";
      const p2Updates = Array.isArray(item?.phase2?.updates) ? item.phase2.updates.length : 0;
      const latestAt = item?.updatedAt?._seconds ? new Date(item.updatedAt._seconds*1000).toISOString().slice(0,10) : "—";

      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'w-full text-left border border-gray-200 rounded-lg p-3 hover:bg-indigo-50/40 transition';
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h3 class="text-sm font-semibold">${escapeHtml(item.vesselName || item.id || "Unknown")}</h3>
              <span class="pill ${sevClass}">${(item?.severity?.band || "LOW").toUpperCase()} ${num(item?.severity?.value)}</span>
            </div>
            <div class="text-xs text-gray-700 mt-1 flex flex-wrap gap-3">
              <span>WCS ${num(item?.wcs?.totalScore)}/20</span>
              <span>PHS ${num(item?.phs?.totalWeightedScore)}/10</span>
              <span>ESI ${num(item?.esi?.totalScore)}/30</span>
              <span>RPM ×${num(item?.rpm?.finalMultiplier)}</span>
              <span>Phase 2: ${escapeHtml(phase2Status(item) || "none")}</span>
              <span>Updates: ${p2Updates}</span>
              <span>Last Updated: ${latestAt}</span>
            </div>
          </div>
        </div>
      `;
      el.addEventListener('click', () => {
        const coords = item?.phase1?.screening?.coordinates;
        const m = markers.get(item.id);
        if (map && coords?.latitude && coords?.longitude) {
          map.flyTo([coords.latitude, coords.longitude], 8);
          setTimeout(()=> m?.openPopup(), 300);
        }
        handleSelect(item.id);
      });
      return el;
    }

    function drawList(root, arr){
      root.innerHTML = '';
      for (const d of arr) root.appendChild(makeRow(d));
    }

    // State
    let allDocs = [];
    let isLoading = false;

    function setLoading(v, text = 'Analyzing...'){
      isLoading = v;
      const canContribute = (currentRole === 'contributor' || currentRole === 'admin');
      ui.analyzeBtn.disabled = v || !canContribute;
      ui.analyzeText.textContent = v ? text : 'Analyze Wreck';
    }
    function updateStatus(message, isError = false) {
      ui.statusMessage.textContent = message || '';
      ui.statusMessage.style.color = isError ? '#ef4444' : '#6b7280';
    }

    // Render pipeline
    function render() {
      // Filter + sort by severity
      const filtered = [];
      for (const d of allDocs){
        const item = { ...d, severity: computeSeverity(d) };
        if (!matchesFilters(item)) continue;
        filtered.push(item);
      }

      // Separate groups
      const initial = [];
      const completed = [];
      const reassess = [];

      for (const item of filtered){
        const st = phase2Status(item);
        const flag = needsReassessment(item);
        if (flag) {
          reassess.push(item);
        } else if (item?.status === 'completed' || st === 'completed') {
          completed.push(item);
        } else {
          initial.push(item);
        }
      }

      // Sort (high → low)
      const bySev = (a,b)=> (b?.severity?.value||0) - (a?.severity?.value||0);
      initial.sort(bySev);
      completed.sort(bySev);
      reassess.sort(bySev);

      // Lists
      drawList(ui.initialList, initial);
      drawList(ui.completedList, completed);
      drawList(ui.reassessList, reassess);

      ui.initialCount.textContent = `${initial.length} shown`;
      ui.completedCount.textContent = `${completed.length} shown`;
      ui.reassessCount.textContent = `${reassess.length} shown`;
      ui.visibleCounts.textContent = `${initial.length + completed.length + reassess.length} total`;

      ui.noInitialMsg.classList.toggle('hidden', initial.length > 0);
      ui.noCompletedMsg.classList.toggle('hidden', completed.length > 0);
      ui.noReassessMsg.classList.toggle('hidden', reassess.length > 0);

      // Map markers: rebuild from filtered set to reflect severity filters
      clearMarkers();
      for (const item of filtered) upsertMarker(item);
    }

    // Live data
    let unsub = null;
    async function startListener(){
      if (unsub) { unsub(); unsub = null; }
      try {
        const qy = query(assessmentsCollection, orderBy("vesselName"));
        unsub = onSnapshot(qy, (snap) => {
          allDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          render();
          setAuthError("");
        }, (err) => {
          console.error("Snapshot error:", err);
          if (String(err?.code||"").includes("permission-denied")) {
            setAuthError("Sign-in required to view reports.");
          } else {
            setAuthError(err?.message || "Failed to load reports.");
          }
          allDocs = [];
          render();
        });
      } catch (e) {
        console.error("Listener start failed:", e);
        if (String(e?.code||"").includes("permission-denied")) {
          setAuthError("Sign-in required to view reports.");
        } else {
          setAuthError(e?.message || "Failed to load reports.");
        }
      }
    }

    function setAuthError(msg){
      if (msg) {
        ui.authError.textContent = msg;
        ui.authError.classList.remove("hidden");
      } else {
        ui.authError.textContent = "";
        ui.authError.classList.add("hidden");
      }
    }

    // Analyze flow (contributors/admin only)
    async function callGemini(prompt) {
      const result = await callGeminiFunction({ prompt });
      const raw = result?.data;
      if (typeof raw !== "string") throw new Error("Model response not a string.");
      const cleaned = raw.trim().replace(/^```(?:json)?/i, "").replace(/```$/, "").trim();
      try {
        return JSON.parse(cleaned);
      } catch (e) {
        throw new Error("Model returned invalid JSON.");
      }
    }
    function buildUnifiedAssessmentPrompt(vesselName) {
      return `You are an expert OSINT analyst and marine environmental risk assessor.
Return ONLY JSON (no markdown):

{
  "wcs_hull_structure": {
    "parameters": [
      {"parameter":"Age","rationale":"...","score":0},
      {"parameter":"Construction Quality","rationale":"...","score":0},
      {"parameter":"Wreck Integrity","rationale":"...","score":0},
      {"parameter":"Corrosion Environment","rationale":"...","score":0}
    ],
    "maxScore": 20
  },
  "phs_pollution_hazard": {
    "parameters": [
      {"parameter":"Fuel Volume & Type","weight":0.40,"rationale":"...","score":0},
      {"parameter":"Ordnance","weight":0.25,"rationale":"...","score":0},
      {"parameter":"Vessel Integrity","weight":0.20,"rationale":"...","score":0},
      {"parameter":"Hazardous Materials","weight":0.15,"rationale":"...","score":0}
    ]
  },
  "esi_environmental_sensitivity": {
    "parameters": [
      {"parameter":"Proximity to Sensitive Ecosystems","rationale":"...","score":0},
      {"parameter":"Biodiversity Value","rationale":"...","score":0},
      {"parameter":"Socioeconomic Sensitivity","rationale":"...","score":0}
    ],
    "maxScore": 30
  },
  "rpm_risk_pressure_modifiers": {
    "factors": [
      {"factor":"Thermal Stress (Ocean Warming)","rationale":"...","value":1.0},
      {"factor":"Seismic Activity","rationale":"...","value":1.0},
      {"factor":"Anthropogenic Disturbance","rationale":"...","value":1.0}
    ]
  },
  "final_summary": {
    "summativeAssessment":"...",
    "remediationSuggestions":[
      {"priority":1,"title":"...","description":"..."},
      {"priority":2,"title":"...","description":"..."},
      {"priority":3,"title":"...","description":"..."}
    ]
  }
}

Rules:
- High score/value => higher risk.
- WCS 0–5 each (sum 0–20).
- PHS scores 0–10, weights: 0.40,0.25,0.20,0.15 => weighted sum 0–10.
- ESI scores 0–10 each (sum 0–30).
- RPM values 0.5–2.5 (1 baseline).
Vessel: ${vesselName}`;
    }
    function clampNum(v, min, max) {
      const n = typeof v === 'number' ? v : parseFloat(String(v));
      if (!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, n));
    }
    async function performNewAnalysis(vesselName) {
      updateStatus("Generating assessment...");
      const obj = await callGemini(buildUnifiedAssessmentPrompt(vesselName));

      const wcsParams = (obj.wcs_hull_structure?.parameters || []).map(p => ({
        name: p.parameter, rationale: p.rationale, score: clampNum(p.score, 0, 5)
      }));
      const wcsTotal = wcsParams.reduce((s, p) => s + p.score, 0);

      const phsParams = (obj.phs_pollution_hazard?.parameters || []).map(p => ({
        name: p.parameter, rationale: p.rationale, weight: p.weight, score: clampNum(p.score, 0, 10)
      }));
      const phsWeighted = phsParams.reduce((s, p) => s + (p.score * p.weight), 0);

      const esiParams = (obj.esi_environmental_sensitivity?.parameters || []).map(p => ({
        name: p.parameter, rationale: p.rationale, score: clampNum(p.score, 0, 10)
      }));
      const esiTotal = esiParams.reduce((s, p) => s + p.score, 0);

      const rpmFactors = (obj.rpm_risk_pressure_modifiers?.factors || []).map(f => ({
        name: f.factor, rationale: f.rationale, value: clampNum(f.value, 0.5, 2.5)
      }));
      const rpmAvg = rpmFactors.length ? rpmFactors.reduce((s, f) => s + f.value, 0) / rpmFactors.length : 1.0;

      return {
        vesselName,
        wcs: { parameters: wcsParams, totalScore: wcsTotal },
        phs: { parameters: phsParams, totalWeightedScore: clampNum(phsWeighted, 0, 10) },
        esi: { parameters: esiParams, totalScore: clampNum(esiTotal, 0, 30), maxScore: 30 },
        rpm: { factors: rpmFactors, finalMultiplier: parseFloat(rpmAvg.toFixed(2)) },
        finalSummary: { summativeAssessment: obj.final_summary?.summativeAssessment || "", remediationSuggestions: obj.final_summary?.remediationSuggestions || [] },
        status: "initial"
      };
    }

    // Full report rendering
    function createTable(rows, headers, keys, cellFormat = {}) {
      let table = '<table><thead><tr>';
      headers.forEach(h => table += `<th>${h}</th>`);
      table += '</tr></thead><tbody>';
      rows.forEach(row => {
        table += '<tr>';
        keys.forEach(k => {
          const val = row?.[k];
          const f = cellFormat[k];
          const out = f ? f(val, row) : (val ?? '');
          table += `<td>${out}</td>`;
        });
        table += '</tr>';
      });
      table += '</tbody></table>';
      return table;
    }

    function createOrUpdateSpiderChart({ wcs, phs, esi, esiMax, rpm }) {
      const ctx = document.getElementById('werSpiderChart').getContext('2d');

      const wcs20 = (wcs / 20) * 20;
      const phs20 = (phs / 10) * 20;
      const esi20 = (esi / (esiMax || 30)) * 20;
      // RPM 0.5..2.5 => 0..20
      const rpm20 = ((Math.min(Math.max(rpm, 0.5), 2.5) - 0.5) / 2.0) * 20;

      const profile = [wcs20, phs20, esi20, rpm20].map(v => Math.max(0, Math.min(20, v)));

      const lowCap = [6, 6, 6, 6];
      const medCap = [12, 12, 12, 12];
      const highCap = [20, 20, 20, 20];

      if (window.spiderChart) {
        window.spiderChart.data.datasets[0].data = lowCap;
        window.spiderChart.data.datasets[1].data = medCap;
        window.spiderChart.data.datasets[2].data = highCap;
        window.spiderChart.data.datasets[3].data = profile;
        window.spiderChart.update();
        return;
      }

      window.spiderChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['WCS', 'PHS', 'ESI', 'RPM'],
          datasets: [
            { label: 'Low benchmark', data: lowCap, backgroundColor: 'rgba(16,185,129,0.18)', borderColor: 'rgba(16,185,129,0.45)', pointRadius: 0, order: 1 },
            { label: 'Medium benchmark', data: medCap, backgroundColor: 'rgba(245,158,11,0.14)', borderColor: 'rgba(245,158,11,0.45)', pointRadius: 0, fill: '-1', order: 2 },
            { label: 'High benchmark', data: highCap, backgroundColor: 'rgba(239,68,68,0.12)', borderColor: 'rgba(239,68,68,0.45)', pointRadius: 0, fill: '-1', order: 3 },
            { label: 'Risk Profile', data: profile, backgroundColor: 'rgba(30,64,175,0.22)', borderColor: 'rgba(30,64,175,1)', pointBackgroundColor: 'rgba(30,64,175,1)', order: 4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { r: { suggestedMin: 0, suggestedMax: 20, ticks: { stepSize: 4 } } } }
      });
    }

    async function handleSelect(docId) {
      try {
        ui.reportContainer.classList.add('hidden');
        ui.reportContent.innerHTML = '';
        ui.reportTitle.textContent = '';
        const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;

        const data = docSnap.data();
        ui.reportTitle.textContent = `WERP Assessment: ${data.vesselName}`;

        if (Array.isArray(data.alerts) && data.alerts.some(a => !a.acknowledged)) {
          ui.alertDisplaySection.classList.remove('hidden');
          ui.alertDisplaySection.innerHTML = `
            <div class="p-3 mb-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-md">
              <h3 class="font-bold text-yellow-800">Recent Environmental Incident</h3>
              <p class="text-sm text-yellow-700 mt-1">A recent event was detected near this wreck. Re-assessment recommended.</p>
            </div>`;
        } else {
          ui.alertDisplaySection.classList.add('hidden');
          ui.alertDisplaySection.innerHTML = '';
        }

        const wcsTotal = Number(data?.wcs?.totalScore ?? 0);
        const phsTotal = Number(data?.phs?.totalWeightedScore ?? 0);
        const esiTotal = Number(data?.esi?.totalScore ?? 0);
        const esiMax  = Number(data?.esi?.maxScore ?? (esiTotal <= 30 ? 30 : 40));
        const rpmMult = Number(data?.rpm?.finalMultiplier ?? 1.0);

        ui.reportContent.innerHTML = `
          <section>
            <h3>Case Study Background</h3>
            <p>${data?.phase1?.summary?.background ?? '—'}</p>
            <p><strong>Location:</strong> ${data?.phase1?.summary?.location ?? '—'}</p>
            <p><strong>Discovery:</strong> ${data?.phase1?.summary?.discovery ?? '—'}</p>
          </section>

          <section>
            <h3>Phase 1: Scoping & Screening</h3>
            <ul class="list-disc ml-5 space-y-1">
              <li><strong>Vessel Type:</strong> ${data?.phase1?.screening?.vesselType ?? '—'}</li>
              <li><strong>Tonnage:</strong> ${data?.phase1?.screening?.tonnage ?? '—'}</li>
              <li><strong>Year Built:</strong> ${data?.phase1?.screening?.yearBuilt ?? '—'}</li>
              <li><strong>Last Owner:</strong> ${data?.phase1?.screening?.lastOwner ?? '—'}</li>
              <li><strong>Coordinates:</strong> ${data?.phase1?.screening?.coordinates?.latitude ?? '—'}, ${data?.phase1?.screening?.coordinates?.longitude ?? '—'}</li>
            </ul>
          </section>

          <section>
            <h3>Phase 3: WCS (Hull & Structure)</h3>
            ${createTable(
              data?.wcs?.parameters ?? [],
              ['Parameter', 'Rationale', 'Score (0–5)'],
              ['name', 'rationale', 'score']
            )}
            <p class="mt-2"><strong>Total:</strong> ${Number.isFinite(wcsTotal) ? wcsTotal : '—'} / 20</p>
          </section>

          <section>
            <h3>Phase 3: PHS (Pollution Hazard)</h3>
            <p class="note mb-2">Weights: Fuel 0.40, Ordnance 0.25, Vessel Integrity 0.20, Hazardous Materials 0.15.</p>
            ${createTable(
              (data?.phs?.parameters ?? []).map(p => ({ ...p })),
              ['Parameter', 'Weight', 'Rationale', 'Score (0–10)'],
              ['name', 'weight', 'rationale', 'score']
            )}
            <p class="mt-2"><strong>Total Weighted Score:</strong> ${Number.isFinite(phsTotal) ? phsTotal.toFixed(2) : '—'} / 10</p>
          </section>

          <section>
            <h3>Phase 3: ESI (Environmental Sensitivity)</h3>
            ${createTable(
              data?.esi?.parameters ?? [],
              ['Parameter', 'Rationale', 'Score (0–10)'],
              ['name', 'rationale', 'score']
            )}
            <p class="mt-2"><strong>Total:</strong> ${Number.isFinite(esiTotal) ? esiTotal : '—'} / ${esiMax}</p>
          </section>

          <section>
            <h3>Phase 3: RPM (Risk Pressure Modifiers)</h3>
            ${createTable(
              (data?.rpm?.factors ?? []).map(f => ({
                ...f,
                rationale: (typeof f?.rationale === 'string' && f.rationale.trim()) ? f.rationale : 'Not specified.'
              })),
              ['Factor', 'Rationale', 'Value (0.5–2.5)'],
              ['name', 'rationale', 'value']
            )}
            <p class="mt-2"><strong>Final Multiplier:</strong> ${Number.isFinite(rpmMult) ? rpmMult.toFixed(2) : '—'}× <span class="note">(1.00 baseline)</span></p>
          </section>

          <section>
            <h3>${data?.status === 'completed' ? 'Final' : 'Preliminary'} Risk Synthesis & Classification</h3>
            ${data?.status === 'completed'
              ? ''
              : `<p class="italic text-gray-600">Preliminary scores; Phase 2 field verification may adjust risk classification.</p>`}
          </section>

          <section>
            <h3>Summative Assessment</h3>
            <p>${data?.finalSummary?.summativeAssessment ?? '—'}</p>
          </section>

          <section>
            <h3>Remediation Suggestions</h3>
            ${(data?.finalSummary?.remediationSuggestions ?? []).map(s => `
              <div class="mt-3">
                <h4 class="font-semibold">Priority ${s?.priority ?? ''}: ${s?.title ?? ''}</h4>
                <p>${s?.description ?? ''}</p>
              </div>
            `).join('')}
          </section>
        `;

        createOrUpdateSpiderChart({
          wcs: Number(wcsTotal || 0),
          phs: Number(phsTotal || 0),
          esi: Number(esiTotal || 0),
          esiMax: Number(esiMax || 30),
          rpm: Number(rpmMult || 1.0)
        });

        ui.reportContainer.classList.remove('hidden');
        ui.reportContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        console.error('Failed to render report:', e);
      }
    }

    // Analyze events
    ui.analyzeBtn.addEventListener('click', runFullAnalysis);
    ui.vesselNameInput.addEventListener('keypress', (e) => (e.key === 'Enter') && runFullAnalysis());
    let isRateLimited = false;
    function requireContributor(actionName = "this action") {
      const ok = (currentRole === 'contributor' || currentRole === 'admin');
      if (!ok) updateStatus(`Contributor access required to ${actionName}.`, true);
      return ok;
    }
    function setRateLimit() {
      isRateLimited = true;
      setTimeout(() => { isRateLimited = false; updateStatus(""); }, 30000);
    }
    async function runFullAnalysis() {
      if (!requireContributor("run analyses")) return;
      if (isRateLimited) { updateStatus("Please wait before next analysis.", true); return; }
      const vesselName = ui.vesselNameInput.value.trim();
      if (!vesselName) { updateStatus("Please enter a vessel name.", true); return; }

      setLoading(true);
      try {
        const docId = vesselName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          updateStatus(`Report for ${vesselName} already exists. Opening...`);
          handleSelect(docId);
        } else {
          const newReportData = await performNewAnalysis(vesselName);
          await setDoc(docRef, { ...newReportData, createdAt: serverTimestamp() });
          updateStatus(`Analysis complete for ${vesselName}.`);
          handleSelect(docId);
        }
        setRateLimit();
      } catch (error) {
        updateStatus(`Error: ${error.message}`, true);
      } finally {
        setLoading(false);
      }
    }

    // Filters
    [ui.sevHigh, ui.sevMedium, ui.sevLow].forEach(cb => cb?.addEventListener("change", render));
    ui.searchBox?.addEventListener("input", render);
    ui.clearSearch?.addEventListener("click", () => { if (ui.searchBox) ui.searchBox.value = ""; render(); });

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        ui.appContainer.classList.add('hidden');
        ui.signedOutContainer.classList.remove('hidden');
        ui.userName.classList.add('hidden');
        ui.signOutBtn.classList.add('hidden');
        ui.adminToolsBtn?.classList.add('hidden');
        if (roleUnsub) { roleUnsub(); roleUnsub = null; }
        currentRole = 'user';
        applyPermissions();
        return startListener(); // attempt (will show permission hint if denied)
      }

      // Signed-in UI
      ui.signedOutContainer.classList.add('hidden');
      ui.appContainer.classList.remove('hidden');
      ui.userName.classList.remove('hidden');
      ui.userName.textContent = user.email || "Signed in";
      ui.signOutBtn.classList.remove('hidden');

      // Role subscribe
      if (roleUnsub) { roleUnsub(); roleUnsub = null; }
      const roleDocRef = doc(db, 'system', 'allowlist', 'users', user.uid);
      roleUnsub = onSnapshot(roleDocRef, (snap) => {
        const role = (snap.exists() && typeof snap.data().Role === 'string') ? snap.data().Role : 'user';
        currentRole = ['user', 'contributor', 'admin'].includes(role) ? role : 'user';
        applyPermissions();
      }, () => {
        currentRole = 'user';
        applyPermissions();
      });

      startListener();
    });

    // Sign-out
    ui.signOutBtn?.addEventListener('click', () => signOut(auth));
    ui.signInEmailBtn?.addEventListener('click', handleSignInEmailPassword);
    ui.createAccountBtn?.addEventListener('click', handleCreateAccount);
    ui.resetPasswordBtn?.addEventListener('click', handlePasswordReset);

    // Init
    initMap();
    ui.modelNote.textContent = "Schema v2: WCS(0–20) PHS(4 weighted; 0–10) ESI(0–30) RPM(0.5–2.5). High = higher risk.";
    startListener();
  </script>
</body>
</html>