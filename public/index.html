<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <title>Project Guardian: WW2 Wreck Analysis and Monitoring Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind via CDN (CSP allows cdn.tailwindcss.com) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            'soft': '0 2px 10px rgba(0,0,0,0.25)',
            'card': '0 8px 24px rgba(0,0,0,0.35)'
          }
        }
      }
    }
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <style>
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 6px; }
    ::-webkit-scrollbar-thumb:hover { background: #334155; }
    .fade-enter { opacity:0; transform:translateY(4px); }
    .fade-enter-active { transition:all .28s; opacity:1; transform:translateY(0); }
    .note-block { border:1px solid rgba(255,255,255,0.08); background:#0f172a; }
    .admin-btn { opacity:.85; } .admin-btn:hover { opacity:1; }
    @media print {
      .page-break { page-break-before: always; }
      .no-print { display:none!important; }
      body { background:#ffffff!important; }
    }
    .radar-wrapper { height: 260px; position: relative; }
    @media (max-width: 640px){ .radar-wrapper { height: 220px; } }
    .leaflet-container { background:#0f172a; }
    .card-surface { background: rgba(15,23,42,0.70); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; }
    .card-inner { background: rgba(30,41,59,0.50); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; }
    table.report { width:100%; border-collapse: collapse; }
    table.report th, table.report td { border:1px solid rgba(255,255,255,0.08); padding:6px 8px; vertical-align: top; }
    table.report th { background: rgba(255,255,255,0.04); font-weight:600; }
  </style>
</head>
<body class="min-h-screen bg-[#050816] text-slate-100">
<header class="sticky top-0 z-50 backdrop-blur bg-[#050816]/90 border-b border-white/10 no-print">
  <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-4">
    <a href="#/" class="text-xl md:text-2xl font-semibold tracking-tight text-cyan-200 hover:text-cyan-300 transition">
      Project Guardian: WW2 Wreck Analysis and Monitoring Platform
    </a>
    <nav class="ml-auto flex items-center gap-2 md:gap-3">
      <a id="nav-home" href="#/" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10">Home</a>
      <a id="nav-list" href="#/list" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10">All Wrecks</a>
      <a id="nav-current-report" href="#/" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10 hidden">Current Report</a>
      <a id="nav-import" href="import.html" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-emerald-600/80 hover:bg-emerald-500 text-white border border-white/10 hidden" title="Open Import Dashboard">Import</a>
      <a id="nav-approvals" href="approvals.html"
         class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10 hidden"
         title="Approve registrations">Approvals</a>
      <button id="btn-task-dashboard" type="button" title="Open Task Dashboard" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-emerald-600/80 hover:bg-emerald-500 text-white border border-white/10">
        Task Dashboard
      </button>
    </nav>
    <div class="hidden md:flex items-center gap-4">
      <img id="header-logo-left" src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true"
           alt="Logo Left" style="height:70px" class="w-auto rounded shadow-soft border border-white/10">
      <img id="header-logo-right" src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true"
           alt="Logo Right" style="height:70px" class="w-auto rounded shadow-soft border border-white/10">
    </div>
  </div>
</header>

<main id="app" class="max-w-7xl mx-auto px-4 py-6 md:py-10"></main>
<div id="toast-stack" class="fixed top-4 right-4 z-[60] space-y-2"></div>

<!-- Shared modules -->
<script type="module" src="./auth-role.js"></script>

<!-- Main App Script -->
<script type="module">
import {
  onAuthChanged, onRoleResolved, isAdmin, isContributor,
  signInEmailPassword, createAccountEmailPassword, resetPassword, signOutUser,
  db as sharedDb, functions as sharedFunctions
} from "./auth-role.js";

import {
  collection, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
import { httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

/* Constants */
const appId = "guardian";
window.appId = appId;

const READ_COLLECTIONS = [
  "artifacts/guardian/public/data/werpassessments",
  "artifacts/guardian-agent-default/public/data/werpassessments"
];
const DEFAULT_WRITE_COLLECTION = "artifacts/guardian-agent-default/public/data/werpassessments";

/* Utilities */
const $ = s => document.querySelector(s);
const getText = v => v==null ? "" : String(v).trim();
const escapeHtml = s => String(s||"").replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const debounce = (fn,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

function showToast(msg,type='info'){
  const stack=$('#toast-stack'); if(!stack)return;
  const color=type==='success'?'bg-emerald-600':type==='error'?'bg-rose-600':'bg-slate-700';
  const div=document.createElement('div');
  div.className=`${color} text-white px-4 py-2 rounded-lg shadow-soft border border-white/10 transition fade-enter`;
  div.textContent=msg;
  stack.appendChild(div);
  requestAnimationFrame(()=>div.classList.add('fade-enter-active'));
  setTimeout(()=>{ div.classList.add('opacity-0','-translate-y-1'); setTimeout(()=>div.remove(),240); },3000);
}

const PLACEHOLDER_SVG="data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="240"><rect width="100%" height="100%" fill="#1e293b"/><text x="50%" y="50%" text-anchor="middle" fill="#94a3b8" font-size="14" font-family="Arial">No image</text></svg>');
const WEB_IMG_EXT_RX = /\.(png|jpe?g|webp|gif|bmp|tiff?|svg)(?:\?|#|$)/i;
function isHttpUrl(u) {
  if (typeof u !== "string") return false;
  const s = u.trim();
  if (!s || s.startsWith("data:") || s.startsWith("blob:")) return false;
  return /^https?:\/\//i.test(s);
}
function looksLikeImageUrl(u) { return isHttpUrl(u) && WEB_IMG_EXT_RX.test(u); }
function dedupe(arr) {
  const seen=new Set(), out=[];
  for(const v of arr){ const k=String(v||""); if(!k||seen.has(k)) continue; seen.add(k); out.push(v); }
  return out;
}

/* Image helpers (cached asset first, fallback external) */
function getExternalImageUrls(item) {
  const urls = [];
  const arr = Array.isArray(item?.media?.images) ? item.media.images : [];
  for (const it of arr) {
    if (!it) continue;
    if (typeof it === "string" && looksLikeImageUrl(it)) urls.push(it);
    else if (typeof it === "object") {
      const cands = [it.url, it.href, it.src, it.imageUrl, it.thumbnail, it.thumb, it.picture, it.pic];
      for (const c of cands) if (c && looksLikeImageUrl(String(c))) urls.push(String(c));
      if (it.link && typeof it.link === "object") {
        const c2 = [it.link.url, it.link.href, it.link.src];
        for (const c of c2) if (c && looksLikeImageUrl(String(c))) urls.push(String(c));
      }
    }
  }
  const altArrays = [
    item?.media?.photos, item?.media?.gallery,
    item?.images, item?.photos, item?.gallery,
    item?.referenceMedia
  ].filter(Array.isArray);
  for (const arr2 of altArrays) {
    for (const it of arr2) {
      if (!it) continue;
      if (typeof it === "string" && looksLikeImageUrl(it)) urls.push(it);
      else if (typeof it === "object") {
        const cands = [it.url, it.href, it.src, it.imageUrl, it.thumbnail, it.thumb, it.picture, it.pic];
        for (const c of cands) if (c && looksLikeImageUrl(String(c))) urls.push(String(c));
        if (it.link && typeof it.link === "object") {
          const c2 = [it.link.url, it.link.href, it.link.src];
          for (const c of c2) if (c && looksLikeImageUrl(String(c))) urls.push(String(c));
        }
      }
    }
  }
  return dedupe(urls);
}
function getMarkerImageUrl(item) {
  const webExt = /\.(png|jpe?g|webp|gif)$/i;
  const assets = Array.isArray(item?.phase2?.assets) ? item.phase2.assets : [];
  const img = assets.find(a => a?.url && webExt.test(String(a?.name || a?.path || "")));
  if (img?.url) return img.url;
  const extUrls = getExternalImageUrls(item);
  return extUrls[0] || null;
}

/* Vessel helpers */
function vesselName(it){ return getText(it?.name || it?.title || it?.vesselName || it?.metadata?.vesselName || it?.id || "Unknown"); }
function vesselNationality(it){
  const cands = [
    it?.nationality, it?.flag, it?.country, it?.flagState, it?.flag_state,
    it?.metadata?.nationality, it?.metadata?.flag, it?.metadata?.country, it?.metadata?.flagState,
    it?.meta?.nationality, it?.meta?.flag, it?.meta?.country, it?.meta?.flagState,
    it?.historical?.nationality, it?.historical?.flag, it?.historical?.country, it?.historical?.vesselNationality, it?.historical?.vesselFlag,
    it?.vessel?.nationality, it?.vessel?.flag, it?.vessel?.country
  ];
  for (const v of cands) { const t = getText(v); if (t) return t; }
  return "";
}
function vesselSummary(it){
  return getText(it?.historical?.circumstancesOfLoss) ||
         getText(it?.historical?.summary) ||
         getText(it?.phase2?.summary) ||
         "No summary available.";
}

/* Coordinates helper */
function resolveCoordinates(item){
  const toNum=v=>{ const n=Number(v); return Number.isFinite(n)?n:null; };
  function extract(obj){
    if(!obj)return null;
    if(Array.isArray(obj)&&obj.length>=2){
      const lng=toNum(obj[0]); const lat=toNum(obj[1]);
      if(lat!=null && lng!=null) return {lat,lng};
      return null;
    }
    if(obj.coordinates){ const nested=extract(obj.coordinates); if(nested) return nested; }
    const lat=toNum(obj.latitude ?? obj.lat ?? obj.y);
    const lng=toNum(obj.longitude ?? obj.lng ?? obj.lon ?? obj.x);
    if(lat!=null && lng!=null) return {lat,lng};
    if(obj.latlng){ const ll=extract(obj.latlng); if(ll) return ll; }
    return null;
  }
  const cands=[
    item?.phase1?.screening?.coordinates,
    item?.coordinates, item?.location?.coordinates,
    item?.historical?.location?.coordinates,
    item?.location, item?.geo, item?.position,
    item?.geometry?.coordinates, item?.geometry
  ];
  for(const c of cands){ const got=extract(c); if(got) return got; }
  return null;
}

/* Scoring helpers for full report */
const deepGet=(o,p)=>p.split(".").reduce((a,k)=>a&&a[k]!=null?a[k]:undefined,o);
const isFiniteNum = (n) => typeof n === "number" && Number.isFinite(n);
function readNumberByPaths(obj, paths) {
  for (const p of paths) {
    const v = deepGet(obj, p);
    if (v == null) continue;
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string") {
      const m = v.match(/-?\d+(\.\d+)?/);
      if (m) { const n = Number(m[0]); if (Number.isFinite(n)) return n; }
    }
  }
  return null;
}
function hasUnifiedV2(item) {
  return Array.isArray(item?.wcs?.parameters)
      && Array.isArray(item?.phs?.parameters)
      && Array.isArray(item?.esi?.parameters)
      && (Array.isArray(item?.rpm?.factors) || Array.isArray(item?.rpm?.parameters) || isFiniteNum(item?.rpm?.finalMultiplier));
}
function resolveRPMMultiplier(item) {
  const toNum = (v)=>{ const n=Number(v); return Number.isFinite(n)?n:null; };
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const explicit = toNum(deepGet(item, "rpm.finalMultiplier")) ?? toNum(deepGet(item, "RPM.finalMultiplier"));
  if (Number.isFinite(explicit)) return clamp(explicit, 0.5, 2.5);
  const factors = deepGet(item, "rpm.factors") || deepGet(item, "RPM.factors") || deepGet(item, "rpm.parameters");
  if (Array.isArray(factors) && factors.length) {
    let base = 1.0;
    for (const f of factors) {
      const name = String(f?.name ?? f?.factor ?? "").toLowerCase();
      let v = toNum(f?.value); if (!Number.isFinite(v)) continue;
      if (name.includes("chemical")) v = Math.min(v, 1.2);
      else if (name.includes("thermal") || name.includes("warming") || name.includes("temperature")) v = Math.min(v, 1.4);
      else if (name.includes("physical") || name.includes("seismic") || name.includes("storm") || name.includes("current")) v = Math.min(v, 1.4);
      else v = Math.min(v, 1.4);
      base += Math.max(v - 1.0, 0);
    }
    return clamp(base, 0.5, 2.5);
  }
  const generic = toNum(deepGet(item, "rpm")) ?? toNum(deepGet(item, "RPM")) ?? toNum(deepGet(item, "scores.RPM"));
  if (Number.isFinite(generic)) return clamp(generic, 0.5, 2.5);
  return 1.0;
}
function normalizeWcsParameters(rawParams = []) {
  const params = (Array.isArray(rawParams) ? rawParams : [])
    .map(p => ({ name: String(p?.name ?? p?.parameter ?? "").trim(), rationale: String(p?.rationale ?? "").trim(), score: Number(p?.score) }))
    .filter(p => (p.name || p.rationale) && Number.isFinite(p.score));
  const rawScores = params.map(p => p.score);
  const maxScore = rawScores.length ? Math.max(...rawScores) : 0;
  const scale = maxScore > 5 && maxScore <= 10 ? 10 : 5;
  const scaleNote = maxScore > 5;
  const rx = {
    age: [/\bage\b/i, /\byear/i, /\bbuilt\b/i, /\blaunched\b/i, /\bcommission/i, /\bdecommission/i, /since\s*sink/i, /\bsubmerged\b/i],
    vessel: [/\bvessel\b/i, /\bship\b/i, /\bclass\b/i, /\btype\b/i, /\bsize\b/i, /\btonnage\b/i, /\bgrt\b/i, /\bdisplacement\b/i],
    trauma: [/\btorpedo/i, /\bdepth\s*charge/i, /\bmine\b/i, /\bbomb/i, /\bexplosion/i, /\bdetonat/i, /\bshell/i, /\bgunfire\b/i, /\bcollision\b/i, /\bgrounding\b/i],
    integrity: [/\bstructur/i, /\bintegrit/i, /\bintact\b/i, /\bcollaps/i, /\bfragment/i, /\bbroken\b/i, /\bruptur/i, /\bhull\b/i]
  };
  function matchScore(p, patterns) {
    const name = p.name || "", rat = p.rationale || ""; let s = 0;
    for (const re of (Array.isArray(patterns) ? patterns : [patterns])) { if (re.test(name)) s += 3; if (re.test(rat)) s += 1; }
    return s;
  }
  function best(patterns) { let best = null; for (const p of params) { const s = matchScore(p, patterns); if (s > 0 && (!best || s > best.s)) best = { p, s }; } return best?.p; }
  const picks = { age: best(rx.age), vessel: best(rx.vessel), trauma: best(rx.trauma), integrity: best(rx.integrity) };
  const norm = (v) => !Number.isFinite(v) ? 0 : scale === 10 ? Math.max(0, Math.min(5, v/2)) : Math.max(0, Math.min(5, v));
  let traumaNormalized, traumaRationale = "Not provided.";
  if (picks.trauma) { traumaNormalized = norm(picks.trauma.score); traumaRationale = picks.trauma.rationale || "Not provided."; }
  else if (picks.integrity) {
    const rat = picks.integrity.rationale || "", name = picks.integrity.name || "";
    const looks = rx.trauma.some(re => re.test(rat) || re.test(name));
    traumaNormalized = looks ? 5 : 0; traumaRationale = looks ? (rat || "Derived from integrity rationale.") : "Not provided.";
  } else traumaNormalized = 0;
  const rows = [
    { title: "Age", rationale: picks.age?.rationale || "Not provided.", normalized: norm(picks.age?.score ?? 0) },
    { title: "Vessel Type/Size", rationale: picks.vessel?.rationale || "Not provided.", normalized: norm(picks.vessel?.score ?? 0) },
    { title: "Sinking Trauma", rationale: traumaRationale, normalized: norm(picks.trauma?.score ?? 0) },
    { title: "Current Structural Integrity", rationale: picks.integrity?.rationale || "Not provided.", normalized: norm(picks.integrity?.score ?? 0) }
  ];
  const total = rows.reduce((s, r) => s + (Number(r.normalized) || 0), 0);
  return { rows, total: Number(total.toFixed(2)), scaleNote };
}
function normalizePhsWeights(params = []) {
  function parseScore(v) {
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string") {
      const m = v.match(/-?\d+(\.\d+)?/);
      if (m) return Number(m[0]);
    }
    if (v != null) {
      const n = Number(v);
      if (Number.isFinite(n)) return n;
    }
    return NaN;
  }
  function parseWeightFrom(obj) {
    const keys = ["weight","Weight","w","W","weightPct","weight_percent","weightPercent","percentage","percent","Percent","Percentage","Weight (%)","Weight %","Weight(%)"];
    for (const k of keys) {
      if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
        const raw = obj[k];
        if (typeof raw === "number" && Number.isFinite(raw)) return { value: raw, hadPercent: raw > 1.5 || raw > 100 };
        if (typeof raw === "string") {
          const t = raw.trim(); const hadPercent = /%/.test(t);
          const num = parseFloat(t.replace("%","")); if (Number.isFinite(num)) return { value: num, hadPercent };
        }
      }
    }
    return { value: NaN, hadPercent: false };
  }
  const items = (Array.isArray(params) ? params : [])
    .map((p) => {
      const name = String(p?.name ?? p?.parameter ?? p?.title ?? "").trim();
      const rationale = String(p?.rationale ?? p?.notes ?? p?.note ?? "").trim();
      const scoreRaw = parseScore(p?.score ?? p?.value ?? p?.points);
      const { value: weightRaw, hadPercent } = parseWeightFrom(p || {});
      return { name, rationale, scoreRaw, weightRaw, hadPercent };
    })
    .filter((i) => i.name && Number.isFinite(i.scoreRaw));
  if (!items.length) return { rows: [], totalWeighted: 0, asPercent: false, renormalized: false };
  const clampScore = (v) => Math.max(0, Math.min(10, Number(v) || 0));
  let anyWeights=false, anyPercentHint=false;
  const weights = items.map(i=>{
    const w=Number(i.weightRaw);
    if (Number.isFinite(w) && w>0){ anyWeights=true; if (i.hadPercent) anyPercentHint = true; return w; }
    return NaN;
  });
  let weightFracs, asPercent=false, renormalized=false;
  if (!anyWeights) {
    const frac=1/items.length; weightFracs=items.map(()=>frac);
  } else {
    const finite = weights.map(w=>Number.isFinite(w)?w:0);
    const sumW = finite.reduce((a,b)=>a+b,0);
    if (anyPercentHint || (sumW > 85 && sumW < 115)) {
      asPercent = true; weightFracs = finite.map(w=>w/100);
    } else { weightFracs = finite.slice(); }
    let fracSum = weightFracs.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0);
    if (!Number.isFinite(fracSum) || fracSum<=0) { const f=1/items.length; weightFracs=items.map(()=>f); }
    else if (Math.abs(fracSum-1)>0.01){ weightFracs=weightFracs.map(w=>Number.isFinite(w)?w/fracSum:0); renormalized=true; }
  }
  const rows = items.map((i,idx)=>{
    const weightFrac = weightFracs[idx] || 0;
    const weightPct = weightFrac * 100;
    const score = clampScore(i.scoreRaw);
    const weighted = score * weightFrac;
    return { name:i.name, rationale:i.rationale, weightFrac, weightPct, score, weighted };
  });
  const totalWeighted = rows.reduce((s,r)=>s+r.weighted,0);
  return { rows, totalWeighted: Number(totalWeighted.toFixed(2)), asPercent, renormalized };
}
function v2Totals(item) {
  const wNorm = normalizeWcsParameters(item?.wcs?.parameters || []);
  const wcs = wNorm.total;
  const p = normalizePhsWeights(item?.phs?.parameters || []);
  const phs = Math.max(0, Math.min(10, p.totalWeighted));
  const eParams = Array.isArray(item?.esi?.parameters) ? item.esi.parameters : [];
  const esi = eParams.reduce((s, par) => s + Math.max(0, Math.min(10, Number(par?.score) || 0)), 0);
  const esiMax = Number(item?.esi?.maxScore) || (eParams.length ? eParams.length * 10 : 30);
  const rpm = resolveRPMMultiplier(item);
  return { wcs, phs, esi, esiMax, rpm, wcsRows: wNorm.rows, phsRows: p.rows, phsRenormalized: p.renormalized, wcsScaleNote: wNorm.scaleNote };
}
function computeFormulaSeverity(item) {
  if (hasUnifiedV2(item)) { const v = v2Totals(item); return (v.wcs + v.phs + (v.esi / 3)) * v.rpm; }
  const W = readNumberByPaths(item, ["scores.WCS","wcs","WCS","phase1.screening.WCS","phase2.scores.WCS"]) ?? 0;
  const P = readNumberByPaths(item, ["scores.PHS","phs","PHS","phase1.screening.PHS","phase2.scores.PHS"]) ?? 0;
  const E = readNumberByPaths(item, ["scores.ESI","esi","ESI","phase1.screening.ESI","phase2.scores.ESI"]) ?? 0;
  const R = resolveRPMMultiplier(item);
  return (W + P + (E / 3)) * R;
}

/* Severity categorization used by map/list */
const ACTION_THRESHOLDS = { critical: 60, high: 45, medium: 30 };
function computeSeverityTotal({ wcs, phs, esi, rpm }) { return (wcs + phs + (esi / 3)) * rpm; }
function categorizeSeverity(score) {
  if (score > ACTION_THRESHOLDS.critical) return "critical";
  if (score >= ACTION_THRESHOLDS.high) return "high";
  if (score >= ACTION_THRESHOLDS.medium) return "medium";
  return "low";
}
function rpmFinalMultiplier(it){
  const m=Number(it?.rpm?.finalMultiplier ?? it?.rpm?.multiplier);
  return Number.isFinite(m)?m:1;
}
function severityCategoryForItem(it){
  if (hasUnifiedV2(it)) {
    const v=v2Totals(it); return categorizeSeverity(computeSeverityTotal(v));
  }
  const wcs = Number(it?.totals?.wcs||0);
  const phs = Number(it?.totals?.phs||0);
  const esi = Number(it?.totals?.esi||0);
  const rpm = rpmFinalMultiplier(it);
  return categorizeSeverity(computeSeverityTotal({wcs, phs, esi, rpm}));
}

/* Radar */
let radarChart=null;
function renderRadar(canvas, item){
  if(!canvas) return;
  if (radarChart) try{ radarChart.destroy(); }catch{}
  let w, p, e, rpm;
  if (hasUnifiedV2(item)) { const v=v2Totals(item); w=v.wcs; p=v.phs; e=v.esi; rpm=v.rpm; }
  else { w=Number(item?.totals?.wcs||0); p=Number(item?.totals?.phs||0); e=Number(item?.totals?.esi||0); rpm=rpmFinalMultiplier(item); }
  // Scale to 0–20 radial scale for visual parity
  const to20 = (val,max)=> Math.max(0, Math.min(20, max ? (val/max)*20 : val));
  const w20 = Math.max(0, Math.min(20, w)); // assume WCS already on 0–20
  const p20 = to20(p,10);
  const esiMax = hasUnifiedV2(item) ? (v2Totals(item).esiMax || 30) : 30;
  const e20 = to20(e,esiMax);
  const r20 = Math.max(0, Math.min(20, ((Math.min(Math.max(rpm,0.5),2.5) - 0.5)/2.0)*20));
  radarChart = new Chart(canvas.getContext('2d'), {
    type:'radar',
    data:{
      labels:['WCS','PHS','ESI','RPM'],
      datasets:[
        { label:'Profile', data:[w20,p20,e20,r20], backgroundColor:'rgba(30,64,175,0.22)', borderColor:'rgba(30,64,175,1)', pointBackgroundColor:'rgba(30,64,175,1)' }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ r:{ suggestedMin:0, suggestedMax:20, ticks:{ stepSize:4 }, grid:{ color:'rgba(148,163,184,0.2)' }, angleLines:{ color:'rgba(148,163,184,0.25)' } } },
      plugins:{ legend:{ display:false } }
    }
  });
}

/* Map */
let leafletMap=null;
const markers = new Map();
function setMapStatus(status, detail=""){
  const badge = document.getElementById('map-status-badge');
  if(!badge) return;
  badge.textContent = detail ? `${status} • ${detail}` : status;
  badge.style.color = status==='error' ? '#fecaca' : '#e2e8f0';
}
function markerIconFor(category){
  const color =
    category==='critical' ? '#ef4444':
    category==='high' ? '#f59e0b':
    category==='medium' ? '#facc15':'#10b981';
  return L.divIcon({
    className:'custom-marker',
    html:`<div style="width:16px;height:16px;border:2px solid #fff;border-radius:50%;background:${color};box-shadow:0 0 0 2px rgba(0,0,0,0.25);"></div>`,
    iconSize:[16,16],
    iconAnchor:[8,8]
  });
}
function refreshLeafletMarkers(){
  if(!leafletMap || typeof L==='undefined') return;
  for(const m of markers.values()){ try{ leafletMap.removeLayer(m);}catch{} }
  markers.clear();
  const sFilter=state.filters.severity;
  const stageFilter=state.filters.stage;
  const term=(state.filters.search || '').toString().toLowerCase();
  const filtered=state.wrecks.filter(it=>{
    const cat=severityCategoryForItem(it);
    if(sFilter!=='all' && cat!==sFilter) return false;
    const st = it?.stage || 'initial';
    if(stageFilter!=='all' && st!==stageFilter) return false;
    if(term && !vesselName(it).toLowerCase().includes(term)) return false;
    return resolveCoordinates(it)!=null;
  });
  filtered.forEach(it=>{
    const coord=resolveCoordinates(it); if(!coord) return;
    const cat=severityCategoryForItem(it);
    const marker=L.marker([coord.lat, coord.lng],{ icon: markerIconFor(cat) });
    const nat = vesselNationality(it);
    const natLine = nat ? `<div style="font-size:11px;color:#64748b;margin:2px 0;">Nationality: ${escapeHtml(nat)}</div>` : "";
    const thumb = getMarkerImageUrl(it) || PLACEHOLDER_SVG;
    marker.bindPopup(`
      <div style="min-width:220px">
        <div style="font-weight:600">${escapeHtml(vesselName(it))}</div>
        <div style="font-size:11px;color:#64748b;margin:2px 0 4px;">Stage: ${escapeHtml(it?.stage||'initial')} • ${cat.toUpperCase()}</div>
        ${natLine}
        <img src="${thumb}" referrerpolicy="no-referrer" onerror="this.src='${PLACEHOLDER_SVG}'"
             style="width:100%;max-height:120px;object-fit:cover;border:1px solid #334155;border-radius:6px;margin:6px 0 6px"/>
        <a href="#/wreck/${encodeURIComponent(it.id)}" style="font-size:12px;color:#0ea5e9;text-decoration:underline;">Open Report</a>
      </div>`);
    marker.addTo(leafletMap);
    markers.set(it.id, marker);
  });
}
function initLeaflet(){
  const container=$('#leaflet-map');
  if(!container) return;
  if(leafletMap){
    setTimeout(()=>leafletMap.invalidateSize(),50);
    return;
  }
  try{
    leafletMap = L.map(container,{ zoomControl:true }).setView([10,150],3);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:"© OpenStreetMap contributors",
      maxZoom:18
    }).addTo(leafletMap);
    leafletMap.on('load',()=>setMapStatus('ready'));
    refreshLeafletMarkers();
    setMapStatus('ready');
    setTimeout(()=>leafletMap.invalidateSize(),60);
  }catch(e){
    console.error(e);
    setMapStatus('error','init-failed');
  }
}
function ensureMapSize(){ if(leafletMap) leafletMap.invalidateSize(); }
window.addEventListener('resize', debounce(ensureMapSize,200));

/* App State */
const state = {
  wrecks: [],
  byIdPath: new Map(),
  currentWreck: null,
  currentRoute: null,
  role: 'user',
  user: null,
  listeners: [],
  filters: { severity:'all', stage:'all', search:'' }
};
window.pgState = state;

/* Firestore listeners + forced refresh */
function detachListeners(){ for(const u of state.listeners){ try{u();}catch{} } state.listeners=[]; }
function startData(){
  detachListeners();
  const accumulator=new Map();
  const applySnap=(snap,path)=>{
    let changed=false;
    snap.forEach(docSnap=>{
      const raw=docSnap.data()||{};
      const rec={...raw, id: raw.id || docSnap.id, _path:path};
      accumulator.set(`${path}::${rec.id}`, rec);
      state.byIdPath.set(rec.id, path);
      changed=true;
    });
    if(changed){
      state.wrecks = Array.from(accumulator.values());
      if(state.currentRoute?.name === 'home'){
        refreshLeafletMarkers();
        renderReassessList();
      } else {
        if(state.currentRoute?.name==='report'){
          const r = state.wrecks.find(w=>String(w.id)===String(state.currentRoute.id));
          state.currentWreck = r || null;
        }
        renderApp();
      }
    }
  };
  for(const p of READ_COLLECTIONS){
    try{
      const un=onSnapshot(collection(sharedDb,p),(snap)=>applySnap(snap,p),
        e=>console.error("Listener error",p,e));
      state.listeners.push(un);
    }catch(e){ console.error("Failed to listen",p,e); }
  }
}
async function forceFetchLatest() {
  try {
    const accumulator = new Map();
    for (const p of READ_COLLECTIONS) {
      const snap = await getDocs(collection(sharedDb, p));
      snap.forEach(docSnap => {
        const raw = docSnap.data() || {};
        const rec = { ...raw, id: raw.id || docSnap.id, _path: p };
        accumulator.set(`${p}::${rec.id}`, rec);
        state.byIdPath.set(rec.id, p);
      });
    }
    state.wrecks = Array.from(accumulator.values());
    refreshLeafletMarkers();
    renderReassessList();
  } catch (e) {
    console.warn('[forceFetchLatest] failed', e);
  }
}

/* Auto-refresh when returning to Home or tab gets focus */
window.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible' && state.currentRoute?.name === 'home') {
    forceFetchLatest();
  }
});

/* UI builders */
function buildAuthPanel(){
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden">
    <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-cyan-200">Authentication</h2>
      <button id="toggle-auth" class="text-sm text-cyan-300 hover:text-cyan-200 transition">Toggle</button>
    </div>
    <div id="auth-body" class="p-4 grid md:grid-cols-2 gap-6">
      <form id="auth-form" data-auth-hidden>
        <label class="block text-sm mb-1">Email</label>
        <input id="login-email" type="email" autocomplete="username" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600" />
        <label class="block text-sm mt-3 mb-1">Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600" />
        <div class="flex gap-2 mt-4 flex-wrap">
          <button type="button" id="btn-signin" class="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm">Sign In</button>
          <button type="button" id="btn-create" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Create Account</button>
          <button type="button" id="btn-reset" class="px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm">Reset Password</button>
        </div>
        <div id="auth-msg" class="text-xs text-slate-400 mt-2 h-5"></div>
      </form>
      <div data-auth-visible class="hidden space-y-3">
        <div class="text-sm">
          <div><span class="font-medium text-slate-300">Signed in as:</span> <span id="auth-email" class="text-cyan-300"></span></div>
          <div><span class="font-medium text-slate-300">Role:</span> <span id="auth-role" class="text-cyan-300"></span></div>
        </div>
        <button id="btn-signout" class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 text-white text-sm">Sign Out</button>
      </div>
    </div>
  </div>`;
}
function buildAnalyzePanel(){
  const c=isContributor();
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden mt-6">
    <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-cyan-200">Assessment Actions</h2>
      <span class="text-xs text-slate-400">Role: ${state.role}</span>
    </div>
    <div class="p-4 space-y-4">
      <form id="analyze-form" class="flex flex-col md:flex-row gap-3">
        <input id="analysis-input" type="text" placeholder="Vessel name..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600" />
        <div class="flex gap-2">
          <button id="btn-analyze" type="submit" class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm ${!c?'opacity-50 cursor-not-allowed':''}">Analyze</button>
          <button id="btn-reassess" type="button" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm ${!c?'opacity-50 cursor-not-allowed':''}">Reassess</button>
        </div>
      </form>
      <div id="analyze-status" class="text-xs text-slate-400 h-5"></div>
    </div>
  </div>`;
}
function buildMapCard(){
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden mt-6" id="map-card">
    <div class="p-4 md:p-5 border-b border-white/10 flex flex-col xl:flex-row gap-4 xl:items-center">
      <div class="flex flex-wrap items-center gap-1 text-sm">
        <span class="mr-2 font-medium text-slate-200">Risk:</span>
        ${['all','critical','high','medium','low'].map(r=>`<button data-filter-sev="${r}" class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">${r[0].toUpperCase()+r.slice(1)}</button>`).join('')}
      </div>
      <div class="flex flex-wrap items-center gap-1 text-sm">
        <span class="mr-2 font-medium text-slate-200">Stage:</span>
        ${['all','initial','completed','reassess'].map(r=>`<button data-filter-stage="${r}" class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">${r[0].toUpperCase()+r.slice(1)}</button>`).join('')}
      </div>
      <div class="xl:ml-auto w-full xl:w-72">
        <input id="map-search" type="text" placeholder="Search..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-600" />
      </div>
    </div>
    <div class="relative">
      <div id="leaflet-map" class="w-full h-[550px] bg-slate-800">
        <div id="map-status-badge">init</div>
      </div>
    </div>
    <div class="p-4 border-t border-white/10">
      <h3 class="text-base font-semibold text-cyan-200">Flagged for Reassessment</h3>
      <div id="reassess-list" class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  </div>`;
}

/* Auth UI */
function updateAuthUI(){
  const signedIn=!!state.user;
  document.querySelectorAll('[data-auth-visible]').forEach(el=>el.classList.toggle('hidden', !signedIn));
  document.querySelectorAll('[data-auth-hidden]').forEach(el=>el.classList.toggle('hidden', signedIn));

  const contributor = isContributor();
  const importLink = document.getElementById('nav-import');
  if (importLink) importLink.classList.toggle('hidden', !contributor);

  const approvalsLink = document.getElementById('nav-approvals');
  if (approvalsLink) approvalsLink.classList.toggle('hidden', !isAdmin());

  const taskBtn = document.getElementById('btn-task-dashboard');
  if (taskBtn) taskBtn.classList.toggle('hidden', !isAdmin());

  $('#auth-email') && ($('#auth-email').textContent = state.user?.email || '');
  $('#auth-role') && ($('#auth-role').textContent = state.role);
}

/* Reassess list */
function renderReassessList(){
  const wrap=$('#reassess-list'); if(!wrap) return;
  wrap.innerHTML='';
  const list=state.wrecks.filter(w=>
    w?.needsReassessment===true ||
    w?.seismicEvent===true ||
    (w?.events && (
      w.events.seismic != null ||
      (Array.isArray(w.events) && w.events.some(e=>/seismic|storm|cyclone|earthquake/i.test(e?.type||"")))
    ))
  );
  if(!list.length){
    wrap.innerHTML='<div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-slate-300">None currently.</div>';
  } else {
    list.forEach(it=>{
      const cat = severityCategoryForItem(it);
      const color = cat==='critical'?'bg-rose-500/20 text-rose-200 border-rose-400/30':
                    cat==='high'?'bg-orange-500/20 text-orange-200 border-orange-400/30':
                    cat==='medium'?'bg-amber-400/20 text-amber-200 border-amber-300/30':
                    'bg-emerald-400/20 text-emerald-200 border-emerald-300/30';
      const a=document.createElement('a');
      a.href=`#/wreck/${encodeURIComponent(it.id)}`;
      a.className='block rounded-lg bg-slate-800/60 border border-white/10 hover:bg-slate-800 transition p-3 space-y-2';
      a.innerHTML=`
        <div class="flex items-center justify-between gap-3">
          <div class="font-medium truncate">${escapeHtml(vesselName(it))}</div>
          <span class="px-2 py-0.5 text-xs rounded-md border ${color}">${cat.toUpperCase()}</span>
        </div>
        <div class="text-xs text-slate-400 line-clamp-2">${escapeHtml(vesselSummary(it))}</div>`;
      wrap.appendChild(a);
    });
  }
}

/* Report rendering (FULL BREAKDOWN) */
function buildFactorSummaryTable(item) {
  let rows = [];
  if (hasUnifiedV2(item)) {
    const v = v2Totals(item);
    rows.push(`<tr><th>WCS</th><td>${v.wcs.toFixed(2)}</td><td>0–20</td></tr>`);
    rows.push(`<tr><th>PHS</th><td>${v.phs.toFixed(2)}</td><td>0–10</td></tr>`);
    rows.push(`<tr><th>ESI</th><td>${v.esi.toFixed(2)}</td><td>0–${v.esiMax}</td></tr>`);
    rows.push(`<tr><th>RPM</th><td>${v.rpm.toFixed(2)}×</td><td>multiplier</td></tr>`);
  } else {
    const W = Number(item?.totals?.wcs||0);
    const P = Number(item?.totals?.phs||0);
    const E = Number(item?.totals?.esi||0);
    const R = rpmFinalMultiplier(item);
    rows.push(`<tr><th>WCS</th><td>${W.toFixed(2)}</td><td>0–20</td></tr>`);
    rows.push(`<tr><th>PHS</th><td>${P.toFixed(2)}</td><td>0–10</td></tr>`);
    rows.push(`<tr><th>ESI</th><td>${E.toFixed(2)}</td><td>0–30/40</td></tr>`);
    rows.push(`<tr><th>RPM</th><td>${R.toFixed(2)}×</td><td>multiplier</td></tr>`);
  }
  return `<table class="report"><thead><tr><th>Factor</th><th>Score</th><th>Scale</th></tr></thead><tbody>${rows.join("")}</tbody></table>`;
}

function renderReport(route){
  const app=$('#app');
  const it=state.wrecks.find(w=>String(w.id)===String(route.id));
  state.currentWreck=it||null;
  if(!it){
    app.innerHTML='<div class="text-slate-300">Wreck not found. <a href="#/" class="text-cyan-400 underline">Back</a></div>';
    return;
  }

  // Image gallery
  const assets = Array.isArray(it?.phase2?.assets) ? it.phase2.assets : [];
  const webExt = /\.(png|jpe?g|gif|webp)$/i;
  let urls = assets.filter(a => a?.url && webExt.test(String(a?.name || a?.path || ""))).map(a => a.url);
  if (!urls.length) urls = getExternalImageUrls(it);
  const gallery = urls.length
    ? `<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">${urls.slice(0,9).map(u=>`<img src="${u}" referrerpolicy="no-referrer" onerror="this.src='${PLACEHOLDER_SVG}'" class="w-full h-32 md:h-40 object-cover rounded border border-white/10" />`).join('')}</div>`
    : `<div class="text-xs text-slate-400">No images available.</div>`;

  // Analysis sections
  let wcsHtml="", phsHtml="", esiHtml="", rpmHtml="", radarCanvasId="werSpiderChart";

  if (hasUnifiedV2(it)) {
    const v=v2Totals(it);
    wcsHtml = `
      <section class="space-y-2">
        <h3 class="text-lg font-semibold text-cyan-200">Phase 3: WCS (Hull & Structure)</h3>
        <table class="report">
          <thead><tr><th>Parameter</th><th>Rationale</th><th>Score (0–5)</th></tr></thead>
          <tbody>${v.wcsRows.map(r=>`<tr><td>${escapeHtml(r.title)}</td><td>${escapeHtml(r.rationale)}</td><td>${(Number(r.normalized)||0).toFixed(2)}</td></tr>`).join("")}</tbody>
        </table>
        <p class="mt-1 text-sm"><strong>Total:</strong> ${v.wcs.toFixed(2)} / 20</p>
        ${v.wcsScaleNote ? '<p class="text-xs text-slate-400">Note: WCS values appeared on 0–10; normalized to 0–5.</p>' : ''}
      </section>`;
    phsHtml = `
      <section class="space-y-2">
        <h3 class="text-lg font-semibold text-cyan-200">Phase 3: PHS (Pollution Hazard)</h3>
        <p class="text-xs text-slate-400">Weights normalized to sum to 100%. Weighted = Score × Weight.</p>
        <table class="report">
          <thead><tr><th>Parameter</th><th>Rationale</th><th>Weight (%)</th><th>Score (0–10)</th><th>Weighted</th></tr></thead>
          <tbody>${v.phsRows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.rationale)}</td><td>${r.weightPct.toFixed(0)}%</td><td>${r.score.toFixed(2)}</td><td>${r.weighted.toFixed(2)}</td></tr>`).join("")}</tbody>
        </table>
        <p class="mt-1 text-sm"><strong>Total Weighted (PHS):</strong> ${v.phs.toFixed(2)} / 10</p>
        ${v.phsRenormalized ? '<p class="text-xs text-slate-400">Note: input weights normalized.</p>' : ''}
      </section>`;
    const eParams = Array.isArray(it?.esi?.parameters) ? it.esi.parameters : [];
    esiHtml = `
      <section class="space-y-2">
        <h3 class="text-lg font-semibold text-cyan-200">Phase 3: ESI (Environmental Sensitivity)</h3>
        <table class="report">
          <thead><tr><th>Parameter</th><th>Rationale</th><th>Score (0–10)</th></tr></thead>
          <tbody>${eParams.map(p=>`<tr><td>${escapeHtml(p?.name ?? p?.parameter ?? "")}</td><td>${escapeHtml(p?.rationale ?? "")}</td><td>${escapeHtml(String(p?.score ?? ""))}</td></tr>`).join("")}</tbody>
        </table>
        <p class="mt-1 text-sm"><strong>Total:</strong> ${v.esi.toFixed(2)} / ${v.esiMax}</p>
      </section>`;
    const rpmList = Array.isArray(it?.rpm?.parameters) ? it.rpm.parameters : Array.isArray(it?.rpm?.factors) ? it.rpm.factors : [];
    rpmHtml = `
      <section class="space-y-2">
        <h3 class="text-lg font-semibold text-cyan-200">Phase 3: RPM (Release Probability Modifier)</h3>
        ${Array.isArray(rpmList)&&rpmList.length ? `
        <table class="report">
          <thead><tr><th>Factor</th><th>Rationale</th><th>Value</th></tr></thead>
          <tbody>${rpmList.map(f=>`<tr><td>${escapeHtml(f?.name ?? f?.factor ?? "")}</td><td>${escapeHtml(f?.rationale ?? "Not specified.")}</td><td>${escapeHtml(String(f?.value ?? ""))}</td></tr>`).join("")}</tbody>
        </table>` : '<p class="text-sm text-slate-300">No factor breakdown provided. Using final multiplier if supplied.</p>'}
        <p class="mt-1 text-sm"><strong>Final Multiplier:</strong> ${(Number(it?.rpm?.finalMultiplier)||1).toFixed(2)}× <span class="text-xs text-slate-400">(1.00 baseline)</span></p>
      </section>`;
  } else {
    // Legacy/flat totals present only
    const W = Number(it?.totals?.wcs||0);
    const P = Number(it?.totals?.phs||0);
    const E = Number(it?.totals?.esi||0);
    const R = rpmFinalMultiplier(it);
    wcsHtml = `<section class="space-y-2"><h3 class="text-lg font-semibold text-cyan-200">WCS</h3><p class="text-sm">Score: ${W.toFixed(2)} / 20</p></section>`;
    phsHtml = `<section class="space-y-2"><h3 class="text-lg font-semibold text-cyan-200">PHS</h3><p class="text-sm">Score: ${P.toFixed(2)} / 10</p></section>`;
    esiHtml = `<section class="space-y-2"><h3 class="text-lg font-semibold text-cyan-200">ESI</h3><p class="text-sm">Score: ${E.toFixed(2)} / 30–40</p></section>`;
    rpmHtml = `<section class="space-y-2"><h3 class="text-lg font-semibold text-cyan-200">RPM</h3><p class="text-sm">Multiplier: ${R.toFixed(2)}×</p></section>`;
  }

  const nat = vesselNationality(it);
  const natBadge = nat ? `<span class="ml-2 px-2 py-0.5 text-xs rounded-md bg-white/5 border border-white/10">${escapeHtml(nat)}</span>` : '';

  app.innerHTML=`
    <div class="flex flex-wrap items-center gap-3 mb-5">
      <a href="#/" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">← Home</a>
      <a href="#/list" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">All Wrecks</a>
      <span class="ml-auto text-xs px-2 py-1 rounded-md bg-slate-800 border border-white/10 text-slate-300">Role: ${state.role}</span>
    </div>

    <section class="card-surface p-5 space-y-5">
      <h1 class="text-2xl font-semibold text-cyan-200 flex items-center">${escapeHtml(vesselName(it))} ${natBadge}</h1>
      <p class="text-sm text-slate-300">${escapeHtml(vesselSummary(it))}</p>

      <!-- Factor summary + Radar -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <h3 class="text-lg font-semibold text-cyan-200 mb-2">Factor Scores Summary</h3>
          ${buildFactorSummaryTable(it)}
        </div>
        <div>
          <h3 class="text-lg font-semibold text-cyan-200 mb-2">Risk Profile</h3>
          <div class="radar-wrapper"><canvas id="${radarCanvasId}"></canvas></div>
        </div>
      </div>

      <!-- Detailed sections -->
      ${wcsHtml}
      ${phsHtml}
      ${esiHtml}
      ${rpmHtml}

      <div>
        <h3 class="text-sm font-semibold text-slate-200">Images</h3>
        ${gallery}
      </div>
    </section>`;

  // Render radar
  renderRadar(document.getElementById(radarCanvasId), it);
}

function renderHome(){
  const app=$('#app');
  const existingMap = $('#map-card');
  if(!existingMap){
    app.innerHTML = buildAuthPanel() + buildAnalyzePanel() + buildMapCard();
  } else {
    app.innerHTML = buildAuthPanel() + buildAnalyzePanel();
    app.appendChild(existingMap);
    setTimeout(()=>ensureMapSize(),30);
  }

  $('#toggle-auth')?.addEventListener('click',()=>$('#auth-body')?.classList.toggle('hidden'));

  $('#btn-signin')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim(); const pass=$('#login-pass').value;
    $('#auth-msg').textContent='Signing in...';
    try{ await signInEmailPassword(email,pass); $('#auth-msg').textContent='Signed in.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-create')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim(); const pass=$('#login-pass').value;
    $('#auth-msg').textContent='Creating...';
    try{ await createAccountEmailPassword(email,pass); $('#auth-msg').textContent='Account created.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-reset')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim();
    if(!email){ $('#auth-msg').textContent='Enter email first.'; return; }
    try{ await resetPassword(email); $('#auth-msg').textContent='Reset email sent.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-signout')?.addEventListener('click', async ()=>{ try{ await signOutUser(); }catch{} });

  const taskBtn = document.getElementById('btn-task-dashboard');
  if (taskBtn && !taskBtn.dataset.bound) {
    taskBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ showToast("Admin only","error"); return; }
      window.open('tasks-dashboard.html','_blank','noopener');
    });
    taskBtn.dataset.bound = '1';
  }

  $('#analyze-form')?.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!isContributor()){ showToast("Insufficient role","error"); return; }
    const name=getText($('#analysis-input').value);
    if(!name){ showToast("Enter vessel name","error"); return; }
    $('#analyze-status').textContent='Requesting analysis...';
    try{
      if(!callable.analyzeWerps) throw new Error("Function not deployed");
      await callable.analyzeWerps({ vesselName:name, appId, targetPath: DEFAULT_WRITE_COLLECTION, source:"web-ui" });
      $('#analysis-input').value="";
      $('#analyze-status').textContent='Analysis requested.';
      showToast("Analysis requested","success");
    }catch(e){
      $('#analyze-status').textContent='Error: '+(e?.message||'failed');
      showToast("Analysis failed","error");
    }
  });
  $('#btn-reassess')?.addEventListener('click', async ()=>{
    if(!isContributor()){ showToast("Insufficient role","error"); return; }
    const name=getText($('#analysis-input').value);
    if(!name){ showToast("Enter vessel name","error"); return; }
    $('#analyze-status').textContent='Requesting reassessment...';
    try{
      if(!callable.reassessWerps) throw new Error("Function not deployed");
      await callable.reassessWerps({ vesselName:name, appId, targetPath: DEFAULT_WRITE_COLLECTION, source:"web-ui" });
      $('#analysis-input').value="";
      $('#analyze-status').textContent='Reassessment requested.';
      showToast("Reassessment requested","success");
    }catch(e){
      $('#analyze-status').textContent='Error: '+(e?.message||'failed');
      showToast("Reassessment failed","error");
    }
  });

  document.querySelectorAll('[data-filter-sev]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      state.filters.severity = btn.getAttribute('data-filter-sev');
      refreshLeafletMarkers();
    });
  });
  document.querySelectorAll('[data-filter-stage]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      state.filters.stage = btn.getAttribute('data-filter-stage');
      refreshLeafletMarkers();
    });
  });
  $('#map-search')?.addEventListener('input', debounce(e=>{
    state.filters.search = (e?.target?.value ?? '').toString();
    refreshLeafletMarkers();
  },250));

  // Init + fresh data
  initLeaflet();
  startData();
  forceFetchLatest();
  refreshLeafletMarkers();
  renderReassessList();
  updateAuthUI();
}

function renderList(){
  const app=$('#app');
  const term=(state.filters.search || '').toString().toLowerCase();
  const items=state.wrecks.filter(it=>vesselName(it).toLowerCase().includes(term));
  app.innerHTML=`
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <a href="#/" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">← Home</a>
      <span class="ml-auto text-xs px-2 py-1 rounded-md bg-slate-800 border border-white/10 text-slate-300">Role: ${state.role}</span>
    </div>
    <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden">
      <div class="p-4 border-b border-white/10 flex flex-col md:flex-row md:items-center gap-3">
        <div class="text-lg font-semibold text-cyan-200">All Wrecks</div>
        <div class="md:ml-auto w-full md:w-80">
          <input id="list-search" type="text" placeholder="Search..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600" />
        </div>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${items.map(it=>{
          const cat=severityCategoryForItem(it);
          const color = cat==='critical'?'bg-rose-500/20 text-rose-200 border-rose-400/30':
                        cat==='high'?'bg-orange-500/20 text-orange-200 border-orange-400/30':
                        cat==='medium'?'bg-amber-400/20 text-amber-200 border-amber-300/30':
                        'bg-emerald-400/20 text-emerald-200 border-emerald-300/30';
          const thumb = getMarkerImageUrl(it) || PLACEHOLDER_SVG;
          return `
            <a href="#/wreck/${encodeURIComponent(it.id)}" class="block rounded-xl bg-slate-800/60 border border-white/10 hover:bg-slate-800 transition overflow-hidden">
              <div class="w-full h-40 bg-slate-700 border-b border-white/10">
                <img src="${thumb}" referrerpolicy="no-referrer" onerror="this.src='${PLACEHOLDER_SVG}'" class="w-full h-40 object-cover"/>
              </div>
              <div class="p-3">
                <div class="flex items-center justify-between gap-3">
                  <h3 class="font-medium truncate">${escapeHtml(vesselName(it))}</h3>
                  <span class="px-2 py-0.5 rounded-md text-xs border ${color}">${cat.toUpperCase()}</span>
                </div>
                <p class="text-xs text-slate-400 mt-1 line-clamp-2">${escapeHtml(vesselSummary(it))}</p>
              </div>
            </a>`;
        }).join('') || `<div class="text-slate-400 text-sm">No wrecks loaded.</div>`}
      </div>
    </div>`;
  $('#list-search')?.addEventListener('input', e=>{
    state.filters.search=(e?.target?.value ?? '').toString();
    renderList();
  });
  updateAuthUI();
}

/* Router */
const routes={ home:/^#\/?$/, report:/^#\/wreck\/([^/]+)$/, list:/^#\/list\/?$/ };
function parseRoute(){
  const h=location.hash||'#/';
  if(routes.home.test(h)) return { name:'home' };
  const m=h.match(routes.report); if(m) return { name:'report', id:decodeURIComponent(m[1]) };
  if(routes.list.test(h)) return { name:'list' };
  return { name:'home' };
}
function setActiveNav(route){
  const map={ home:'#nav-home', list:'#nav-list', report:'#nav-current-report' };
  document.querySelectorAll('nav a').forEach(a=>{
    a.classList.remove('ring-2','ring-cyan-500');
    a.removeAttribute('aria-current');
  });
  const sel=map[route.name];
  if(sel){
    const el=document.querySelector(sel);
    if(el){
      el.classList.add('ring-2','ring-cyan-500');
      el.setAttribute('aria-current','page');
    }
  }
  if(route.name==='report' && state.currentWreck){
    const cr=$('#nav-current-report');
    cr?.classList.remove('hidden');
    cr.href=`#/wreck/${encodeURIComponent(state.currentWreck.id)}`;
  }
}

/* Init + route */
function renderApp(){
  const route=parseRoute();
  state.currentRoute=route;
  setActiveNav(route);
  if(route.name==='home') renderHome();
  else if(route.name==='report') renderReport(route);
  else if(route.name==='list') renderList();
  else renderHome();

  if(route.name==='home'){
    // ensure freshest markers on return
    forceFetchLatest();
  }
}

window.addEventListener('hashchange',()=>renderApp());

/* Auth events */
onAuthChanged(user=>{
  state.user = user;
  updateAuthUI();
  if(!user){
    state.role='user';
    detachListeners();
  }
});
onRoleResolved(({ role })=>{
  state.role = role;
  updateAuthUI();
  startData();
  renderApp();
});

renderApp();
console.info('[PG] App initialized');
</script>

<!-- NOTE: Do not include tasks-dashboard.js here to avoid duplicate bindings.
     tasks-dashboard.html should include its own script. -->
</body>
</html>