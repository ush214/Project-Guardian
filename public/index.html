<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Guardian: AI Wreck Assessment Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Chart.js for Spider Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --header-bg: #002D62; /* Dark Blue from PDF */
            --main-bg: #f0f2f5; /* Light Grey */
            --card-bg: #ffffff;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --accent-blue: #00509e;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); }
        .spinner { border-top-color: var(--accent-blue); }
        #map { height: 500px; z-index: 10; border-radius: 0.5rem; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 10px !important; }
        .prose h3 { font-size: 1.25em; margin-top: 1.5em; margin-bottom: 0.75em; font-weight: 700; color: var(--header-bg); border-bottom: 2px solid var(--accent-blue); padding-bottom: 0.25em;}
        .prose h4 { font-size: 1.1em; margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; color: var(--text-dark); }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; font-size: 0.9em; }
        .prose th { background-color: #f8fafc; font-weight: 600; }
        .wreck-list-item { cursor: pointer; border-left: 4px solid transparent; display: flex; justify-content: space-between; align-items: center; }
        .wreck-list-item.active, .wreck-list-item:hover { border-left-color: var(--accent-blue); background-color: #eef2ff; }
        .alert-icon { color: #ef4444; font-size: 1.2em; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-gray-800">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Marinas Guardian Logo" class="h-16">
                <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Deeptrek Logo" class="h-16">
            </div>
            <h1 class="hidden md:block text-2xl font-bold text-gray-700">Project Guardian AI Wreck Assessment Agent</h1>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 max-w-2xl mx-auto">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Analyze New Vessel</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="vesselName" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., IJN Kirishima">
                <button id="analyzeBtn" class="bg-blue-800 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-900 transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <div id="spinner" class="spinner animate-spin rounded-full h-5 w-5 border-2 border-white border-t-blue-800 mr-2 hidden"></div>
                    <span id="analyzeText">Analyze Wreck</span>
                </button>
            </div>
             <p id="statusMessage" class="text-sm text-gray-500 mt-4 text-center h-4"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div id="mapContainer" class="lg:col-span-3 bg-white rounded-lg shadow-lg p-4">
                <div id="map"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Initial Assessments -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-xl font-semibold mb-4 text-gray-700">Initial Assessments</h2>
                <div id="initialWreckListContainer" class="h-96 overflow-y-auto">
                    <ul id="initialWreckList" class="space-y-2"></ul>
                    <p id="noInitialWrecksMessage" class="text-gray-500 text-center hidden">No initial assessments found.</p>
                </div>
            </div>
            <!-- Completed Assessments -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-xl font-semibold mb-4 text-gray-700">Completed Assessments</h2>
                 <div id="completedWreckListContainer" class="h-96 overflow-y-auto">
                    <ul id="completedWreckList" class="space-y-2"></ul>
                     <p id="noCompletedWrecksMessage" class="text-gray-500 text-center hidden">No completed assessments found.</p>
                </div>
            </div>
            <!-- Alerts -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-xl font-semibold mb-4 text-gray-700">Environmental Alerts</h2>
                <div id="alertListContainer" class="h-96 overflow-y-auto">
                    <ul id="alertList" class="space-y-3"></ul>
                    <p id="noAlertsMessage" class="text-gray-500 text-center">No recent alerts.</p>
                </div>
            </div>
        </div>

        <div id="reportContainer" class="mt-8 bg-white rounded-lg shadow-lg p-6 md:p-8 max-w-6xl mx-auto hidden">
            <h2 id="reportTitle" class="text-4xl font-bold mb-6 text-center text-gray-800"></h2>
            <div id="alert-display-section" class="hidden mb-6"></div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div id="reportContent" class="lg:col-span-3 prose max-w-none">
                    <!-- AI-generated report text will be injected here -->
                </div>
                <div id="reportChart" class="lg:col-span-2">
                     <h3 class="text-xl font-bold mb-4 text-center text-gray-800">WERP Risk Profile</h3>
                    <canvas id="werSpiderChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, query, orderBy, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- Firebase Config & Global Variables ---
        // CRITICAL STEP: PASTE YOUR FIREBASE CONFIG OBJECT HERE.
        // This object is public by design and is used only to identify your Firebase project.
        const firebaseConfig = {
        apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
        authDomain: "project-guardian-agent.firebaseapp.com",
        projectId: "project-guardian-agent",
        storageBucket: "project-guardian-agent.firebasestorage.app",
        messagingSenderId: "84395007243",
        appId: "1:84395007243:web:b07e5f4c4264d27611160e",
        measurementId: "G-NRLH3WSCQ9"
        };
        
        // This check prevents the app from running with placeholder credentials.
        if (firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
            const errorMsg = "CONFIGURATION ERROR: The Firebase API Key is a placeholder. Please copy your actual Firebase config object from your project settings and paste it into the 'firebaseConfig' variable in the index.html file.";
            console.error(errorMsg);
            document.body.innerHTML = `<div style="padding: 2rem; margin: 2rem; text-align: center; font-family: sans-serif; background-color: #fff1f2; color: #b91c1c; border-radius: 8px; border: 2px solid #b91c1c;"><h1>Configuration Error</h1><p style="margin-top: 1rem;">${errorMsg}</p></div>`;
            throw new Error("Firebase Configuration Error");
        }

        const appId = 'guardian-agent-default';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // <-- THIS LINE WAS MISSING AND HAS BEEN CORRECTED.
        const functions = getFunctions(app);
        const callGeminiFunction = httpsCallable(functions, 'callGeminiApi');
        const assessmentsCollection = collection(db, `artifacts/${appId}/public/data/werpassessments`);
        let map;
        const markers = {};
        let spiderChart;
        let isRateLimited = false;

        // --- UI Elements ---
        const ui = {
            vesselNameInput: document.getElementById('vesselName'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            analyzeText: document.getElementById('analyzeText'),
            spinner: document.getElementById('spinner'),
            statusMessage: document.getElementById('statusMessage'),
            reportContainer: document.getElementById('reportContainer'),
            reportTitle: document.getElementById('reportTitle'),
            reportContent: document.getElementById('reportContent'),
            initialWreckList: document.getElementById('initialWreckList'),
            completedWreckList: document.getElementById('completedWreckList'),
            noInitialWrecksMessage: document.getElementById('noInitialWrecksMessage'),
            noCompletedWrecksMessage: document.getElementById('noCompletedWrecksMessage'),
            alertList: document.getElementById('alertList'),
            noAlertsMessage: document.getElementById('noAlertsMessage'),
            alertDisplaySection: document.getElementById('alert-display-section'),
        };

        // --- Initialization ---
        function initializeMap() {
            map = L.map('map').setView([10, 150], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);
        }

        signInAnonymously(auth)
            .then(() => {
                if (!map) initializeMap();
                listenForPreviousAnalyses();
            })
            .catch((error) => {
                console.error("Firebase Auth Failed:", error);
                updateStatus("Authentication failed. Please check console.", true);
            });

        // --- Real-time Data Handling ---
        function listenForPreviousAnalyses() {
            const q = query(assessmentsCollection, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                ui.initialWreckList.innerHTML = '';
                ui.completedWreckList.innerHTML = '';
                ui.alertList.innerHTML = '';
                
                let alertCount = 0;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const listElement = data.status === 'completed' ? ui.completedWreckList : ui.initialWreckList;
                    addWreckToListAndMap(doc, listElement);
                    if (data.alerts && data.alerts.length > 0) {
                        const unacknowledgedAlerts = data.alerts.filter(a => !a.acknowledged);
                        if (unacknowledgedAlerts.length > 0) {
                            alertCount += unacknowledgedAlerts.length;
                            unacknowledgedAlerts.forEach(alert => addAlertToList(alert, data.vesselName, doc.id));
                        }
                    }
                });
                
                ui.noInitialWrecksMessage.classList.toggle('hidden', ui.initialWreckList.children.length > 0);
                ui.noCompletedWrecksMessage.classList.toggle('hidden', ui.completedWreckList.children.length > 0);
                ui.noAlertsMessage.classList.toggle('hidden', alertCount > 0);

            }, (error) => { console.error("Firestore Snapshot Error:", error); });
        }

        function addWreckToListAndMap(doc, listElement) {
            const data = doc.data();
            const docId = doc.id;
            const hasAlert = data.alerts && data.alerts.some(a => !a.acknowledged);
            const li = document.createElement('li');
            li.className = 'wreck-list-item p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition duration-200';
            li.innerHTML = `<span>${data.vesselName}</span> ${hasAlert ? '<span class="alert-icon">ðŸš¨</span>' : ''}`;
            li.dataset.id = docId;
            li.addEventListener('click', () => handleWreckSelection(docId));
            listElement.append(li);

            const coords = data.phase1?.screening?.coordinates;
            if (coords?.latitude && coords?.longitude) {
                if (markers[docId]) map.removeLayer(markers[docId]);
                const risk = getRiskProfile(data);
                const popupContent = createPopupContent(data, risk);
                const marker = L.marker([coords.latitude, coords.longitude], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${risk.color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup(popupContent);
                markers[docId] = marker;
            }
        }
        
        function addAlertToList(alert, vesselName, docId) {
            const li = document.createElement('li');
            li.className = 'p-3 bg-red-50 border-l-4 border-red-500 rounded-r-md';
            li.innerHTML = `
                <p class="font-semibold text-red-800">${vesselName}</p>
                <p class="text-sm text-gray-700">${alert.details}</p>
                <p class="text-xs text-gray-500 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
                <button data-doc-id="${docId}" class="view-report-btn text-xs text-blue-600 hover:underline mt-1">View Report</button>
            `;
            ui.alertList.prepend(li);
        }

        document.getElementById('alertList').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-report-btn')) {
                const docId = e.target.dataset.docId;
                handleWreckSelection(docId);
            }
        });

        async function handleWreckSelection(docId) {
            document.querySelectorAll('.wreck-list-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.wreck-list-item[data-id="${docId}"]`)?.classList.add('active');
            updateStatus(`Fetching report...`);
            ui.reportContainer.classList.add('hidden');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderReport(data, docId);
                    updateStatus(`Report for ${data.vesselName} loaded.`);
                    ui.reportContainer.scrollIntoView({ behavior: 'smooth' });
                    const coords = data.phase1?.screening?.coordinates;
                    if (coords && map) {
                        map.flyTo([coords.latitude, coords.longitude], 8);
                        setTimeout(() => markers[docId]?.openPopup(), 500);
                    }
                } else { updateStatus(`Could not find report.`, true); }
            } catch (error) { console.error(error); updateStatus("Failed to fetch report.", true); }
        }
        
        // --- Core Agent & Analysis Logic ---
        ui.analyzeBtn.addEventListener('click', runFullAnalysis);
        ui.vesselNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && runFullAnalysis());

        async function runFullAnalysis() {
            if (isRateLimited) { updateStatus("Please wait before next analysis.", true); return; }
            const vesselName = ui.vesselNameInput.value.trim();
            if (!vesselName) { updateStatus("Please enter a vessel name.", true); return; }
            setLoading(true);
            ui.reportContainer.classList.add('hidden');
            try {
                const docId = vesselName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    renderReport(docSnap.data(), docId);
                    updateStatus(`Report for ${vesselName} loaded from database.`);
                } else {
                    const newReportData = await performNewAnalysis(vesselName);
                    await saveToDatabase(docRef, newReportData, { status: "initial" });
                    renderReport(newReportData, docId);
                    updateStatus(`Analysis complete for ${vesselName}.`);
                }
                document.querySelectorAll('.wreck-list-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.wreck-list-item[data-id="${docId}"]`)?.classList.add('active');
                setRateLimit();
            } catch (error) { console.error(error); updateStatus(`An error occurred: ${error.message}`, true); } 
            finally { setLoading(false); }
        }

        async function performNewAnalysis(vesselName) {
            let fullReportData = { vesselName };
            updateStatus("Phase 1: Researching...");
            fullReportData.phase1 = await callGemini(getPhase1Prompt(vesselName));
            updateStatus("Phase 3: Analyzing WCS...");
            fullReportData.wcs = await callGemini(getWcsPrompt(vesselName, fullReportData.phase1.summary.background));
            updateStatus("Phase 3: Analyzing PHS...");
            fullReportData.phs = await callGemini(getPhsPrompt(vesselName, fullReportData.phase1.summary.background));
            updateStatus("Phase 3: Analyzing ESI...");
            fullReportData.esi = await callGemini(getEsiPrompt(vesselName, fullReportData.phase1.summary.location));
            updateStatus("Phase 3: Analyzing RPM...");
            fullReportData.rpm = await callGemini(getRpmPrompt(vesselName, fullReportData.phase1.summary.location));
            updateStatus("Synthesizing final report...");
            fullReportData.finalSummary = await callGemini(getSummaryPrompt(vesselName, fullReportData));
            return fullReportData;
        }

        async function enhanceAnalysis(docId, existingData, phase2Text) {
            setLoading(true, "Enhancing...");
            try {
                updateStatus("Summarizing Phase 2 data...");
                const phase2Summary = await callGemini(getPhase2SummaryPrompt(phase2Text));
                
                updateStatus("Re-evaluating WERP scores...");
                const updatedScores = await callGemini(getUpdatedScoresPrompt(existingData, phase2Text));

                updateStatus("Synthesizing updated report...");
                const updatedFinalSummary = await callGemini(getSummaryPrompt(existingData.vesselName, { ...existingData, ...updatedScores, phase2: phase2Summary }));

                const finalUpdate = {
                    ...updatedScores,
                    phase2: {
                        summary: phase2Summary.summary,
                        sourceData: phase2Text
                    },
                    finalSummary: updatedFinalSummary,
                    status: "completed"
                };

                const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
                await updateDoc(docRef, finalUpdate);
                
                updateStatus("Enhancement complete. Report updated.");
                handleWreckSelection(docId); // Reload the report
            } catch (error) {
                console.error("Enhancement failed:", error);
                updateStatus(`Enhancement failed: ${error.message}`, true);
            } finally {
                setLoading(false);
            }
        }
        
        // --- API & Database ---
        async function callGemini(prompt) {
            try {
                const result = await callGeminiFunction({ prompt });
                if (result.data.success) {
                    return JSON.parse(result.data.data);
                } else {
                    throw new Error("Cloud function returned an error.");
                }
            } catch (error) {
                console.error("callGemini Error:", error);
                throw error;
            }
        }

        async function saveToDatabase(docRef, data, extraFields = {}) {
             try { await setDoc(docRef, { ...data, ...extraFields, createdAt: serverTimestamp() }); } 
             catch (e) { console.error(e); updateStatus("Failed to save report.", true); }
        }

        // --- Prompt Generation ---
        function getPhase1Prompt(v) { return `You are an expert maritime historian. For "${v}", conduct a Phase 1 assessment. Return JSON with coordinates: {"summary":{"background":"...","location":"...","discovery":"..."},"screening":{"vesselType":"...","tonnage":12345,"sunkDate":"YYYY-MM-DD","sinkingCause":"...","coordinates":{"latitude":-9.2,"longitude":159.7}},"conclusion":"..."}`; }
        function getWcsPrompt(v, c) { return `You are a naval architecture expert. For "${v}", analyze WCS based on: ${c}. Return JSON: { "parameters": [{"name": "Age", "rationale": "...", "score": 5}, ...], "totalScore": 15 }`; }
        function getPhsPrompt(v, c) { return `You are a marine pollution expert. For "${v}", analyze PHS based on: ${c}. Return JSON: { "parameters": [{"name": "Fuel Volume & Type", "rationale": "...", "score": 10, "weight": 40, "weightedScore": 4.0}, ...], "totalWeightedScore": 8.7 }`; }
        function getEsiPrompt(v, l) { return `You are a marine ecologist. For "${v}" near "${l}", analyze ESI. Return JSON: { "parameters": [{"name": "Proximity to Sensitive Ecosystems", "rationale": "...", "score": 10}, ...], "totalScore": 38 }`; }
        function getRpmPrompt(v, l) { return `You are a climate scientist. For "${v}" near "${l}", analyze RPM. Return JSON: { "parameters": [{"name": "Thermal Stress", "rationale": "...", "value": 1.3}, ...], "finalMultiplier": 1.8 }`; }
        function getSummaryPrompt(v, d) { const c = JSON.stringify(d); return `You are a lead strategist. For "${v}", synthesize this data: ${c}. Return JSON: { "summativeAssessment": "...", "remediationSuggestions": [{"priority": 1, "title": "...", "description": "..."}, ...] }`; }
        function getPhase2SummaryPrompt(phase2Text) { return `You are a lead surveyor. Summarize the following in-situ assessment data into a concise paragraph for the Phase 2 section of a WERP report: "${phase2Text}". Return JSON: {"summary": "..."}`; }
        function getUpdatedScoresPrompt(existingData, phase2Text) { const d = JSON.stringify(existingData); return `You are a lead risk assessor. Review the existing OSINT report: ${d}. Now, consider this new in-situ data: "${phase2Text}". Re-evaluate the WCS, PHS, ESI, and RPM scores. Provide a rationale for any changes based ONLY on the new data. Return JSON containing ONLY the four updated score objects: {"wcs":{...}, "phs":{...}, "esi":{...}, "rpm":{...}}`; }

        // --- UI & Rendering Helpers ---
        function setLoading(isLoading, text = 'Analyzing...') { ui.analyzeBtn.disabled = isLoading; ui.spinner.classList.toggle('hidden', !isLoading); ui.analyzeText.textContent = isLoading ? text : 'Analyze Wreck'; if (!isLoading) ui.statusMessage.textContent = ""; }
        function updateStatus(message, isError = false) { ui.statusMessage.textContent = message; ui.statusMessage.style.color = isError ? '#ef4444' : '#6b7280'; }
        function setRateLimit() { isRateLimited = true; setTimeout(() => { isRateLimited = false; updateStatus(""); }, 30000); }

        function renderReport(data, docId) {
            if (!data || !data.phase1) { /* error handling */ return; }
            ui.reportTitle.textContent = `WERP Assessment: ${data.vesselName}`;
            
            if (data.alerts && data.alerts.some(a => !a.acknowledged)) {
                ui.alertDisplaySection.classList.remove('hidden');
                ui.alertDisplaySection.innerHTML = `
                    <div class="p-4 mb-6 bg-yellow-50 border-l-4 border-yellow-400">
                        <h3 class="font-bold text-yellow-800">Recent Environmental Alerts</h3>
                        <p class="text-sm text-yellow-700 mt-1">A recent seismic event was detected near this wreck. The WERP score below does not reflect potential new structural damage. A re-assessment or in-situ survey is highly recommended.</p>
                    </div>`;
            } else {
                ui.alertDisplaySection.classList.add('hidden');
            }

            const phase2HTML = data.status === 'completed'
                ? `<section><h3>Phase 2: In-Situ Assessment (Completed)</h3><p>${data.phase2.summary}</p></section>`
                : `<section><h3>Phase 2: In-Situ Assessment (Recommended)</h3><p>A complete WERP assessment requires a physical, in-situ survey to gather ground-truth data. This typically involves deploying ROVs for visual inspection, performing UT measurements, and collecting samples. This data provides the definitive inputs for a final, high-confidence risk classification.</p><div id="phase2-enhancement-module" class="mt-6 p-4 border-t-2 border-gray-200">
                    <h4 class="text-lg font-semibold mb-2">Enhance with Phase 2 Data</h4>
                    <textarea id="phase2-text-input" class="w-full h-32 p-2 border border-gray-300 rounded-md" placeholder="Paste ROV survey summary, UT readings, diver reports, etc. here..."></textarea>
                    <button id="enhance-report-btn" class="mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">Enhance Report</button>
                   </div></section>`;

            ui.reportContent.innerHTML = `
                <section><h3>Case Study Background</h3><p>${data.phase1.summary.background}</p><p><strong>Location:</strong> ${data.phase1.summary.location}</p><p><strong>Discovery:</strong> ${data.phase1.summary.discovery}</p></section>
                <section><h3>Phase 1: Scoping & Screening</h3><ul><li><strong>Vessel Type:</strong> ${data.phase1.screening.vesselType}</li><li><strong>Tonnage:</strong> ${data.phase1.screening.tonnage.toLocaleString()} tons</li><li><strong>Date Sunk:</strong> ${data.phase1.screening.sunkDate}</li><li><strong>Cause of Sinking:</strong> ${data.phase1.screening.sinkingCause}</li></ul><p><strong>Conclusion:</strong> ${data.phase1.conclusion}</p></section>
                ${phase2HTML}
                <section><h3>Phase 3: ${data.status === 'completed' ? 'Final' : 'Preliminary'} Risk Synthesis & Classification</h3><p class="italic text-gray-600">Note: This analysis is based on ${data.status === 'completed' ? 'both OSINT and in-situ data' : 'open-source intelligence gathered in Phase 1'}.</p><h4>Wreck Condition Score (WCS) Analysis</h4>${createTable(data.wcs.parameters, ['Parameter', 'Rationale', 'Score (1-5)'], ['name', 'rationale', 'score'])}<p class="text-right font-bold">Total WCS: ${data.wcs.totalScore} / 20</p><h4>Pollutant Hazard Score (PHS) Analysis</h4>${createTable(data.phs.parameters, ['Parameter', 'Rationale', 'Score (1-10)', 'Weighted Score'], ['name', 'rationale', 'score', 'weightedScore'])}<p class="text-right font-bold">Total Weighted PHS: ${data.phs.totalWeightedScore.toFixed(1)} / 10</p><h4>Environmental Sensitivity Index (ESI) Analysis</h4>${createTable(data.esi.parameters, ['Parameter', 'Rationale', 'Score (1-10)'], ['name', 'rationale', 'score'])}<p class="text-right font-bold">Total ESI: ${data.esi.totalScore} / 40</p><h4>Release Probability Modifier (RPM) Analysis</h4>${createTable(data.rpm.parameters, ['Parameter', 'Rationale', 'Value'], ['name', 'rationale', 'value'])}<p class="text-right font-bold">Final Multiplier: ${data.rpm.finalMultiplier}x</p></section>
                <section><h3>Summative Assessment</h3><p>${data.finalSummary.summativeAssessment}</p></section>
                <section><h3>Remediation Suggestions</h3>${data.finalSummary.remediationSuggestions.map(s => `<div class="mt-4"><h4>Priority ${s.priority}: ${s.title}</h4><p>${s.description}</p></div>`).join('')}</section>`;
            
            if (data.status !== 'completed') {
                document.getElementById('enhance-report-btn').addEventListener('click', () => {
                    const phase2Text = document.getElementById('phase2-text-input').value;
                    if (phase2Text.trim()) {
                        enhanceAnalysis(docId, data, phase2Text.trim());
                    } else {
                        alert("Please enter Phase 2 data to enhance the report.");
                    }
                });
            }

            createOrUpdateSpiderChart(data);
            ui.reportContainer.classList.remove('hidden');
        }

        function createTable(data, headers, keys) { let table = '<table><thead><tr>'; headers.forEach(h => table += `<th>${h}</th>`); table += '</tr></thead><tbody>'; data.forEach(row => { table += '<tr>'; keys.forEach(key => table += `<td>${row[key]}</td>`); table += '</tr>'; }); table += '</tbody></table>'; return table; }
        
        function getRiskProfile(data) { try { const wcs = data.wcs.totalScore / 20; const phs = data.phs.totalWeightedScore / 10; const esi = data.esi.totalScore / 40; const rpm = data.rpm.finalMultiplier; const overallRisk = (phs * 0.5 + esi * 0.4 + wcs * 0.1) * rpm; if (overallRisk > 1.2) return { label: 'Extreme', color: 'violet', popupColor: '#8b5cf6' }; if (overallRisk > 0.9) return { label: 'Very High', color: 'red', popupColor: '#ef4444' }; if (overallRisk > 0.6) return { label: 'High', color: 'orange', popupColor: '#f97316' }; if (overallRisk > 0.3) return { label: 'Medium', color: 'yellow', popupColor: '#eab308' }; return { label: 'Low', color: 'green', popupColor: '#22c55e' }; } catch (e) { return { label: 'Unknown', color: 'grey', popupColor: '#6b7280' }; } }
        
        function createPopupContent(data, risk) { return `<div style="font-family: 'Inter', sans-serif; font-size: 14px; min-width: 200px;"><h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #1e3a8a;">${data.vesselName}</h3><p style="margin: 0 0 10px 0; font-weight: bold; color: ${risk.popupColor};">Risk: ${risk.label}</p><hr style="border: none; border-top: 1px solid #e2e8f0; margin: 8px 0;"><p style="margin: 4px 0;"><strong>WCS:</strong> ${data.wcs?.totalScore || 'N/A'}/20</p><p style="margin: 4px 0;"><strong>PHS:</strong> ${data.phs?.totalWeightedScore?.toFixed(1) || 'N/A'}/10</p><p style="margin: 4px 0;"><strong>ESI:</strong> ${data.esi?.totalScore || 'N/A'}/40</p><p style="margin: 4px 0;"><strong>RPM:</strong> ${data.rpm?.finalMultiplier || 'N/A'}x</p></div>`; }

        function createOrUpdateSpiderChart(data) {
            const ctx = document.getElementById('werSpiderChart').getContext('2d');
            const scores = {
                wcs: data.wcs?.totalScore ? (data.wcs.totalScore / 20) * 100 : 0,
                phs: data.phs?.totalWeightedScore ? (data.phs.totalWeightedScore / 10) * 100 : 0,
                esi: data.esi?.totalScore ? (data.esi.totalScore / 40) * 100 : 0,
                rpm: data.rpm?.finalMultiplier ? ((data.rpm.finalMultiplier - 1) / 1.5) * 100 : 0, 
            };

            const chartData = {
                labels: ['WCS', 'PHS', 'ESI', 'RPM'],
                datasets: [
                    { label: 'Low Risk', data: [25, 25, 25, 10], borderColor: 'rgba(46, 213, 115, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false, },
                    { label: 'Medium Risk', data: [50, 50, 50, 40], borderColor: 'rgba(255, 165, 2, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false, },
                    { label: 'High Risk', data: [75, 75, 75, 70], borderColor: 'rgba(255, 71, 87, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false, },
                    {
                        label: data.vesselName, data: [scores.wcs, scores.phs, scores.esi, scores.rpm],
                        borderColor: 'rgba(30, 64, 175, 1)', backgroundColor: 'rgba(30, 64, 175, 0.2)', borderWidth: 3,
                        pointBackgroundColor: 'rgba(30, 64, 175, 1)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(30, 64, 175, 1)', pointRadius: 5, fill: true,
                    }
                ]
            };
            
            if (spiderChart) { spiderChart.data = chartData; spiderChart.update(); } 
            else { spiderChart = new Chart(ctx, { type: 'radar', data: chartData, options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14, weight: 'bold' } }, ticks: { backdropColor: 'rgba(255,255,255,0.75)', stepSize: 25 } } }, plugins: { legend: { position: 'bottom' } } } }); }
        }
    </script>
</body>
</html>

