<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Guardian: AI Wreck Assessment Agent</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet Map Library -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js for Spider Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- App styles -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Theme controller -->
  <script src="theme.js" defer></script>
</head>
<body class="text-gray-800" style="font-family: 'Inter', sans-serif;">
  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Marinas Guardian Logo" class="h-16" />
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Deeptrek Logo" class="h-16" />
      </div>
      <div class="flex items-center">
        <h1 class="hidden md:block text-2xl font-bold text-gray-700">Project Guardian AI Wreck Assessment Agent</h1>
        
        <!-- Auth UI -->
        <div id="authContainer" class="ml-4 flex items-center gap-2">
          <!-- Sign-in button (shown when signed out) -->
          <button
            id="signInBtn"
            class="hidden px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
          >
            Sign in with Google
          </button>
          
          <!-- User info and sign-out (shown when signed in) -->
          <div id="userInfo" class="hidden flex items-center gap-2">
            <span id="userDisplay" class="text-sm text-gray-600"></span>
            <button
              id="signOutBtn"
              class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              Sign out
            </button>
          </div>
        </div>
        
        <button
          id="themeToggle"
          class="ml-4 rounded-md border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50"
          onclick="toggleTheme()"
          aria-label="Toggle theme"
          title="Toggle theme"
        >ðŸŒ™</button>
      </div>
    </div>
  </header>

  <main class="container mx-auto p-4 md:p-8">
    <!-- Analyze New Vessel -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8 max-w-2xl mx-auto">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Analyze New Vessel</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <input
          type="text"
          id="vesselName"
          class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="e.g., IJN Kirishima"
          aria-label="Vessel name"
        />
        <button
          id="analyzeBtn"
          class="bg-blue-800 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-900 transition duration-300 flex items-center justify-center"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
               xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10 21l2-2m-2-2l2 2m6-6a8 8 0 11-16 0 8 8 0 0116 0z" />
          </svg>
          <div id="spinner" class="spinner animate-spin rounded-full h-5 w-5 border-2 border-white border-t-blue-800 mr-2 hidden"></div>
          <span id="analyzeText">Analyze Wreck</span>
        </button>
      </div>
      <p id="statusMessage" class="text-sm text-gray-500 mt-4 text-center h-4" aria-live="polite"></p>
    </div>

    <!-- Map -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <div id="mapContainer" class="lg:col-span-3 bg-white rounded-lg shadow-lg p-4">
        <div id="map"></div>
      </div>
    </div>

    <!-- Lists -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Initial Assessments -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Initial Assessments</h2>
        <div id="initialWreckListContainer" class="h-96 overflow-y-auto">
          <ul id="initialWreckList" class="space-y-2"></ul>
          <p id="noInitialWrecksMessage" class="text-gray-500 text-center hidden">No initial assessments found.</p>
        </div>
      </div>

      <!-- Completed Assessments -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Completed Assessments</h2>
        <div id="completedWreckListContainer" class="h-96 overflow-y-auto">
          <ul id="completedWreckList" class="space-y-2"></ul>
          <p id="noCompletedWrecksMessage" class="text-gray-500 text-center hidden">No completed assessments found.</p>
        </div>
      </div>

      <!-- Alerts -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Environmental Alerts</h2>
        <div id="alertListContainer" class="h-96 overflow-y-auto">
          <ul id="alertList" class="space-y-3"></ul>
          <p id="noAlertsMessage" class="text-gray-500 text-center">No recent alerts.</p>
        </div>
      </div>
    </div>

    <!-- Report -->
    <div id="reportContainer" class="mt-8 bg-white rounded-lg shadow-lg p-6 md:p-8 max-w-6xl mx-auto hidden">
      <h2 id="reportTitle" class="text-4xl font-bold mb-6 text-center text-gray-800"></h2>
      <div id="alert-display-section" class="hidden mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <div id="reportContent" class="lg:col-span-3 prose max-w-none"></div>
        <div id="reportChart" class="lg:col-span-2">
          <h3 class="text-xl font-bold mb-4 text-center text-gray-800">WERP Risk Profile</h3>
          <canvas id="werSpiderChart" aria-label="WERP risk profile radar chart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp,
      collection, query, orderBy, onSnapshot, writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    // --- Firebase Config & Global Variables ---
    const firebaseConfig = {
      apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
      authDomain: "project-guardian-agent.firebaseapp.com",
      projectId: "project-guardian-agent",
      storageBucket: "project-guardian-agent.firebasestorage.app",
      messagingSenderId: "84395007243",
      appId: "1:84395007243:web:b07e5f4c4264d27611160e",
      measurementId: "G-NRLH3WSCQ9"
    };

    // This check prevents the app from running with placeholder credentials.
    if (firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
      const errorMsg = "CONFIGURATION ERROR: The Firebase API Key is a placeholder. Please copy your actual Firebase config object from your project settings and paste it into the 'firebaseConfig'.";
      console.error(errorMsg);
      document.body.innerHTML = `<div style="padding: 2rem; margin: 2rem; text-align: center; font-family: sans-serif; background-color: #fff1f2; color: #b91c1c; border-radius: 8px; border: 1px solid #fecaca;">
        <h1>Configuration Required</h1>
        <p>${errorMsg}</p>
      </div>`;
      throw new Error("Firebase Configuration Error");
    }

    const appId = 'guardian-agent-default';
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // Pin region to where your functions deploy (adjust if needed)
    const functions = getFunctions(app, 'us-central1');
    const callGeminiFunction = httpsCallable(functions, 'callGeminiApi');
    const assessmentsCollection = collection(db, `artifacts/${appId}/public/data/werpassessments`);

    let map;
    const markers = {};
    let spiderChart;
    let isRateLimited = false;

    // --- UI Elements ---
    const ui = {
      vesselNameInput: document.getElementById('vesselName'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      analyzeText: document.getElementById('analyzeText'),
      spinner: document.getElementById('spinner'),
      statusMessage: document.getElementById('statusMessage'),
      reportContainer: document.getElementById('reportContainer'),
      reportTitle: document.getElementById('reportTitle'),
      reportContent: document.getElementById('reportContent'),
      initialWreckList: document.getElementById('initialWreckList'),
      completedWreckList: document.getElementById('completedWreckList'),
      noInitialWrecksMessage: document.getElementById('noInitialWrecksMessage'),
      noCompletedWrecksMessage: document.getElementById('noCompletedWrecksMessage'),
      alertList: document.getElementById('alertList'),
      noAlertsMessage: document.getElementById('noAlertsMessage'),
      alertDisplaySection: document.getElementById('alert-display-section'),
      // Auth UI elements
      signInBtn: document.getElementById('signInBtn'),
      signOutBtn: document.getElementById('signOutBtn'),
      userInfo: document.getElementById('userInfo'),
      userDisplay: document.getElementById('userDisplay'),
    };

    // --- Initialization ---
    function initializeMap() {
      map = L.map('map').setView([10, 150], 3);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ' +
          '&copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(map);
    }

    // --- Authentication Logic ---
    const googleProvider = new GoogleAuthProvider();
    let currentUser = null;

    // Google Sign-in function
    async function signInWithGoogle() {
      try {
        ui.signInBtn.textContent = 'Signing in...';
        ui.signInBtn.disabled = true;
        
        let result;
        try {
          // Try popup first
          result = await signInWithPopup(auth, googleProvider);
        } catch (popupError) {
          console.log('Popup failed, trying redirect:', popupError);
          // Fallback to redirect if popup fails
          await signInWithRedirect(auth, googleProvider);
          return; // signInWithRedirect doesn't return, so exit here
        }
        
        console.log('Successfully signed in:', result.user.displayName);
      } catch (error) {
        console.error('Google sign-in failed:', error);
        updateStatus('Sign-in failed. Please try again.', true);
        ui.signInBtn.textContent = 'Sign in with Google';
        ui.signInBtn.disabled = false;
      }
    }

    // Sign-out function
    async function signOutUser() {
      try {
        await signOut(auth);
        console.log('Successfully signed out');
      } catch (error) {
        console.error('Sign-out failed:', error);
        updateStatus('Sign-out failed. Please try again.', true);
      }
    }

    // Update UI based on auth state
    function updateAuthUI(user) {
      if (user) {
        // User is signed in
        ui.signInBtn.classList.add('hidden');
        ui.userInfo.classList.remove('hidden');
        ui.userDisplay.textContent = user.displayName || user.email || 'User';
        currentUser = user;
      } else {
        // User is signed out
        ui.signInBtn.classList.remove('hidden');
        ui.userInfo.classList.add('hidden');
        ui.signInBtn.textContent = 'Sign in with Google';
        ui.signInBtn.disabled = false;
        currentUser = null;
      }
    }

    // Initialize app for authenticated users
    function initializeUserApp() {
      if (!map) initializeMap();
      listenForPreviousAnalyses();
    }

    // Auth state change listener
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed:', user ? user.displayName || user.email : 'signed out');
      updateAuthUI(user);
      
      if (user) {
        // User is signed in - initialize the app
        initializeUserApp();
      } else {
        // User is signed out - clear any existing data but don't show errors
        if (map) {
          // Clear map markers but keep map
          Object.values(markers).forEach(marker => marker.remove());
          Object.keys(markers).forEach(key => delete markers[key]);
        }
        // Clear lists
        if (ui.initialWreckList) ui.initialWreckList.innerHTML = '';
        if (ui.completedWreckList) ui.completedWreckList.innerHTML = '';
        if (ui.alertList) ui.alertList.innerHTML = '';
        // Show appropriate messages
        updateStatus('Please sign in to access the application.');
      }
    });

    // Event listeners for auth buttons
    ui.signInBtn.addEventListener('click', signInWithGoogle);
    ui.signOutBtn.addEventListener('click', signOutUser);

    // --- Real-time Data Handling ---
    function listenForPreviousAnalyses() {
      const q = query(assessmentsCollection, orderBy("createdAt", "desc"));
      onSnapshot(q, (snapshot) => {
        ui.initialWreckList.innerHTML = '';
        ui.completedWreckList.innerHTML = '';
        ui.alertList.innerHTML = '';

        let alertCount = 0;

        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const listElement = data.status === 'completed' ? ui.completedWreckList : ui.initialWreckList;
          addWreckToListAndMap(docSnap, listElement);

          if (data.alerts && data.alerts.length > 0) {
            const unacknowledgedAlerts = data.alerts.filter(a => !a.acknowledged);
            if (unacknowledgedAlerts.length > 0) {
              alertCount += unacknowledgedAlerts.length;
              unacknowledgedAlerts.forEach(alert => addAlertToList(alert, data.vesselName, docSnap.id));
            }
          }
        });

        ui.noInitialWrecksMessage.classList.toggle('hidden', ui.initialWreckList.children.length > 0);
        ui.noCompletedWrecksMessage.classList.toggle('hidden', ui.completedWreckList.children.length > 0);
        ui.noAlertsMessage.classList.toggle('hidden', alertCount > 0);

      }, (error) => { console.error("Firestore Snapshot Error:", error); });
    }

    function addWreckToListAndMap(docSnap, listElement) {
      const data = docSnap.data();
      const docId = docSnap.id;
      const hasAlert = data.alerts && data.alerts.some(a => !a.acknowledged);

      const li = document.createElement('li');
      li.className = 'wreck-list-item p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition duration-200';
      li.innerHTML = `<span>${data.vesselName}</span> ${hasAlert ? '<span class="alert-icon">ðŸš¨</span>' : ''}`;
      li.dataset.id = docId;
      li.addEventListener('click', () => handleWreckSelection(docId));
      listElement.append(li);

      const coords = data.phase1?.screening?.coordinates;
      if (coords?.latitude && coords?.longitude) {
        if (markers[docId]) map.removeLayer(markers[docId]);

        const risk = getRiskProfile(data);
        const popupContent = createPopupContent(data, risk);
        const marker = L.marker([coords.latitude, coords.longitude], {
          icon: L.icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${risk.color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          })
        }).addTo(map).bindPopup(popupContent);

        markers[docId] = marker;
      }
    }

    function addAlertToList(alert, vesselName, docId) {
      const li = document.createElement('li');
      li.className = 'p-3 bg-red-50 border-l-4 border-red-500 rounded-r-md';
      li.innerHTML = `
        <p class="font-semibold text-red-800">${vesselName}</p>
        <p class="text-sm text-gray-700">${alert.details}</p>
        <p class="text-xs text-gray-500 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
        <button data-doc-id="${docId}" class="view-report-btn text-xs text-blue-600 hover:underline mt-1">View Report</button>
      `;
      ui.alertList.prepend(li);
    }

    document.getElementById('alertList').addEventListener('click', (e) => {
      if (e.target.classList.contains('view-report-btn')) {
        const docId = e.target.dataset.docId;
        handleWreckSelection(docId);
      }
    });

    async function handleWreckSelection(docId) {
      // Check if user is authenticated
      if (!currentUser) {
        updateStatus("Please sign in to view reports.", true);
        return;
      }
      
      document.querySelectorAll('.wreck-list-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`.wreck-list-item[data-id="${docId}"]`)?.classList.add('active');

      updateStatus('Fetching report...');
      ui.reportContainer.classList.add('hidden');

      try {
        const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          renderReport(data, docId);
          updateStatus(`Report for ${data.vesselName} loaded.`);
          ui.reportContainer.scrollIntoView({ behavior: 'smooth' });

          const coords = data.phase1?.screening?.coordinates;
          if (coords && map) {
            map.flyTo([coords.latitude, coords.longitude], 8);
            setTimeout(() => markers[docId]?.openPopup(), 500);
          }
        } else {
          updateStatus('Could not find report.', true);
        }
      } catch (error) {
        console.error(error);
        updateStatus("Failed to fetch report.", true);
      }
    }

    // --- Core Agent & Analysis Logic ---
    ui.analyzeBtn.addEventListener('click', runFullAnalysis);
    ui.vesselNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && runFullAnalysis());

    async function runFullAnalysis() {
      // Check if user is authenticated
      if (!currentUser) {
        updateStatus("Please sign in to perform analysis.", true);
        return;
      }
      
      if (isRateLimited) { updateStatus("Please wait before next analysis.", true); return; }

      const vesselName = ui.vesselNameInput.value.trim();
      if (!vesselName) { updateStatus("Please enter a vessel name.", true); return; }

      setLoading(true);
      ui.reportContainer.classList.add('hidden');

      try {
        const docId = vesselName.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          renderReport(docSnap.data(), docId);
          updateStatus(`Report for ${vesselName} loaded from database.`);
        } else {
          const newReportData = await performNewAnalysis(vesselName);
          await saveToDatabase(docRef, newReportData, { status: "initial" });
          renderReport(newReportData, docId);
          updateStatus(`Analysis complete for ${vesselName}.`);
        }

        document.querySelectorAll('.wreck-list-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.wreck-list-item[data-id="${docId}"]`)?.classList.add('active');

        setRateLimit();
      } catch (error) {
        console.error(error);
        updateStatus(`An error occurred: ${error.message}`, true);
      } finally {
        setLoading(false);
      }
    }

    async function performNewAnalysis(vesselName) {
      let fullReportData = { vesselName };

      updateStatus("Phase 1: Researching...");
      fullReportData.phase1 = await callGemini(getPhase1Prompt(vesselName));

      updateStatus("Phase 3: Analyzing WCS...");
      fullReportData.wcs = await callGemini(getWcsPrompt(vesselName, fullReportData.phase1.summary.background));

      updateStatus("Phase 3: Analyzing PHS...");
      fullReportData.phs = await callGemini(getPhsPrompt(vesselName, fullReportData.phase1.summary.background));

      updateStatus("Phase 3: Analyzing ESI...");
      fullReportData.esi = await callGemini(getEsiPrompt(vesselName, fullReportData.phase1.summary.location));

      updateStatus("Phase 3: Analyzing RPM...");
      fullReportData.rpm = await callGemini(getRpmPrompt(vesselName, fullReportData.phase1.summary.location));

      updateStatus("Synthesizing final report...");
      fullReportData.finalSummary = await callGemini(getSummaryPrompt(vesselName, fullReportData));

      return fullReportData;
    }

    async function enhanceAnalysis(docId, existingData, phase2Text) {
      setLoading(true, "Enhancing...");
      try {
        updateStatus("Summarizing Phase 2 data...");
        const phase2Summary = await callGemini(getPhase2SummaryPrompt(phase2Text));

        updateStatus("Re-evaluating WERP scores...");
        const updatedScores = await callGemini(getUpdatedScoresPrompt(existingData, phase2Text));

        updateStatus("Synthesizing updated report...");
        const updatedFinalSummary = await callGemini(
          getSummaryPrompt(existingData.vesselName, { ...existingData, ...updatedScores, phase2: phase2Summary })
        );

        const finalUpdate = {
          ...updatedScores,
          phase2: {
            summary: phase2Summary.summary,
            sourceData: phase2Text
          },
          finalSummary: updatedFinalSummary,
          status: "completed"
        };

        const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
        await updateDoc(docRef, finalUpdate);

        updateStatus("Enhancement complete. Report updated.");
        handleWreckSelection(docId);
      } catch (error) {
        console.error("Enhancement failed:", error);
        updateStatus(`Enhancement failed: ${error.message}`, true);
      } finally {
        setLoading(false);
      }
    }

    // --- API & Database ---
    async function callGemini(prompt) {
      try {
        const result = await callGeminiFunction({ prompt });
        const payload = result?.data ?? result;
        const raw = payload?.data ?? payload?.text ?? payload;

        if (typeof raw !== "string") {
          throw new Error("Unexpected response format from server.");
        }

        const cleaned = raw.trim()
          .replace(/^```(?:json)?/i, "")
          .replace(/```$/, "")
          .trim();

        try {
          return JSON.parse(cleaned);
        } catch (parseErr) {
          console.error("Failed to parse model JSON. Raw:", raw);
          throw new Error("Model returned invalid JSON. See console for details.");
        }
      } catch (error) {
        console.error("callGemini Error:", error);
        throw error;
      }
    }

    async function saveToDatabase(docRef, data, extraFields = {}) {
      try {
        await setDoc(docRef, { ...data, ...extraFields, createdAt: serverTimestamp() });
      } catch (e) {
        console.error(e);
        updateStatus("Failed to save report.", true);
      }
    }

    // --- Prompt Generation ---
    function getPhase1Prompt(v) {
      return `You are an expert maritime historian. For "${v}", conduct a Phase 1 WERP assessment.
Return strictly valid JSON with:
{
  "summary": {"background":"...", "location":"...", "discovery":"..."},
  "screening": {
    "vesselType":"...", "tonnage":"...", "yearBuilt":"...", "lastOwner":"...",
    "coordinates": {"latitude": <number>, "longitude": <number>}
  }
}`;
    }

    function getWcsPrompt(v, context) {
      return `You are a naval architecture expert. For "${v}", analyze WCS using context: ${context}.
Return JSON:
{
  "parameters": [
    {"name":"Age","rationale":"...","score":0-5},
    {"name":"Construction","rationale":"...","score":0-5},
    {"name":"Integrity","rationale":"...","score":0-5},
    {"name":"Corrosion","rationale":"...","score":0-5}
  ],
  "totalScore": 0-20
}`;
    }

    function getPhsPrompt(v, context) {
      return `You are a marine pollution expert. For "${v}", analyze PHS using context: ${context}.
Return JSON:
{
  "parameters": [
    {"name":"Fuel Volume & Type","rationale":"...","weight":1,"score":0-10},
    {"name":"Cargo Risk","rationale":"...","weight":1,"score":0-10},
    {"name":"Residual Oils","rationale":"...","weight":1,"score":0-10},
    {"name":"Leak Likelihood","rationale":"...","weight":1,"score":0-10}
  ],
  "totalWeightedScore": 0-10
}`;
    }

    function getEsiPrompt(v, loc) {
      return `You are a marine ecologist. For "${v}" near "${loc}", analyze ESI.
Return JSON:
{
  "parameters": [
    {"name":"Proximity to Sensitive Ecosystems","rationale":"...","score":0-10},
    {"name":"Biodiversity Value","rationale":"...","score":0-10},
    {"name":"Protected Areas","rationale":"...","score":0-10},
    {"name":"Socioeconomic Sensitivity","rationale":"...","score":0-10}
  ],
  "totalScore": 0-40
}`;
    }

    function getRpmPrompt(v, loc) {
      return `You are a climate scientist. For "${v}" near "${loc}", analyze RPM (Risk Pressure Modifiers).
Return JSON:
{
  "factors": [
    {"name":"Thermal Stress","rationale":"...","value":1.0-2.5},
    {"name":"Storm Exposure","rationale":"...","value":1.0-2.5},
    {"name":"Seismic Activity","rationale":"...","value":1.0-2.5},
    {"name":"Anthropogenic Disturbance","rationale":"...","value":1.0-2.5}
  ],
  "finalMultiplier": 1.0-2.5
}`;
    }

    function getSummaryPrompt(v, d) {
      const c = JSON.stringify(d);
      return `You are a lead strategist. For "${v}", synthesize this data: ${c}.
Return JSON:
{
  "summativeAssessment": "...",
  "remediationSuggestions": [
    {"priority":1,"title":"...","description":"..."},
    {"priority":2,"title":"...","description":"..."},
    {"priority":3,"title":"...","description":"..."}
  ]
}`;
    }

    function getPhase2SummaryPrompt(phase2Text) {
      return `You are a lead surveyor. Summarize this in-situ assessment for WERP Phase 2 in <= 150 words:
${phase2Text}
Return JSON: {"summary":"..."}`;
    }

    function getUpdatedScoresPrompt(existingData, phase2Text) {
      const d = JSON.stringify(existingData);
      return `You are a lead risk assessor. Review this OSINT report: ${d}.
Now consider Phase 2 data: ${phase2Text}.
Recalculate WCS, PHS, ESI, RPM as needed and return JSON merging ONLY recalculated sections:
{"wcs":{"parameters":[...] ,"totalScore":...}, "phs":{"parameters":[...], "totalWeightedScore":...}, "esi":{"parameters":[...], "totalScore":...}, "rpm":{"factors":[...], "finalMultiplier":...}}`;
    }

    // --- UI & Rendering Helpers ---
    function setLoading(isLoading, text = 'Analyzing...') {
      ui.analyzeBtn.disabled = isLoading;
      ui.spinner.classList.toggle('hidden', !isLoading);
      ui.analyzeText.textContent = isLoading ? text : 'Analyze Wreck';
    }

    function updateStatus(message, isError = false) {
      ui.statusMessage.textContent = message;
      ui.statusMessage.style.color = isError ? '#ef4444' : '#6b7280';
    }

    function setRateLimit() {
      isRateLimited = true;
      setTimeout(() => { isRateLimited = false; updateStatus(""); }, 30000);
    }

    // UPDATED: Phase 2 appears before Phase 3, and note hidden when completed
    function renderReport(data, docId) {
      if (!data || !data.phase1) return;

      ui.reportTitle.textContent = `WERP Assessment: ${data.vesselName}`;

      // Alerts banner if present
      if (data.alerts && data.alerts.some(a => !a.acknowledged)) {
        ui.alertDisplaySection.classList.remove('hidden');
        ui.alertDisplaySection.innerHTML = `
          <div class="p-4 mb-6 bg-yellow-50 border-l-4 border-yellow-400">
            <h3 class="font-bold text-yellow-800">Recent Environmental Alerts</h3>
            <p class="text-sm text-yellow-700 mt-1">
              A recent event was detected near this wreck. The WERP score below may not reflect potential new structural changes.
              A re-assessment is recommended.
            </p>
          </div>`;
      } else {
        ui.alertDisplaySection.classList.add('hidden');
      }

      const phase2HTML = data.status === 'completed'
        ? `<section><h3>Phase 2: In-Situ Assessment (Completed)</h3><p>${data.phase2.summary}</p></section>`
        : `<section>
            <h3>Phase 2: In-Situ Assessment (Recommended)</h3>
            <p>A complete WERP assessment requires an in-situ survey to gather ground-truth data (e.g., UT readings, ROV imagery, diver reports).</p>
            <div class="mt-4">
              <h4 class="text-lg font-semibold mb-2">Enhance with Phase 2 Data</h4>
              <textarea id="phase2-text-input" class="w-full h-32 p-2 border border-gray-300 rounded-md"
                        placeholder="Paste ROV survey summary, UT readings, diver reports, etc. here..."></textarea>
              <button id="enhance-report-btn"
                      class="mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">
                Enhance Report
              </button>
            </div>
          </section>`;

      // Helper to build simple tables
      function createTable(rows, headers, keys) {
        let table = '<table><thead><tr>';
        headers.forEach(h => table += `<th>${h}</th>`);
        table += '</tr></thead><tbody>';
        rows.forEach(row => {
          table += '<tr>';
          keys.forEach(k => table += `<td>${row[k] ?? ''}</td>`);
          table += '</tr>';
        });
        table += '</tbody></table>';
        return table;
      }

      // Phase order: Background -> Phase 1 -> Phase 2 -> Phase 3 (WCS, PHS, ESI, RPM) -> Synthesis -> Summary -> Remediation
      ui.reportContent.innerHTML = `
        <section>
          <h3>Case Study Background</h3>
          <p>${data.phase1.summary.background}</p>
          <p><strong>Location:</strong> ${data.phase1.summary.location}</p>
          <p><strong>Discovery:</strong> ${data.phase1.summary.discovery}</p>
        </section>

        <section>
          <h3>Phase 1: Scoping & Screening</h3>
          <ul class="list-disc ml-5 space-y-1">
            <li><strong>Vessel Type:</strong> ${data.phase1.screening.vesselType}</li>
            <li><strong>Tonnage:</strong> ${data.phase1.screening.tonnage}</li>
            <li><strong>Year Built:</strong> ${data.phase1.screening.yearBuilt}</li>
            <li><strong>Last Owner:</strong> ${data.phase1.screening.lastOwner}</li>
            <li><strong>Coordinates:</strong> ${data.phase1.screening.coordinates?.latitude ?? 'â€”'}, ${data.phase1.screening.coordinates?.longitude ?? 'â€”'}</li>
          </ul>
        </section>

        ${phase2HTML}

        <section>
          <h3>Phase 3: WCS (Hull & Structure)</h3>
          ${createTable(
            data.wcs?.parameters ?? [],
            ['Parameter', 'Rationale', 'Score'],
            ['name', 'rationale', 'score']
          )}
          <p class="mt-2"><strong>Total Score:</strong> ${data.wcs?.totalScore ?? 'â€”'} / 20</p>
        </section>

        <section>
          <h3>Phase 3: PHS (Pollution Hazard)</h3>
          ${createTable(
            data.phs?.parameters ?? [],
            ['Parameter', 'Rationale', 'Weight', 'Score'],
            ['name', 'rationale', 'weight', 'score']
          )}
          <p class="mt-2"><strong>Total Weighted Score:</strong> ${data.phs?.totalWeightedScore ?? 'â€”'} / 10</p>
        </section>

        <section>
          <h3>Phase 3: ESI (Environmental Sensitivity)</h3>
          ${createTable(
            data.esi?.parameters ?? [],
            ['Parameter', 'Rationale', 'Score'],
            ['name', 'rationale', 'score']
          )}
          <p class="mt-2"><strong>Total Score:</strong> ${data.esi?.totalScore ?? 'â€”'} / 40</p>
        </section>

        <section>
          <h3>Phase 3: RPM (Risk Pressure Modifiers)</h3>
          ${createTable(
            data.rpm?.factors ?? [],
            ['Factor', 'Rationale', 'Value'],
            ['name', 'rationale', 'value']
          )}
          <p class="mt-2"><strong>Final Multiplier:</strong> ${data.rpm?.finalMultiplier ?? 'â€”'}Ã—</p>
        </section>

        <section>
          <h3>${data.status === 'completed' ? 'Final' : 'Preliminary'} Risk Synthesis & Classification</h3>
          ${data.status === 'completed' ? '' : `
            <p class="italic text-gray-600">
              Note: This analysis is based on available information. On-site verification may change the final classification.
            </p>`}
        </section>

        <section>
          <h3>Summative Assessment</h3>
          <p>${data.finalSummary?.summativeAssessment ?? 'â€”'}</p>
        </section>

        <section>
          <h3>Remediation Suggestions</h3>
          ${(data.finalSummary?.remediationSuggestions ?? []).map(s => `
            <div class="mt-4">
              <h4>Priority ${s.priority}: ${s.title}</h4>
              <p>${s.description}</p>
            </div>
          `).join('')}
        </section>
      `;

      if (data.status !== 'completed') {
        const btn = document.getElementById('enhance-report-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const phase2Text = document.getElementById('phase2-text-input').value;
            if (phase2Text.trim()) {
              enhanceAnalysis(docId, data, phase2Text.trim());
            } else {
              alert("Please enter Phase 2 data to enhance the report.");
            }
          });
        }
      }

      createOrUpdateSpiderChart(data);
      ui.reportContainer.classList.remove('hidden');
    }

    function getRiskProfile(data) {
      try {
        const wcs = data.wcs?.totalScore ? data.wcs.totalScore / 20 : 0;
        const phs = data.phs?.totalWeightedScore ? data.phs.totalWeightedScore / 10 : 0;
        const esi = data.esi?.totalScore ? data.esi.totalScore / 40 : 0;
        const rpm = data.rpm?.finalMultiplier ? (data.rpm.finalMultiplier - 1) / 1.5 : 0;

        const avg = (wcs + phs + esi + rpm) / 4;
        const color = avg >= 0.66 ? 'red' : avg >= 0.33 ? 'orange' : 'green';
        const label = avg >= 0.66 ? 'High' : avg >= 0.33 ? 'Medium' : 'Low';

        return { avg, color, label };
      } catch {
        return { avg: 0, color: 'green', label: 'Low' };
      }
    }

    function createPopupContent(data, risk) {
      const coords = data.phase1?.screening?.coordinates;
      const latStr = coords?.latitude?.toFixed ? coords.latitude.toFixed(4) : 'â€”';
      const lonStr = coords?.longitude?.toFixed ? coords.longitude.toFixed(4) : 'â€”';
      return `
        <div style="font-family: 'Inter', sans-serif; font-size: 14px; min-width: 220px;">
          <h3 style="margin: 0 0 6px 0; font-size: 16px; font-weight: 700;">${data.vesselName}</h3>
          <p style="margin: 0 0 4px 0; color: #334155;">Risk: <strong>${risk.label}</strong></p>
          <p style="margin: 0; color: #475569;">Lat/Lon: ${latStr}, ${lonStr}</p>
        </div>
      `;
    }

    function createOrUpdateSpiderChart(data) {
      const ctx = document.getElementById('werSpiderChart').getContext('2d');
      const scores = {
        wcs: data.wcs?.totalScore ? (data.wcs.totalScore / 20) * 100 : 0,
        phs: data.phs?.totalWeightedScore ? (data.phs.totalWeightedScore / 10) * 100 : 0,
        esi: data.esi?.totalScore ? (data.esi.totalScore / 40) * 100 : 0,
        rpm: data.rpm?.finalMultiplier ? ((data.rpm.finalMultiplier - 1) / 1.5) * 100 : 0
      };

      const chartData = {
        labels: ['WCS', 'PHS', 'ESI', 'RPM'],
        datasets: [
          { label: 'Low Risk', data: [25, 25, 25, 10], borderColor: 'rgba(46, 213, 115, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false },
          { label: 'Medium Risk', data: [50, 50, 50, 40], borderColor: 'rgba(255, 165, 2, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false },
          { label: 'High Risk', data: [75, 75, 75, 70], borderColor: 'rgba(255, 71, 87, 0.9)', borderWidth: 2.5, pointRadius: 0, fill: false },
          {
            label: data.vesselName,
            data: [scores.wcs, scores.phs, scores.esi, scores.rpm],
            borderColor: 'rgba(30, 64, 175, 1)',
            backgroundColor: 'rgba(30, 64, 175, 0.2)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(30, 64, 175, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(30, 64, 175, 1)',
            pointRadius: 5,
            fill: true
          }
        ]
      };

      if (spiderChart) {
        spiderChart.data = chartData;
        spiderChart.update();
      } else {
        spiderChart = new Chart(ctx, {
          type: 'radar',
          data: chartData,
          options: {
            responsive: true,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                angleLines: { color: 'rgba(148,163,184,0.25)' },
                grid: { color: 'rgba(148,163,184,0.25)' },
                pointLabels: { font: { size: 14, weight: 'bold' } },
                ticks: { display: false }
              }
            },
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
    }
  </script>
</body>
</html>