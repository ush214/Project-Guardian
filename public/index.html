<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Guardian: AI Wreck Assessment Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Chart.js for Spider Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --header-bg: #002D62; /* Dark Blue from PDF */
            --main-bg: #f0f2f5; /* Light Grey */
            --card-bg: #ffffff;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --accent-blue: #00509e;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); }
        .spinner { border-top-color: var(--accent-blue); }
        #map { height: 500px; z-index: 10; border-radius: 0.5rem; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 10px !important; }
        .prose h3 { font-size: 1.25em; margin-top: 1.5em; margin-bottom: 0.75em; font-weight: 700; color: var(--header-bg); border-bottom: 2px solid var(--accent-blue); padding-bottom: 0.25em;}
        .prose h4 { font-size: 1.1em; margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; color: var(--text-dark); }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; font-size: 0.9em; }
        .prose th { background-color: #f8fafc; font-weight: 600; }
        .wreck-list-item { cursor: pointer; border-left: 4px solid transparent; }
        .wreck-list-item.active, .wreck-list-item:hover { border-left-color: var(--accent-blue); background-color: #eef2ff; }
    </style>
</head>
<body class="text-gray-800">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg" alt="Marinas Guardian Logo" class="h-16">
                <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg" alt="Deeptrek Logo" class="h-16">
            </div>
            <h1 class="hidden md:block text-2xl font-bold text-gray-700">Project Guardian AI Wreck Assessment Agent</h1>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 max-w-2xl mx-auto">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Analyze New Vessel</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="vesselName" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., IJN Kirishima">
                <button id="analyzeBtn" class="bg-blue-800 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-900 transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <div id="spinner" class="spinner animate-spin rounded-full h-5 w-5 border-2 border-white border-t-blue-800 mr-2 hidden"></div>
                    <span id="analyzeText">Analyze Wreck</span>
                </button>
            </div>
             <p id="statusMessage" class="text-sm text-gray-500 mt-4 text-center h-4"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div id="mapContainer" class="lg:col-span-2 bg-white rounded-lg shadow-lg p-4">
                <div id="map"></div>
            </div>
            <div id="previousAssessments" class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Previously Analyzed</h2>
                <div id="wreckListContainer" class="max-h-96 overflow-y-auto">
                    <div id="wreckListSpinner" class="flex justify-center items-center h-24">
                        <div class="spinner animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-600"></div>
                    </div>
                    <ul id="wreckList" class="space-y-2"></ul>
                    <p id="noWrecksMessage" class="text-gray-500 text-center hidden">No assessments found yet.</p>
                </div>
            </div>
        </div>

        <div id="reportContainer" class="bg-white rounded-lg shadow-lg p-6 md:p-8 max-w-6xl mx-auto hidden">
            <h2 id="reportTitle" class="text-4xl font-bold mb-6 text-center text-gray-800"></h2>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div id="reportContent" class="lg:col-span-3 prose max-w-none">
                    <!-- AI-generated report text will be injected here -->
                </div>
                <div id="reportChart" class="lg:col-span-2">
                     <h3 class="text-xl font-bold mb-4 text-center text-gray-800">WERP Risk Profile</h3>
                    <canvas id="werSpiderChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- Firebase Config & Global Variables ---
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
  authDomain: "project-guardian-agent.firebaseapp.com",
  projectId: "project-guardian-agent",
  storageBucket: "project-guardian-agent.firebasestorage.app",
  messagingSenderId: "84395007243",
  appId: "1:84395007243:web:b07e5f4c4264d27611160e",
  measurementId: "G-NRLH3WSCQ9"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        };

        // Configuration Check: This will stop the app and show an error if the API key is still a placeholder.
        if (firebaseConfig.apiKey.startsWith("AIzaSy...")) {
            const errorMsg = "CONFIGURATION ERROR: The Firebase API Key is a placeholder. Please copy your actual Firebase config object from your project settings and paste it into the 'firebaseConfig' variable in the index.html file.";
            console.error(errorMsg);
            document.body.innerHTML = `<div style="padding: 2rem; margin: 2rem; text-align: center; font-family: sans-serif; background-color: #fff1f2; color: #b91c1c; border-radius: 8px; border: 2px solid #b91c1c;"><h1>Configuration Error</h1><p style="margin-top: 1rem;">${errorMsg}</p></div>`;
            throw new Error("Firebase Configuration Error");
        }


        const appId = 'guardian-agent-default';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app); // Initialize Cloud Functions
        const assessmentsCollection = collection(db, `artifacts/${appId}/public/data/werpassessments`);
        let map;
        const markers = {};
        let spiderChart;
        let isRateLimited = false;

        // --- UI Elements ---
        const ui = {
            vesselNameInput: document.getElementById('vesselName'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            analyzeText: document.getElementById('analyzeText'),
            spinner: document.getElementById('spinner'),
            statusMessage: document.getElementById('statusMessage'),
            reportContainer: document.getElementById('reportContainer'),
            reportTitle: document.getElementById('reportTitle'),
            reportContent: document.getElementById('reportContent'),
            wreckList: document.getElementById('wreckList'),
            wreckListSpinner: document.getElementById('wreckListSpinner'),
            noWrecksMessage: document.getElementById('noWrecksMessage'),
        };

        // --- Initialization ---
        function initializeMap() {
            map = L.map('map').setView([10, 150], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);
        }

        signInAnonymously(auth)
            .then(() => {
                if (!map) initializeMap();
                listenForPreviousAnalyses();
            })
            .catch((error) => {
                console.error("Firebase Auth Failed:", error);
                updateStatus("Authentication failed. Please check console.", true);
            });


        // --- Real-time Data Handling ---
        function listenForPreviousAnalyses() {
            const q = query(assessmentsCollection, orderBy("createdAt", "desc"), limit(25));
            onSnapshot(q, (snapshot) => {
                ui.wreckListSpinner.classList.add('hidden');
                ui.noWrecksMessage.classList.toggle('hidden', !snapshot.empty);
                const currentIds = new Set([...ui.wreckList.children].map(li => li.dataset.id));
                snapshot.docs.forEach(doc => {
                    if (!currentIds.has(doc.id)) addWreckToListAndMap(doc);
                });
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                ui.wreckListSpinner.classList.add('hidden');
                ui.noWrecksMessage.textContent = "Error loading assessments.";
                ui.noWrecksMessage.classList.remove('hidden');
            });
        }

        function addWreckToListAndMap(doc) {
            const data = doc.data();
            const docId = doc.id;
            const li = document.createElement('li');
            li.className = 'wreck-list-item p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition duration-200';
            li.textContent = data.vesselName;
            li.dataset.id = docId;
            li.addEventListener('click', () => handleWreckSelection(docId));
            ui.wreckList.prepend(li);

            const coords = data.phase1?.screening?.coordinates;
            if (coords?.latitude && coords?.longitude) {
                if (markers[docId]) map.removeLayer(markers[docId]);
                const risk = getRiskProfile(data);
                const popupContent = createPopupContent(data, risk);
                const marker = L.marker([coords.latitude, coords.longitude], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${risk.color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup(popupContent);
                markers[docId] = marker;
            }
        }
        
        async function handleWreckSelection(docId) {
            document.querySelectorAll('#wreckList .wreck-list-item').forEach(item => item.classList.remove('active'));
            const selectedLi = document.querySelector(`#wreckList .wreck-list-item[data-id="${docId}"]`);
            if (selectedLi) selectedLi.classList.add('active');

            updateStatus(`Fetching report for ${docId}...`);
            ui.reportContainer.classList.add('hidden');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderReport(data);
                    updateStatus(`Report for ${data.vesselName} loaded from database.`);
                    ui.reportContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    const coords = data.phase1?.screening?.coordinates;
                    if (coords && map) {
                        map.flyTo([coords.latitude, coords.longitude], 8);
                        setTimeout(() => markers[docId]?.openPopup(), 500);
                    }
                } else {
                    updateStatus(`Could not find report for ${docId}.`, true);
                }
            } catch (error) {
                console.error("Error fetching selected wreck:", error);
                updateStatus("Failed to fetch selected report.", true);
            }
        }
        
        // --- Core Agent & Analysis Logic ---
        ui.analyzeBtn.addEventListener('click', runFullAnalysis);
        ui.vesselNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && runFullAnalysis());

        async function runFullAnalysis() {
            if (isRateLimited) {
                updateStatus("Please wait a moment before the next analysis.", true);
                return;
            }

            const vesselName = ui.vesselNameInput.value.trim();
            if (!vesselName) {
                updateStatus("Please enter a vessel name.", true);
                return;
            }
            setLoading(true);
            ui.reportContainer.classList.add('hidden');

            try {
                const docId = vesselName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const docRef = doc(db, `artifacts/${appId}/public/data/werpassessments`, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    renderReport(docSnap.data());
                    updateStatus(`Report for ${vesselName} loaded from database.`);
                } else {
                    const newReportData = await performNewAnalysis(vesselName);
                    await saveToDatabase(docRef, newReportData);
                    renderReport(newReportData);
                    updateStatus(`Analysis complete for ${vesselName}.`);
                }
                
                document.querySelectorAll('#wreckList .wreck-list-item').forEach(item => item.classList.remove('active'));
                const newLi = document.querySelector(`#wreckList .wreck-list-item[data-id="${docId}"]`);
                if (newLi) newLi.classList.add('active');
                
                // Set rate limit for 30 seconds after a successful analysis
                isRateLimited = true;
                setTimeout(() => {
                    isRateLimited = false;
                    updateStatus(""); // Clear status after cooldown
                }, 30000); // 30 seconds

            } catch (error) {
                console.error("Full analysis failed:", error);
                updateStatus(`An error occurred: ${error.message}`, true);
            } finally {
                setLoading(false);
            }
        }

        async function performNewAnalysis(vesselName) {
            let fullReportData = { vesselName };
            updateStatus("Phase 1: Researching...");
            fullReportData.phase1 = await callGemini(getPhase1Prompt(vesselName));
            updateStatus("Analyzing WCS...");
            fullReportData.wcs = await callGemini(getWcsPrompt(vesselName, fullReportData.phase1.summary.background));
            updateStatus("Analyzing PHS...");
            fullReportData.phs = await callGemini(getPhsPrompt(vesselName, fullReportData.phase1.summary.background));
            updateStatus("Analyzing ESI...");
            fullReportData.esi = await callGemini(getEsiPrompt(vesselName, fullReportData.phase1.summary.location));
            updateStatus("Analyzing RPM...");
            fullReportData.rpm = await callGemini(getRpmPrompt(vesselName, fullReportData.phase1.summary.location));
            updateStatus("Synthesizing...");
            fullReportData.finalSummary = await callGemini(getSummaryPrompt(vesselName, fullReportData));
            return fullReportData;
        }
        
        // --- API & Database ---
        async function callGemini(prompt, retries = 3, delay = 2000) {
            const callGeminiApi = httpsCallable(functions, 'callGeminiApi');
            for (let i = 0; i < retries; i++) {
                try {
                    const result = await callGeminiApi({ prompt: prompt });
                    if (result.data.success && result.data.data) {
                        return JSON.parse(result.data.data);
                    } else {
                        throw new Error("Cloud function returned an error or unexpected structure.");
                    }
                } catch (error) {
                     console.warn(`Attempt ${i + 1} failed for prompt via Cloud Function. Retrying... Error: ${error.message}`);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * (i + 1)));
                }
            }
        }

        async function saveToDatabase(docRef, data) {
             try {
                await setDoc(docRef, { ...data, createdAt: serverTimestamp() });
            } catch (e) {
                console.error("Save to Firestore failed:", e);
                updateStatus("Failed to save report to the database.", true);
            }
        }

        // --- Prompt Generation ---
        function getPhase1Prompt(v) { return `You are an expert maritime historian. For "${v}", conduct a Phase 1 assessment. Return JSON with coordinates: {"summary":{"background":"...","location":"...","discovery":"..."},"screening":{"vesselType":"...","tonnage":12345,"sunkDate":"YYYY-MM-DD","sinkingCause":"...","coordinates":{"latitude":-9.2,"longitude":159.7}},"conclusion":"..."}`; }
        function getWcsPrompt(v, c) { return `You are a naval architecture expert. For "${v}", analyze WCS based on: ${c}. Return JSON: { "parameters": [{"name": "Age", "rationale": "...", "score": 5}, ...], "totalScore": 15 }`; }
        function getPhsPrompt(v, c) { return `You are a marine pollution expert. For "${v}", analyze PHS based on: ${c}. Return JSON: { "parameters": [{"name": "Fuel Volume & Type", "rationale": "...", "score": 10, "weight": 40, "weightedScore": 4.0}, ...], "totalWeightedScore": 8.7 }`; }
        function getEsiPrompt(v, l) { return `You are a marine ecologist. For "${v}" near "${l}", analyze ESI. Return JSON: { "parameters": [{"name": "Proximity to Sensitive Ecosystems", "rationale": "...", "score": 10}, ...], "totalScore": 38 }`; }
        function getRpmPrompt(v, l) { return `You are a climate scientist. For "${v}" near "${l}", analyze RPM. Return JSON: { "parameters": [{"name": "Thermal Stress", "rationale": "...", "value": 1.3}, ...], "finalMultiplier": 1.8 }`; }
        function getSummaryPrompt(v, d) { const c = JSON.stringify(d); return `You are a lead strategist. For "${v}", synthesize this data: ${c}. Return JSON: { "summativeAssessment": "...", "remediationSuggestions": [{"priority": 1, "title": "...", "description": "..."}, ...] }`; }

        // --- UI & Rendering Helpers ---
        function setLoading(isLoading) { ui.analyzeBtn.disabled = isLoading; ui.spinner.classList.toggle('hidden', !isLoading); ui.analyzeText.textContent = isLoading ? 'Analyzing...' : 'Analyze Wreck'; if (!isLoading) ui.statusMessage.textContent = ""; }
        function updateStatus(message, isError = false) { ui.statusMessage.textContent = message; ui.statusMessage.style.color = isError ? '#ef4444' : '#6b7280'; }

        function renderReport(data) {
            if (!data || !data.phase1) {
                console.error("Invalid data for renderReport:", data);
                ui.reportContainer.innerHTML = `<p class="text-red-500 text-center">Error: Report data is incomplete.</p>`;
                ui.reportContainer.classList.remove('hidden');
                return;
            }
            ui.reportTitle.textContent = `WERP Assessment: ${data.vesselName}`;
            ui.reportContent.innerHTML = `
                <section><h3>Case Study Background</h3><p>${data.phase1.summary.background}</p><p><strong>Location:</strong> ${data.phase1.summary.location}</p><p><strong>Discovery:</strong> ${data.phase1.summary.discovery}</p></section>
                <section><h3>Phase 1: Scoping & Screening</h3><ul><li><strong>Vessel Type:</strong> ${data.phase1.screening.vesselType}</li><li><strong>Tonnage:</strong> ${data.phase1.screening.tonnage.toLocaleString()} tons</li><li><strong>Date Sunk:</strong> ${data.phase1.screening.sunkDate}</li><li><strong>Cause of Sinking:</strong> ${data.phase1.screening.sinkingCause}</li></ul><p><strong>Conclusion:</strong> ${data.phase1.conclusion}</p></section>
                <section><h3>Phase 3: Risk Synthesis & Classification</h3><h4>Wreck Condition Score (WCS) Analysis</h4>${createTable(data.wcs.parameters, ['Parameter', 'Rationale', 'Score (1-5)'], ['name', 'rationale', 'score'])}<p class="text-right font-bold">Total WCS: ${data.wcs.totalScore} / 20</p><h4>Pollutant Hazard Score (PHS) Analysis</h4>${createTable(data.phs.parameters, ['Parameter', 'Rationale', 'Score (1-10)', 'Weighted Score'], ['name', 'rationale', 'score', 'weightedScore'])}<p class="text-right font-bold">Total Weighted PHS: ${data.phs.totalWeightedScore.toFixed(1)} / 10</p><h4>Environmental Sensitivity Index (ESI) Analysis</h4>${createTable(data.esi.parameters, ['Parameter', 'Rationale', 'Score (1-10)'], ['name', 'rationale', 'score'])}<p class="text-right font-bold">Total ESI: ${data.esi.totalScore} / 40</p><h4>Release Probability Modifier (RPM) Analysis</h4>${createTable(data.rpm.parameters, ['Parameter', 'Rationale', 'Value'], ['name', 'rationale', 'value'])}<p class="text-right font-bold">Final Multiplier: ${data.rpm.finalMultiplier}x</p></section>
                <section><h3>Summative Assessment</h3><p>${data.finalSummary.summativeAssessment}</p></section>
                <section><h3>Remediation Suggestions</h3>${data.finalSummary.remediationSuggestions.map(s => `<div class="mt-4"><h4>Priority ${s.priority}: ${s.title}</h4><p>${s.description}</p></div>`).join('')}</section>`;
            
            createOrUpdateSpiderChart(data);
            ui.reportContainer.classList.remove('hidden');
        }

        function createTable(data, headers, keys) { let table = '<table><thead><tr>'; headers.forEach(h => table += `<th>${h}</th>`); table += '</tr></thead><tbody>'; data.forEach(row => { table += '<tr>'; keys.forEach(key => table += `<td>${row[key]}</td>`); table += '</tr>'; }); table += '</tbody></table>'; return table; }
        
        function getRiskProfile(data) { try { const wcs = data.wcs.totalScore / 20; const phs = data.phs.totalWeightedScore / 10; const esi = data.esi.totalScore / 40; const rpm = data.rpm.finalMultiplier; const overallRisk = (phs * 0.5 + esi * 0.4 + wcs * 0.1) * rpm; if (overallRisk > 1.2) return { label: 'Extreme', color: 'violet', popupColor: '#8b5cf6' }; if (overallRisk > 0.9) return { label: 'Very High', color: 'red', popupColor: '#ef4444' }; if (overallRisk > 0.6) return { label: 'High', color: 'orange', popupColor: '#f97316' }; if (overallRisk > 0.3) return { label: 'Medium', color: 'yellow', popupColor: '#eab308' }; return { label: 'Low', color: 'green', popupColor: '#22c55e' }; } catch (e) { return { label: 'Unknown', color: 'grey', popupColor: '#6b7280' }; } }
        
        function createPopupContent(data, risk) { return `<div style="font-family: 'Inter', sans-serif; font-size: 14px; min-width: 200px;"><h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #1e3a8a;">${data.vesselName}</h3><p style="margin: 0 0 10px 0; font-weight: bold; color: ${risk.popupColor};">Risk: ${risk.label}</p><hr style="border: none; border-top: 1px solid #e2e8f0; margin: 8px 0;"><p style="margin: 4px 0;"><strong>WCS:</strong> ${data.wcs?.totalScore || 'N/A'}/20</p><p style="margin: 4px 0;"><strong>PHS:</strong> ${data.phs?.totalWeightedScore?.toFixed(1) || 'N/A'}/10</p><p style="margin: 4px 0;"><strong>ESI:</strong> ${data.esi?.totalScore || 'N/A'}/40</p><p style="margin: 4px 0;"><strong>RPM:</strong> ${data.rpm?.finalMultiplier || 'N/A'}x</p></div>`; }

        function createOrUpdateSpiderChart(data) {
            const ctx = document.getElementById('werSpiderChart').getContext('2d');
            const scores = {
                wcs: data.wcs?.totalScore ? (data.wcs.totalScore / 20) * 100 : 0,
                phs: data.phs?.totalWeightedScore ? (data.phs.totalWeightedScore / 10) * 100 : 0,
                esi: data.esi?.totalScore ? (data.esi.totalScore / 40) * 100 : 0,
                rpm: data.rpm?.finalMultiplier ? ((data.rpm.finalMultiplier - 1) / 1.5) * 100 : 0, 
            };

            const chartData = {
                labels: ['WCS', 'PHS', 'ESI', 'RPM'],
                datasets: [
                    {
                        label: 'Low Risk',
                        data: [25, 25, 25, 10], 
                        borderColor: 'rgba(46, 213, 115, 0.9)', // Bright Green
                        borderWidth: 2.5,
                        pointRadius: 0,
                        fill: false,
                    },
                    {
                        label: 'Medium Risk',
                        data: [50, 50, 50, 40],
                        borderColor: 'rgba(255, 165, 2, 0.9)', // Bright Orange
                        borderWidth: 2.5,
                        pointRadius: 0,
                        fill: false,
                    },
                    {
                        label: 'High Risk',
                        data: [75, 75, 75, 70],
                        borderColor: 'rgba(255, 71, 87, 0.9)', // Bright Red
                        borderWidth: 2.5,
                        pointRadius: 0,
                        fill: false,
                    },
                    {
                        label: data.vesselName,
                        data: [scores.wcs, scores.phs, scores.esi, scores.rpm],
                        borderColor: 'rgba(30, 64, 175, 1)',
                        backgroundColor: 'rgba(30, 64, 175, 0.2)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(30, 64, 175, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(30, 64, 175, 1)',
                        pointRadius: 5,
                        fill: true,
                    }
                ]
            };
            
            if (spiderChart) {
                spiderChart.data = chartData;
                spiderChart.update();
            } else {
                spiderChart = new Chart(ctx, {
                    type: 'radar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: { font: { size: 14, weight: 'bold', family: 'Inter' } },
                                ticks: { backdropColor: 'rgba(255, 255, 255, 0.75)', stepSize: 25, font: {family: 'Inter'} }
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { font: { family: 'Inter', size: 12 } }
                            }
                        }
                    }
                });
            }
        }

    </script>
</body>
</html>

