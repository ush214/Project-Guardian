<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Project Guardian – WERP Reports</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <link rel="stylesheet" href="/monitoring.css" />
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width: 100%; height: 460px; border-radius: 10px; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid; }
    .pill.low { color:#065f46; background:#ecfdf5; border-color:#10b981; }
    .pill.medium { color:#92400e; background:#fffbeb; border-color:#f59e0b; }
    .pill.high { color:#991b1b; background:#fef2f2; border-color:#ef4444; }
    .pill.unknown { color:#334155; background:#f1f5f9; border-color:#cbd5e1; }
    .report-prose { max-width: none; font-size: 0.92rem; line-height: 1.45; color: #111827; }
    .report-prose table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
    .report-prose th, .report-prose td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: top; }
    #reportScroll { max-height: 75vh; overflow-y: auto; padding-right: 4px; }
    .gallery-tile img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; }
    .gallery-tile .file-tile { height: 120px; display:flex; align-items:center; justify-content:center; border-radius:6px; border:1px solid #e5e7eb; background:#f8fafc; font-size:12px; color:#475569; padding:6px; text-align:center; }
    .list-scroll { max-height: 420px; overflow-y: auto; padding-right: 4px; }
  </style>
</head>
<body class="bg-slate-50 text-gray-900">
  <header class="bg-gray-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-3 gap-3 items-center">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Marinas Guardian Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
        <img src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Deeptrek Logo" class="h-[72px] w-auto rounded-sm bg-white/5 p-1">
      </div>
      <div class="text-center">
        <h1 class="text-lg sm:text-xl font-semibold">Project Guardian – WERP Reports</h1>
      </div>
      <div class="flex items-center justify-end gap-2">
        <a id="monitoringBtn" href="/monitoring.html" class="bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-1.5 rounded">Monitoring</a>
        <a id="importDataBtn" href="/import.html" class="hidden bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs px-3 py-1.5 rounded border border-indigo-200">Import Data</a>
        <span id="userName" class="hidden text-xs text-indigo-200"></span>
        <button id="signOutBtn" class="hidden bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1.5 rounded">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Auth -->
    <section id="signedOutContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 max-w-md mx-auto">
      <h2 class="text-xl font-semibold text-gray-800 mb-2 text-center">Welcome</h2>
      <p class="text-gray-600 mb-4 text-center">Sign in with your email and password to continue.</p>
      <div class="space-y-3">
        <label class="block">
          <span class="text-sm text-gray-700">Email</span>
          <input id="emailInput" type="email" class="mt-1 w-full p-3 border border-gray-300 rounded-md" placeholder="you@example.com" autocomplete="email" />
        </label>
        <label class="block">
          <span class="text-sm text-gray-700">Password</span>
          <input id="passwordInput" type="password" class="mt-1 w-full p-3 border border-gray-300 rounded-md" placeholder="••••••••" autocomplete="current-password" />
        </label>
        <p id="authMessage" class="text-sm h-5 text-center text-gray-500" aria-live="polite"></p>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <button id="signInEmailBtn" class="flex-1 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Sign in</button>
          <button id="createAccountBtn" class="flex-1 px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Create account</button>
        </div>
        <button id="resetPasswordBtn" class="w-full text-sm text-indigo-700 hover:underline mt-1">Forgot password?</button>
      </div>
      <p class="text-xs text-gray-500 mt-6 text-center">New accounts start as read-only Users. Admin approval is required for Contributor access.</p>
    </section>

    <div id="appContainer" class="hidden space-y-6">
      <!-- Analyze -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-gray-800">Analyze New Vessel</h2>
          <div class="flex items-center gap-2">
            <span id="roleBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-300">Role: —</span>
            <span id="contribHint" class="text-xs text-gray-500 hidden">Contributor access required</span>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <input type="text" id="vesselName" class="flex-1 p-3 border border-gray-300 rounded-md" placeholder="e.g., USS Chevalier" />
          <button id="analyzeBtn" class="bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md hover:bg-indigo-800 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="analyzeText">Analyze Wreck</span>
          </button>
        </div>
        <p id="statusMessage" class="text-sm text-gray-500 mt-3 h-5" aria-live="polite"></p>
      </section>

      <!-- Map -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-3">
        <div id="map"></div>
      </section>

      <!-- Filters -->
      <section class="bg-white border border-gray-200 rounded-xl shadow p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="text-sm font-medium text-gray-800">Severity Filters</h3>
            <div class="flex items-center gap-4 mt-1 text-sm">
              <label class="flex items-center gap-2"><input id="sevHigh" type="checkbox" class="h-4 w-4" checked> High</label>
              <label class="flex items-center gap-2"><input id="sevMedium" type="checkbox" class="h-4 w-4" checked> Medium</label>
              <label class="flex items-center gap-2"><input id="sevLow" type="checkbox" class="h-4 w-4" checked> Low</label>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search vessel name..." class="w-64 border border-gray-300 rounded-md px-3 py-2 text-sm">
            <button id="clearSearch" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <div class="text-xs text-gray-600">Showing: <span id="visibleCounts">0</span></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Severity = (WCS + PHS + (ESI ÷ 3)) × RPM.</p>
      </section>

      <!-- Lists -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Initial Assessments</h2>
            <span id="initialCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="initialWreckList" class="list-scroll space-y-2"></div>
          <div id="noInitialWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No initial assessments match your filters.</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Completed Assessments</h2>
            <span id="completedCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="completedWreckList" class="list-scroll space-y-2"></div>
          <div id="noCompletedWrecksMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No completed assessments match your filters.</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-semibold text-gray-800">Requiring Reassessment</h2>
            <span id="reassessCount" class="text-xs text-gray-600">0</span>
          </div>
          <div id="reassessList" class="list-scroll space-y-2"></div>
          <div id="noReassessMessage" class="text-sm text-gray-500 border border-dashed border-gray-300 rounded-md p-3 mt-2 hidden">No reassessments match your filters.</div>
        </div>
      </section>

      <!-- Report -->
      <section id="reportContainer" class="bg-white border border-gray-200 rounded-xl shadow p-6 hidden">
        <div class="flex items-center justify-between mb-3">
          <h2 id="reportTitle" class="text-2xl font-bold text-gray-900"></h2>
          <div class="flex items-center gap-2">
            <button id="exportPdfBtn" class="text-xs px-2 py-1 rounded border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">Export PDF</button>
            <button id="exportHtmlBtn" class="text-xs px-2 py-1 rounded border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">HTML</button>
            <button id="exportMdBtn" class="text-xs px-2 py-1 rounded border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">MD</button>
            <button id="exportJsonBtn" class="text-xs px-2 py-1 rounded border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">JSON</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <div class="lg:col-span-3">
            <h3 class="text-base font-bold mb-3 text-center text-gray-900">WERP Risk Profile</h3>
            <div id="werSpiderWrapper" class="rounded border border-gray-200 bg-white h-[340px]">
              <canvas id="werSpiderChart" aria-label="WERP risk profile radar chart"></canvas>
            </div>
            <div id="benchLegend" class="mt-2 text-xs text-gray-600 text-center"></div>
          </div>

          <div class="lg:col-span-2 space-y-4">
            <div>
              <h3 class="text-base font-bold mb-3 text-gray-900">Uploaded Files</h3>
              <div id="uploadGalleryGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
              <p id="uploadGalleryEmpty" class="text-xs text-gray-500 mt-1 hidden">No uploads yet.</p>
            </div>
            <div>
              <h3 class="text-base font-bold mb-3 text-gray-900">Cached Media</h3>
              <div id="referenceMediaGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
              <p id="referenceMediaEmpty" class="text-xs text-gray-500 mt-1 hidden">No cached media yet.</p>
            </div>
          </div>
        </div>

        <div id="reportScroll" class="mt-4">
          <div id="reportContent" class="report-prose"></div>
        </div>

        <div id="monitoring-panel" class="mt-6"></div>

        <div id="phase2Section" class="mt-6 border-top pt-4">
          <h3 class="text-base font-semibold text-gray-800 mb-2">Phase 2: In-Situ Assessment (Recommended)</h3>
          <p class="text-xs text-gray-500 mb-3">Provide UT readings, ROV imagery, and diver logs to finalize classification.</p>
          <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <div class="lg:col-span-3">
              <label class="text-sm text-gray-700">In-situ notes</label>
              <textarea id="phase2Input" class="w-full min-h-[120px] p-2 border border-gray-300 rounded-md" placeholder="Paste Phase 2 field observations here..."></textarea>
              <div class="flex items-center gap-2 mt-2">
                <button id="savePhase2Btn" class="text-xs px-3 py-1.5 rounded bg-gray-800 text-white hover:bg-gray-700">Save Phase 2</button>
                <button id="reassessBtn" class="text-xs px-3 py-1.5 rounded bg-indigo-600 text-white hover:bg-indigo-500">Reassess with Phase 2</button>
                <span id="phase2Status" class="text-xs text-gray-500"></span>
              </div>
            </div>
            <div class="lg:col-span-2">
              <label class="text-sm text-gray-700">Upload files (images, PDFs, logs)</label>
              <input id="phase2Files" type="file" multiple class="block w-full mt-1 text-sm file:mr-2 file:py-2 file:px-3 file:rounded-md file:border file:border-gray-300 file:bg-white file:text-gray-700 hover:file:bg-gray-50" />
              <div class="flex items-center gap-2 mt-2">
                <button id="uploadFilesBtn" class="text-xs px-3 py-1.5 rounded bg-gray-700 text-white hover:bg-gray-600">Upload files</button>
                <span id="uploadStatus" class="text-xs text-gray-500"></span>
              </div>
              <p class="text-[11px] text-gray-500 mt-1">Images appear in the gallery; other files are attached to this report.</p>
            </div>
          </div>
        </div>

        <div id="feedbackSection" class="mt-6 border-t pt-4">
          <h3 class="text-base font-semibold text-gray-800 mb-2">Assessment Feedback (per report)</h3>
          <div class="flex flex-col gap-2">
            <textarea id="feedbackInput" class="w-full min-h-[80px] p-2 border border-gray-300 rounded-md" placeholder="Highlight issues, corrections, or guidance for reassessment..."></textarea>
            <div class="flex items-center gap-2">
              <button id="saveFeedbackBtn" class="text-xs px-3 py-1.5 rounded bg-indigo-600 text-white hover:bg-indigo-500">Save feedback</button>
              <span id="feedbackStatus" class="text-xs text-gray-500"></span>
            </div>
          </div>
          <div class="mt-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-1">Recent feedback</h4>
            <ul id="feedbackList" class="space-y-2"></ul>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module" src="/app.js"></script>
  <script type="module" src="/monitoring-init.js"></script>
</body>
</html>