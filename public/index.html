<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <title>Project Guardian: WW2 Wreck Analysis and Monitoring Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            'soft': '0 2px 10px rgba(0,0,0,0.25)',
            'card': '0 8px 24px rgba(0,0,0,0.35)'
          }
        }
      }
    }
  </script>
  <!-- Leaflet (interactive map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>
  <style>
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 6px; }
    ::-webkit-scrollbar-thumb:hover { background: #334155; }
    .radar-wrapper { height: 340px; position: relative; }
    .fade-enter { opacity:0; transform:translateY(4px); }
    .fade-enter-active { transition:all .28s; opacity:1; transform:translateY(0); }
    .img-badge {
      position:absolute; top:4px; left:4px;
      background:rgba(0,0,0,0.55); color:#e2e8f0;
      font-size:10px; padding:2px 5px; border-radius:4px;
      letter-spacing:.5px; text-transform:uppercase;
    }
    .note-block { border:1px solid rgba(255,255,255,0.08); background:#0f172a; }
  </style>
</head>
<body class="min-h-screen bg-[#050816] text-slate-100">
<header class="sticky top-0 z-50 backdrop-blur bg-[#050816]/90 border-b border-white/10">
  <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-4">
    <a href="#/" class="text-xl md:text-2xl font-semibold tracking-tight text-cyan-200 hover:text-cyan-300 transition">
      Project Guardian: WW2 Wreck Analysis and Monitoring Platform
    </a>
    <nav class="ml-auto flex items-center gap-2 md:gap-3">
      <a id="nav-home" href="#/" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10">Home</a>
      <a id="nav-list" href="#/list" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10">All Wrecks</a>
      <a id="nav-current-report" href="#/" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white/5 hover:bg-white/10 text-slate-100 border border-white/10 hidden">Current Report</a>
    </nav>
    <div class="hidden md:flex items-center gap-2">
      <img id="header-logo-left" src="https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true" alt="Logo Left" class="h-10 w-auto rounded shadow-soft border border-white/10">
      <img id="header-logo-right" src="https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true" alt="Logo Right" class="h-10 w-auto rounded shadow-soft border border-white/10">
    </div>
  </div>
</header>

<main id="app" class="max-w-7xl mx-auto px-4 py-6 md:py-10"></main>
<div id="toast-stack" class="fixed top-4 right-4 z-[60] space-y-2"></div>

<script type="module">
/* ------------------------------ Config & Constants ------------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyCiqs5iMg-Nj3r6yRszUxFKOIxmMfs5m6Q",
  authDomain: "project-guardian-agent.firebaseapp.com",
  projectId: "project-guardian-agent",
  storageBucket: "project-guardian-agent.firebasestorage.app",
  messagingSenderId: "84395007243",
  appId: "1:84395007243:web:b07e5f4c4264d27611160e",
  measurementId: "G-NRLH3WSCQ9"
};
const appId = "guardian";
const READ_COLLECTIONS = [
  "artifacts/guardian/public/data/werpassessments",
  "artifacts/guardian-agent-default/public/data/werpassessments"
];
const DEFAULT_WRITE_COLLECTION = "artifacts/guardian-agent-default/public/data/werpassessments";
const LOGO_LEFT = "https://raw.githubusercontent.com/ush214/Logos/main/Screenshot%202025-09-02%20114624.jpg?raw=true";
const LOGO_RIGHT = "https://raw.githubusercontent.com/ush214/Logos/main/DeepTrek.jpg?raw=true";

/* ---------- Actionable Severity Thresholds ---------- */
const ACTION_THRESHOLDS = { critical: 60, high: 45, medium: 30 };
const ACTION_MATRIX = {
  critical: { label:"Critical", color:{ fill:"rgba(239,68,68,0.30)", stroke:"rgba(239,68,68,1)" }, action:"Immediate Intervention: In‑situ survey ≤ 1 year; begin pollutant removal planning." },
  high: { label:"High", color:{ fill:"rgba(245,158,11,0.28)", stroke:"rgba(245,158,11,1)" }, action:"Active Monitoring: Non‑invasive ROV survey in 2–3 years." },
  medium: { label:"Medium", color:{ fill:"rgba(250,204,21,0.22)", stroke:"rgba(250,204,21,1)" }, action:"Periodic Review: Reassess every 5 years or after major events." },
  low: { label:"Low", color:{ fill:"rgba(16,185,129,0.28)", stroke:"rgba(16,185,129,1)" }, action:"Archive: No further action unless new information emerges." }
};
function computeSeverityTotal({ wcs, phs, esi, rpm }) { return (wcs + phs + (esi / 3)) * rpm; }
function categorizeSeverity(score) {
  if (score > ACTION_THRESHOLDS.critical) return "critical";
  if (score >= ACTION_THRESHOLDS.high) return "high";
  if (score >= ACTION_THRESHOLDS.medium) return "medium";
  return "low";
}

/* ------------------------------ Imports ------------------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  sendPasswordResetEmail, signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection,
  onSnapshot, arrayUnion
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
import {
  getFunctions, httpsCallable
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

/* ------------------------------ Firebase Init ------------------------------ */
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);
const storage = getStorage(fbApp);
const functions = getFunctions(fbApp, "us-central1");
let callable = { analyzeWerps:null, reassessWerps:null };
try { callable.analyzeWerps = httpsCallable(functions,"analyzeWerps"); } catch {}
try { callable.reassessWerps = httpsCallable(functions,"reassessWerps"); } catch {}

/* ------------------------------ State ------------------------------ */
const state = {
  wrecks: [],
  byIdPath: new Map(),
  currentWreck: null,
  currentRoute: null,
  role: 'user',
  user: null,
  listeners: [],
  filters: { band:'all', stage:'all', search:'' },
  chart: null,
  leafletMap: null,
  leafletMarkers: new Map()
};

/* ------------------------------ Utilities ------------------------------ */
const $ = sel => document.querySelector(sel);
function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c)); }
const getText = v => v==null ? "" : String(v).trim();
const toNum = v => { const n=Number(v); return Number.isFinite(n)?n:null; };
function showToast(msg,type='info'){
  const stack=$('#toast-stack'); if(!stack)return;
  const color=type==='success'?'bg-emerald-600':type==='error'?'bg-rose-600':'bg-slate-700';
  const div=document.createElement('div');
  div.className=`${color} text-white px-4 py-2 rounded-lg shadow-soft border border-white/10 transition fade-enter`;
  div.textContent=msg;
  stack.appendChild(div);
  requestAnimationFrame(()=>div.classList.add('fade-enter-active'));
  setTimeout(()=>{ div.classList.add('opacity-0','-translate-y-1'); setTimeout(()=>div.remove(),240); },2800);
}
const PLACEHOLDER_SVG="data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="240"><rect width="100%" height="100%" fill="#1e293b"/><text x="50%" y="50%" text-anchor="middle" fill="#94a3b8" font-size="14" font-family="Arial">No image</text></svg>');

/* ------------------------------ Severity & Stage ------------------------------ */
function severityBandFromValue(val){ const v=Number(val); if(!Number.isFinite(v)) return 'stable'; if(v>=50) return 'alert'; if(v>=25) return 'warning'; return 'stable'; }
function riskBand(item){
  const b=(item?.severity?.band||"").toLowerCase();
  if(b==='high') return 'alert';
  if(b==='medium') return 'warning';
  if(b==='low') return 'stable';
  return severityBandFromValue(item?.severity?.value);
}
function stageFromItem(it){
  const phase2HasNotes = !!getText(it?.phase2?.summary);
  const phase2Entries = Array.isArray(it?.phase2?.entries) && it.phase2.entries.length;
  const phase2CompletedFlag = it?.phase2?.status === 'completed' || it?.phase2?.completed === true;
  const completedExplicit = it?.completed === true || it?.status === 'completed' || !!it?.phase3 || !!it?.finalizedAt;
  const isCompleted = completedExplicit || phase2CompletedFlag || phase2HasNotes || phase2Entries;
  const isReassess = Boolean(
    it?.needsReassessment === true ||
    it?.seismicEvent === true ||
    (it?.events && (
      it.events.seismic != null ||
      (Array.isArray(it.events) && it.events.some(e=>/seismic|storm|cyclone|earthquake/i.test(e?.type||"")))
    ))
  );
  if(isReassess) return 'reassess';
  return isCompleted ? 'completed' : 'initial';
}

/* ------------------------------ Data helpers ------------------------------ */
function vesselName(it){ return getText(it?.name || it?.title || it?.vesselName || it?.metadata?.vesselName || it?.id || "Unknown"); }
function vesselSummary(it){
  return getText(it?.historical?.circumstancesOfLoss) ||
         getText(it?.historical?.summary) ||
         getText(it?.phase2?.summary) ||
         "No summary available.";
}
function resolveCoordinates(item){
  const toNumL=v=>{ const n=Number(v); return Number.isFinite(n)?n:null; };
  function extract(obj){
    if(!obj)return null;
    if(Array.isArray(obj)&&obj.length>=2){
      const lngA=toNumL(obj[0]); const latA=toNumL(obj[1]);
      if(latA!=null && lngA!=null) return {lat:latA,lng:lngA};
      const latB=toNumL(obj[0]); const lngB=toNumL(obj[1]);
      if(latB!=null && lngB!=null) return {lat:latB,lng:lngB};
      return null;
    }
    if(obj.coordinates){
      const nested=extract(obj.coordinates); if(nested)return nested;
    }
    const lat=toNumL(obj.latitude ?? obj.lat ?? obj.y);
    const lng=toNumL(obj.longitude ?? obj.lng ?? obj.lon ?? obj.x);
    if(lat!=null && lng!=null) return {lat,lng};
    if(obj.latlng){
      const ll=extract(obj.latlng); if(ll)return ll;
    }
    return null;
  }
  const cands=[
    item?.phase1?.screening?.coordinates,
    item?.coordinates,
    item?.location?.coordinates,
    item?.historical?.location?.coordinates,
    item?.location,
    item?.geo,
    item?.position,
    item?.geometry?.coordinates,
    item?.geometry
  ];
  for(const c of cands){ const got=extract(c); if(got) return got; }
  return null;
}

/* ------------------------------ Role / Auth ------------------------------ */
async function fetchRoleFor(uid){
  try{
    const allow=await getDoc(doc(db,"system","allowlist","users",uid));
    if(allow.exists()){
      const d=allow.data()||{};
      let r=d.role ?? d.Role ?? d.ROLE;
      if(typeof r==='string' && r.trim()){
        r=r.trim().toLowerCase();
        if(r.startsWith('admin')) return 'admin';
        if(r.startsWith('contrib')) return 'contributor';
        if(['user','reader','viewer'].includes(r)) return 'user';
      }
      if(d.admin===true) return 'admin';
      if(d.contributor===true) return 'contributor';
      if(d.allowed===true) return 'user';
    }
  }catch{}
  try{
    const legacy=await getDoc(doc(db,`artifacts/${appId}/private/users/${uid}`));
    if(legacy.exists()){
      const d=legacy.data()||{};
      let r=d.role ?? d.Role ?? d.ROLE;
      if(typeof r==='string' && r.trim()){
        r=r.trim().toLowerCase();
        if(r.startsWith('admin')) return 'admin';
        if(r.startsWith('contrib')) return 'contributor';
        if(['user','reader','viewer'].includes(r)) return 'user';
      }
      if(d.admin===true) return 'admin';
      if(d.contributor===true) return 'contributor';
    }
  }catch{}
  return 'user';
}

/* ------------------------------ Firestore Listeners ------------------------------ */
function detachListeners(){ for(const u of state.listeners){ try{u();}catch{} } state.listeners=[]; }
function normalizeDoc(d){
  const out={...d};
  if(d && typeof d.data==='object') Object.assign(out,d.data);
  if(d && typeof d.payload==='object') Object.assign(out,d.payload);
  if(d && typeof d.attributes==='object') Object.assign(out,d.attributes);
  if(d && typeof d.details==='object') Object.assign(out,d.details);
  return out;
}
async function startData(){
  detachListeners();
  const byKey=new Map();
  const applySnap=(snap, basePath)=>{
    snap.forEach(docSnap=>{
      const raw=docSnap.data()||{};
      const d={...normalizeDoc(raw), id: raw.id || docSnap.id, _path: basePath};
      if(String(d?.type||"").toUpperCase().includes("SEISMIC_EVENT")) return;
      d.severity = d.severity && typeof d.severity==='object'? d.severity : {};
      if(d.severity.value==null) d.severity.value = raw?.severity?.value ?? raw?.severityValue;
      if(!d.severity.band) d.severity.band = severityBandFromValue(d.severity.value);
      byKey.set(`${basePath}::${d.id}`, d);
      state.byIdPath.set(d.id, basePath);
    });
    state.wrecks = Array.from(byKey.values());
    renderApp();
    refreshLeafletMarkers();
  };
  for(const p of READ_COLLECTIONS){
    try{
      const un=onSnapshot(collection(db,p),(snap)=>applySnap(snap,p),(err)=>console.error("Snapshot error",p,err));
      state.listeners.push(un);
    }catch(e){ console.error("Listener error",p,e); }
  }
}

/* ------------------------------ Image Aggregation (Uploads only) ------------------------------ */
function collectUploadedImages(it){
  const results=[];
  if(Array.isArray(it?.phase2?.assets)){
    for(const a of it.phase2.assets){
      if(!a?.url) continue;
      if(a.source!=='upload') continue;
      if(!/\.(png|jpe?g|webp|gif|bmp|svg|tiff?)$/i.test(a.name||a.path||a.url)) continue;
      results.push({url:a.url, source:'Upload'});
    }
  }
  return results;
}
function firstUploadThumb(it){
  const imgs=collectUploadedImages(it);
  return imgs[0]?.url || PLACEHOLDER_SVG;
}

/* ------------------------------ Leaflet Map ------------------------------ */
function initLeaflet(){
  if(state.leafletMap || typeof L==='undefined') return;
  state.leafletMap = L.map('leaflet-map',{ zoomControl:true }).setView([10,150],3);
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{
    attribution:"&copy; OpenStreetMap contributors"
  }).addTo(state.leafletMap);
}
function markerIconFor(band){
  const color=band==='alert'?'red':band==='warning'?'orange':'green';
  return L.icon({
    iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
  });
}
function refreshLeafletMarkers(){
  if(!state.leafletMap) return;
  for(const m of state.leafletMarkers.values()){ try{ state.leafletMap.removeLayer(m);}catch{} }
  state.leafletMarkers.clear();
  const riskFilter=state.filters.band;
  const stageFilter=state.filters.stage;
  const term=state.filters.search.toLowerCase();
  const filtered=state.wrecks.filter(it=>{
    const rb=riskBand(it);
    if(riskFilter!=='all' && rb!==riskFilter) return false;
    const st=stageFromItem(it);
    if(stageFilter!=='all' && st!==stageFilter) return false;
    if(term && !vesselName(it).toLowerCase().includes(term)) return false;
    return resolveCoordinates(it)!=null;
  });
  filtered.forEach(it=>{
    const coord=resolveCoordinates(it);
    if(!coord) return;
    const band=riskBand(it);
    const marker=L.marker([coord.lat,coord.lng],{ icon:markerIconFor(band) });
    const thumb=firstUploadThumb(it);
    const popupHtml=`
      <div style="min-width:200px">
        <div style="font-weight:600;font-size:14px">${escapeHtml(vesselName(it))}</div>
        <div style="font-size:11px;color:#64748b;margin-bottom:4px">Stage: ${stageFromItem(it)}</div>
        <div style="margin:4px 0 6px">
          <img src="${thumb}" onerror="this.src='${PLACEHOLDER_SVG}'"
               style="width:100%;max-height:140px;object-fit:cover;border:1px solid #334155;border-radius:6px"/>
        </div>
        <a href="#/wreck/${encodeURIComponent(it.id)}"
           style="display:inline-block;font-size:12px;color:#0ea5e9;text-decoration:underline;">View Assessment</a>
      </div>`;
    marker.bindPopup(popupHtml);
    marker.addTo(state.leafletMap);
    state.leafletMarkers.set(it.id, marker);
  });
}
function initLeafletMapIfNeeded(){ if(!state.leafletMap){ initLeaflet(); } }

/* ------------------------------ Debounce ------------------------------ */
function debounce(fn,ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ------------------------------ Auth Panel ------------------------------ */
function buildAuthPanel(){
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden">
    <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-cyan-200">Authentication</h2>
      <button id="toggle-auth" class="text-sm text-cyan-300 hover:text-cyan-200 transition">Toggle</button>
    </div>
    <div id="auth-body" class="p-4 grid md:grid-cols-2 gap-6">
      <form id="auth-form" data-auth-hidden>
        <label class="block text-sm mb-1">Email</label>
        <input id="login-email" type="email" autocomplete="username" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600" placeholder="you@example.com"/>
        <label class="block text-sm mt-3 mb-1">Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600"/>
        <div class="flex gap-2 mt-4 flex-wrap">
          <button type="button" id="btn-signin" class="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm">Sign In</button>
          <button type="button" id="btn-create" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Create Account</button>
          <button type="button" id="btn-reset" class="px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm">Reset Password</button>
        </div>
        <div id="auth-msg" class="text-xs text-slate-400 mt-2 h-5"></div>
      </form>
      <div data-auth-visible class="hidden space-y-3">
        <div class="text-sm">
          <div><span class="font-medium text-slate-300">Signed in as:</span> <span id="auth-email" class="text-cyan-300"></span></div>
          <div><span class="font-medium text-slate-300">Role:</span> <span id="auth-role" class="text-cyan-300"></span></div>
        </div>
        <button id="btn-signout" class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 text-white text-sm">Sign Out</button>
      </div>
    </div>
  </div>`;
}

/* ------------------------------ Analyze Panel ------------------------------ */
function buildAnalyzePanel(){
  const isContributor=['admin','contributor'].includes(state.role);
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden mt-6">
    <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-cyan-200">Assessment Actions</h2>
      <span class="text-xs text-slate-400">Role: ${state.role}</span>
    </div>
    <div class="p-4 space-y-4">
      <form id="analyze-form" class="flex flex-col md:flex-row gap-3">
        <input id="analysis-input" type="text" placeholder="Vessel name..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600"/>
        <div class="flex gap-2">
          <button id="btn-analyze" type="submit" class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm ${!isContributor?'opacity-50 cursor-not-allowed':''}">Analyze</button>
          <button id="btn-reassess" type="button" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm ${!isContributor?'opacity-50 cursor-not-allowed':''}">Reassess</button>
        </div>
      </form>
      <div id="analyze-status" class="text-xs text-slate-400 h-5"></div>
    </div>
  </div>`;
}

/* ------------------------------ Map Card ------------------------------ */
function buildMapCard(){
  return `
  <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden mt-6">
    <div class="p-4 md:p-5 border-b border-white/10 flex flex-col xl:flex-row gap-4 xl:items-center">
      <div class="flex items-center gap-1 text-sm flex-wrap">
        <span class="mr-2 font-medium text-slate-200">Risk:</span>
        ${['all','alert','warning','stable'].map(r=>`<button data-filter-risk="${r}" class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">${r[0].toUpperCase()+r.slice(1)}</button>`).join('')}
      </div>
      <div class="flex items-center gap-1 text-sm flex-wrap">
        <span class="mr-2 font-medium text-slate-200">Stage:</span>
        ${['all','initial','completed','reassess'].map(r=>`<button data-filter-stage="${r}" class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10">${r[0].toUpperCase()+r.slice(1)}</button>`).join('')}
      </div>
      <div class="xl:ml-auto w-full xl:w-72">
        <input id="map-search" type="text" placeholder="Search..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-600"/>
      </div>
    </div>
    <div class="relative">
      <div id="leaflet-map" class="w-full h-[550px] bg-slate-800"></div>
    </div>
    <div class="p-4 border-t border-white/10">
      <h3 class="text-base font-semibold text-cyan-200">Flagged for Reassessment</h3>
      <div id="reassess-list" class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>
  </div>`;
}
function renderReassessList(){
  const wrap=$('#reassess-list'); if(!wrap) return;
  wrap.innerHTML='';
  const list=state.wrecks.filter(w=>
    w?.needsReassessment===true ||
    w?.seismicEvent===true ||
    (w?.events && (
      w.events.seismic != null ||
      (Array.isArray(w.events) && w.events.some(e=>/seismic|storm|cyclone|earthquake/i.test(e?.type||"")))
    ))
  );
  if(!list.length){
    wrap.innerHTML='<div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-slate-300">None currently.</div>';
    return;
  }
  list.forEach(it=>{
    const band=riskBand(it);
    const badge=band==='alert'?'bg-rose-500/20 text-rose-200 border-rose-400/30':
                band==='warning'?'bg-amber-400/20 text-amber-200 border-amber-300/30':
                'bg-emerald-400/20 text-emerald-200 border-emerald-300/30';
    const a=document.createElement('a');
    a.href=`#/wreck/${encodeURIComponent(it.id)}`;
    a.className='block rounded-lg bg-slate-800/60 border border-white/10 hover:bg-slate-800 transition p-3 space-y-2';
    a.innerHTML=`
      <div class="flex items-center justify-between gap-3">
        <div class="font-medium truncate">${escapeHtml(vesselName(it))}</div>
        <span class="px-2 py-0.5 text-xs rounded-md border ${badge}">${band.toUpperCase()}</span>
      </div>
      <div class="text-xs text-slate-400 line-clamp-2">${escapeHtml(vesselSummary(it))}</div>
    `;
    wrap.appendChild(a);
  });
}

/* ------------------------------ Auth UI ------------------------------ */
function updateAuthUI(){
  const signedIn=!!state.user;
  $('#auth-email') && ($('#auth-email').textContent = state.user?.email || '');
  $('#auth-role') && ($('#auth-role').textContent = state.role);
  document.querySelectorAll('[data-auth-visible]').forEach(el=>el.classList.toggle('hidden', !signedIn));
  document.querySelectorAll('[data-auth-hidden]').forEach(el=>el.classList.toggle('hidden', signedIn));

  const isContributor = ['admin','contributor'].includes(state.role);
  ['btn-analyze','btn-reassess','btn-save-phase2','btn-select-files'].forEach(id=>{
    const b=$('#'+id);
    if(b){
      if(!isContributor){ b.disabled=true; b.classList.add('opacity-50','cursor-not-allowed'); }
      else { b.disabled=false; b.classList.remove('opacity-50','cursor-not-allowed'); }
    }
  });
  const notes=$('#phase2-notes');
  if(notes){
    if(!isContributor) notes.setAttribute('disabled','true');
    else notes.removeAttribute('disabled');
  }
}

/* ------------------------------ Home ------------------------------ */
function renderHome(){
  const app=$('#app');
  app.innerHTML = buildAuthPanel() + buildAnalyzePanel() + buildMapCard();

  $('#toggle-auth')?.addEventListener('click',()=>$('#auth-body')?.classList.toggle('hidden'));
  $('#btn-signin')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim(); const pass=$('#login-pass').value;
    $('#auth-msg').textContent='Signing in...';
    try{ await signInWithEmailAndPassword(auth,email,pass); $('#auth-msg').textContent='Signed in.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-create')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim(); const pass=$('#login-pass').value;
    $('#auth-msg').textContent='Creating...';
    try{ await createUserWithEmailAndPassword(auth,email,pass); $('#auth-msg').textContent='Account created.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-reset')?.addEventListener('click', async ()=>{
    const email=$('#login-email').value.trim();
    if(!email){ $('#auth-msg').textContent='Enter email first.'; return; }
    try{ await sendPasswordResetEmail(auth,email); $('#auth-msg').textContent='Reset email sent.'; }
    catch(e){ $('#auth-msg').textContent=e?.message||'Failed.'; }
  });
  $('#btn-signout')?.addEventListener('click', async ()=>{ try{ await signOut(auth);}catch{} });

  $('#analyze-form')?.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!['admin','contributor'].includes(state.role)){ showToast("Insufficient role","error"); return; }
    const name=getText($('#analysis-input').value);
    if(!name){ showToast("Enter vessel name","error"); return; }
    $('#analyze-status').textContent='Requesting analysis...';
    try{
      if(!callable.analyzeWerps) throw new Error("analyzeWerps not deployed");
      await callable.analyzeWerps({ vesselName:name, appId, targetPath: DEFAULT_WRITE_COLLECTION, source:"web-ui" });
      $('#analysis-input').value="";
      $('#analyze-status').textContent='Analysis requested.';
      showToast("Analysis requested","success");
    }catch(e){
      $('#analyze-status').textContent='Error: '+(e?.message||'failed');
      showToast("Analysis failed","error");
    }
  });
  $('#btn-reassess')?.addEventListener('click', async ()=>{
    if(!['admin','contributor'].includes(state.role)){ showToast("Insufficient role","error"); return; }
    const name=getText($('#analysis-input').value);
    if(!name){ showToast("Enter vessel name","error"); return; }
    $('#analyze-status').textContent='Requesting reassessment...';
    try{
      if(!callable.reassessWerps) throw new Error("reassessWerps not deployed");
      await callable.reassessWerps({ vesselName:name, appId, targetPath: DEFAULT_WRITE_COLLECTION, source:"web-ui" });
      $('#analysis-input').value="";
      $('#analyze-status').textContent='Reassessment requested.';
      showToast("Reassessment requested","success");
    }catch(e){
      $('#analyze-status').textContent='Error: '+(e?.message||'failed');
      showToast("Reassessment failed","error");
    }
  });

  document.querySelectorAll('[data-filter-risk]').forEach(btn=>{
    btn.addEventListener('click',()=>{ state.filters.band = btn.getAttribute('data-filter-risk'); refreshLeafletMarkers(); });
  });
  document.querySelectorAll('[data-filter-stage]').forEach(btn=>{
    btn.addEventListener('click',()=>{ state.filters.stage = btn.getAttribute('data-filter-stage'); refreshLeafletMarkers(); });
  });
  $('#map-search')?.addEventListener('input', debounce(e=>{
    state.filters.search = e.target.value || '';
    refreshLeafletMarkers();
  },250));

  initLeaflet();
  refreshLeafletMarkers();
  renderReassessList();
  updateAuthUI();
}

/* ------------------------------ RPM + Report Helpers ------------------------------ */
function readRPMFactors(it){
  const rpm=it?.rpm;
  if(!rpm) return [];
  if(Array.isArray(rpm.parameters)) return rpm.parameters;
  if(Array.isArray(rpm.factors)) return rpm.factors;
  if(Array.isArray(rpm.breakdown)) return rpm.breakdown;
  if(Array.isArray(rpm.factorBreakdown)) return rpm.factorBreakdown;
  const maps=['factors','parameters','breakdown','factorMap'];
  for(const k of maps){
    const obj=rpm[k];
    if(obj && typeof obj==='object'){
      return Object.entries(obj).map(([name,v])=>{
        if(v && typeof v==='object')
          return { name, rationale:v.rationale ?? v.reason ?? "", value:v.value ?? v.multiplier ?? v.weight ?? v.score ?? "" };
        return { name, rationale:"", value:v ?? "" };
      });
    }
  }
  const skip=new Set(["finalMultiplier","multiplier","notes","rationale","comment","comments","factors","parameters"]);
  if(rpm && typeof rpm==='object'){
    return Object.entries(rpm)
      .filter(([k])=>!skip.has(k))
      .map(([name,v])=> v && typeof v==='object'
        ? { name, rationale:v.rationale ?? v.reason ?? "", value:v.value ?? v.multiplier ?? v.weight ?? v.score ?? "" }
        : { name, rationale:"", value:v ?? "" });
  }
  return [];
}
function rpmFinalMultiplier(it){
  const m=toNum(it?.rpm?.finalMultiplier ?? it?.rpm?.multiplier);
  return Number.isFinite(m)?m:1;
}

/* ------------------------------ Radar (Threshold Model) ------------------------------ */
function drawRadar(vWCS, vPHS, vESI, vRPM){
  const ctx=document.getElementById('werp-radar'); if(!ctx) return;
  if(state.chart){ try{ state.chart.destroy(); }catch{} }
  const max=20;
  const dataPoints=[
    Math.max(0,Math.min(20,Number(vWCS||0))),
    Math.max(0,Math.min(20,(Number(vPHS||0)/10)*20)),
    Math.max(0,Math.min(20,(Number(vESI||0)/40)*20)),
    Math.max(0,Math.min(20,((Math.min(Math.max(Number(vRPM||1),0.5),2.5)-0.5)/2.0)*20))
  ];
  const severityScore=computeSeverityTotal({ wcs:Number(vWCS||0), phs:Number(vPHS||0), esi:Number(vESI||0), rpm:Number(vRPM||1) });
  const categoryKey=categorizeSeverity(severityScore);
  const cat=ACTION_MATRIX[categoryKey];
  const centerTextPlugin={
    id:'centerText',
    afterDraw(chart){
      const { ctx, chartArea:{ width,height,left,top } }=chart;
      ctx.save();
      ctx.font='600 15px Inter, Arial, sans-serif';
      ctx.fillStyle='#e2e8f0';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(cat.label,left+width/2, top+height/2-8);
      ctx.font='500 11px Inter, Arial';
      ctx.fillStyle='#94a3b8';
      ctx.fillText(severityScore.toFixed(1), left+width/2, top+height/2+12);
      ctx.restore();
    }
  };
  state.chart=new Chart(ctx,{
    type:'radar',
    data:{ labels:['WCS','PHS','ESI','RPM'], datasets:[{ label:'Risk Profile', data:dataPoints, backgroundColor:cat.color.fill, borderColor:cat.color.stroke, borderWidth:2, pointBackgroundColor:cat.color.stroke, pointBorderColor:cat.color.stroke, pointRadius:3 }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ r:{ beginAtZero:true, min:0, max, ticks:{ stepSize:4, showLabelBackdrop:false, color:'#64748b' }, grid:{ color:'rgba(148,163,184,0.25)' }, angleLines:{ color:'rgba(148,163,184,0.25)' }, pointLabels:{ color:'#e2e8f0', font:{ size:11 } } } },
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:ctx=>`${ctx.label}: ${ctx.formattedValue}` } } }
    },
    plugins:[centerTextPlugin]
  });
  let panel=document.getElementById('action-threshold-panel');
  if(!panel){
    panel=document.createElement('div');
    panel.id='action-threshold-panel';
    panel.className='mt-4 rounded-lg border border-white/10 bg-slate-800/60 p-4 text-sm';
    ctx.canvas.parentElement.appendChild(panel);
  }
  panel.innerHTML=`
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="text-slate-300"><span class="font-medium text-slate-200">Severity Score:</span> <span class="font-semibold">${severityScore.toFixed(2)}</span></div>
        <div class="mt-1">
          <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold" style="background:${cat.color.fill};color:${cat.color.stroke}">${cat.label.toUpperCase()}</span>
        </div>
      </div>
      <div class="md:text-right text-slate-400 leading-snug">
        <span class="text-slate-300 font-medium">Required Action:</span><br>${escapeHtml(cat.action)}
      </div>
    </div>`;
}

/* ------------------------------ Phase 2 Save & Upload + Entries ------------------------------ */
async function savePhase2Entry(){
  if(!state.currentWreck) return;
  const path=state.byIdPath.get(state.currentWreck.id);
  if(!path){ showToast("Path not found","error"); return; }
  const val=getText($('#phase2-notes').value);
  if(!val){ showToast("Enter text","error"); return; }
  $('#phase2-status').textContent='Saving...';
  const userIdent = state.user?.email || state.user?.uid || 'anonymous';
  try{
    await updateDoc(doc(db,path,state.currentWreck.id),{
      "phase2.entries": arrayUnion({ text: val, createdAtMs: Date.now(), user: userIdent }),
      "phase2.summary": val.slice(0,240),
      "phase2.updatedAt": serverTimestamp()
    });
    $('#phase2-status').textContent='Saved.';
    showToast("Entry saved","success");
    $('#phase2-notes').value="";
    appendPhase2EntryLocal({ text: val, createdAtMs: Date.now(), user: userIdent });
  }catch(e){
    $('#phase2-status').textContent='Error';
    showToast(e?.message||"Save failed","error");
  } finally {
    setTimeout(()=>$('#phase2-status').textContent='',2000);
  }
}
function appendPhase2EntryLocal(entry){
  const list=$('#phase2-entries'); if(!list) return;
  const li=document.createElement('div');
  li.className='note-block rounded-lg p-3 text-sm space-y-1';
  const ts=new Date(entry.createdAtMs).toLocaleString();
  li.innerHTML=`
    <div class="flex items-center justify-between">
      <span class="text-xs uppercase tracking-wide px-2 py-0.5 rounded bg-cyan-600/20 text-cyan-300 border border-cyan-500/30">${escapeHtml(entry.user||'user')}</span>
      <span class="text-xs text-slate-400">${ts}</span>
    </div>
    <div class="text-slate-200 whitespace-pre-wrap leading-relaxed">${escapeHtml(entry.text)}</div>`;
  list.prepend(li);
}
function sanitizeFileName(name=""){ return String(name).replace(/[^A-Za-z0-9._-]+/g,'_').slice(0,140) || `file_${Date.now()}`; }
async function handleUploadSelection(e){
  const files=Array.from(e.target.files||[]);
  if(!files.length || !state.currentWreck) return;
  const path=state.byIdPath.get(state.currentWreck.id);
  if(!path){ showToast("Path not found","error"); return; }
  $('#phase2-status').textContent=`Uploading ${files.length} file(s)...`;
  const basePath=`artifacts/${appId}/public/uploads/${state.currentWreck.id}/user`;
  let ok=0, fail=0;
  for(const f of files){
    try{
      if(!/^image\//i.test(f.type)){ fail++; continue; }
      const safe=sanitizeFileName(f.name);
      const fileKey=`${Date.now()}_${safe}`;
      const ref=storageRef(storage,`${basePath}/${fileKey}`);
      await uploadBytes(ref,f,{ contentType:f.type });
      const url=await getDownloadURL(ref);
      const asset={ name:f.name, path:`${basePath}/${fileKey}`, url, contentType:f.type, bytes:f.size, source:'upload', uploadedAtMs:Date.now() };
      await updateDoc(doc(db,path,state.currentWreck.id),{
        "phase2.assets": arrayUnion(asset),
        "phase2.assetsUpdatedAt": serverTimestamp()
      });
      ok++;
    }catch(ex){ console.error("Upload failed",ex); fail++; }
  }
  $('#phase2-status').textContent = ok ? `Uploaded ${ok}${fail?`, failed ${fail}`:''}` : 'Upload failed';
  showToast($('#phase2-status').textContent, ok?'success':'error');
  setTimeout(()=>$('#phase2-status').textContent='',3000);
}

/* ------------------------------ Exports ------------------------------ */
function wireExports(it){
  $('#btn-export-pdf')?.addEventListener('click',()=>exportPdf(it));
  $('#btn-export-html')?.addEventListener('click',()=>exportHtml(it));
  $('#btn-export-md')?.addEventListener('click',()=>exportMarkdown(it));
  $('#btn-export-json')?.addEventListener('click',()=>exportJson(it));
}
function exportHtml(it){
  const node=$('#report-export-root'); if(!node) return;
  const vessel=vesselName(it);
  const actionPanel=document.getElementById('action-threshold-panel');
  const clone=node.cloneNode(true);
  if(actionPanel && !clone.querySelector('#action-threshold-panel')) clone.appendChild(actionPanel.cloneNode(true));
  const entries=$('#phase2-entries');
  if(entries && !clone.querySelector('#phase2-entries')) clone.appendChild(entries.cloneNode(true));
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(vessel)}</title></head><body>${clone.outerHTML}</body></html>`;
  downloadBlob(`${vessel.replace(/\s+/g,'_')}.html`, new Blob([html],{type:'text/html;charset=utf-8'}));
}
function exportMarkdown(it){
  const vessel=vesselName(it);
  const sev=computeSeverityTotal({
    wcs:Number(it?.totals?.wcs||0),
    phs:Number(it?.totals?.phs||0),
    esi:Number(it?.totals?.esi||0),
    rpm:rpmFinalMultiplier(it)
  });
  const cat=ACTION_MATRIX[categorizeSeverity(sev)];
  const lines=[
    `# ${vessel}`,
    ``,
    `**Severity Score:** ${sev.toFixed(2)} (${cat.label})`,
    ``,
    `- WCS: ${toNum(it?.totals?.wcs)?.toFixed(2) ?? ''}`,
    `- PHS: ${toNum(it?.totals?.phs)?.toFixed(2) ?? ''}`,
    `- ESI: ${toNum(it?.totals?.esi)?.toFixed(2) ?? ''}`,
    `- RPM: ${rpmFinalMultiplier(it).toFixed(2)}×`,
    ``,
    `**Required Action:** ${cat.action}`
  ];
  downloadBlob(`${vessel.replace(/\s+/g,'_')}.md`, new Blob([lines.join('\n')],{type:'text/markdown;charset=utf-8'}));
}
function exportJson(it){
  const vessel=vesselName(it);
  downloadBlob(`${vessel.replace(/\s+/g,'_')}.json`, new Blob([JSON.stringify(it,null,2)],{type:'application/json;charset=utf-8'}));
}
function exportPdf(it){
  const node=$('#report-export-root'); if(!node) return;
  const vessel=vesselName(it);
  const actionPanel=document.getElementById('action-threshold-panel');
  if(actionPanel && !node.querySelector('#action-threshold-panel')) node.appendChild(actionPanel.cloneNode(true));
  const entries=$('#phase2-entries');
  if(entries && !node.querySelector('#phase2-entries')) node.appendChild(entries.cloneNode(true));
  const opt={
    margin:0.4,
    filename:`${vessel.replace(/\s+/g,'_')}_Report.pdf`,
    image:{type:'jpeg',quality:0.95},
    html2canvas:{scale:2, backgroundColor:'#050816'},
    jsPDF:{unit:'in', format:'a4', orientation:'portrait'}
  };
  window.html2pdf ? html2pdf().from(node).set(opt).save() : showToast("html2pdf not loaded","error");
}
function downloadBlob(filename, blob){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

/* ------------------------------ List View ------------------------------ */
function renderList(){
  const app=$('#app');
  const term=state.filters.search.toLowerCase();
  const items=state.wrecks.filter(it=>vesselName(it).toLowerCase().includes(term));
  app.innerHTML=`
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <a href="#/" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">← Home</a>
      <span class="ml-auto text-xs px-2 py-1 rounded-md bg-slate-800 border border-white/10 text-slate-300">Role: ${state.role}</span>
    </div>
    <div class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden">
      <div class="p-4 border-b border-white/10 flex flex-col md:flex-row md:items-center gap-3">
        <div class="text-lg font-semibold text-cyan-200">All Wrecks</div>
        <div class="md:ml-auto w-full md:w-80">
          <input id="list-search" type="text" placeholder="Search..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-600"/>
        </div>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="list-grid">
        ${items.map(it=>{
          const band=riskBand(it);
          const badge=band==='alert'?'bg-rose-500/20 text-rose-200 border-rose-400/30':
                      band==='warning'?'bg-amber-400/20 text-amber-200 border-amber-300/30':
                      'bg-emerald-400/20 text-emerald-200 border-emerald-300/30';
          const thumb=firstUploadThumb(it);
          return `
            <a href="#/wreck/${encodeURIComponent(it.id)}" class="block rounded-xl bg-slate-800/60 border border-white/10 hover:bg-slate-800 transition overflow-hidden">
              <img src="${thumb}" onerror="this.src='${PLACEHOLDER_SVG}'" class="w-full h-40 object-cover border-b border-white/10" alt="">
              <div class="p-3">
                <div class="flex items-center justify-between gap-3">
                  <h3 class="font-medium truncate">${escapeHtml(vesselName(it))}</h3>
                  <span class="px-2 py-0.5 rounded-md text-xs border ${badge}">${band.toUpperCase()}</span>
                </div>
                <p class="text-xs text-slate-400 mt-1 line-clamp-2">${escapeHtml(vesselSummary(it))}</p>
              </div>
            </a>`;
        }).join('') || `<div class="text-slate-400 text-sm">No wrecks loaded.</div>`}
      </div>
    </div>`;
  $('#list-search')?.addEventListener('input', e=>{
    state.filters.search = e.target.value || '';
    renderList();
  });
  updateAuthUI();
}

/* ------------------------------ Report View ------------------------------ */
function renderReport(route){
  const app=$('#app');
  const it=state.wrecks.find(w=>String(w.id)===String(route.id));
  state.currentWreck=it||null;
  if(!it){
    app.innerHTML='<div class="text-slate-300">Wreck not found. <a href="#/" class="text-cyan-400 underline">Back</a></div>';
    return;
  }
  const images=collectUploadedImages(it);
  const wcsParams = Array.isArray(it?.wcs?.parameters)?it.wcs.parameters:[];
  const phsParams = Array.isArray(it?.phs?.parameters)?it.phs.parameters:[];
  const esiParams = Array.isArray(it?.esi?.parameters)?it.esi.parameters:[];
  const rpmFactors=readRPMFactors(it);
  const vWCS = toNum(it?.totals?.wcs) ?? wcsParams.reduce((s,p)=>s+(toNum(p.score)||0),0);
  const vPHS = toNum(it?.totals?.phs) ?? (phsParams.length? Math.min(10, phsParams.reduce((s,p)=>s+(toNum(p.score)||0),0)/phsParams.length):0);
  const vESI = toNum(it?.totals?.esi) ?? esiParams.reduce((s,p)=>s+(toNum(p.score)||0),0);
  const vRPM = rpmFinalMultiplier(it);
  function tableRows(list,withWeight=false){
    if(!list.length) return `<tr><td class="py-2 text-slate-500" colspan="${withWeight?4:3}">No data.</td></tr>`;
    return list.map(p=>{
      const w=p.weightPercent ?? p.weightPct ?? p.percentage ?? p.percent ?? p.weight;
      return `<tr class="border-t border-white/5">
        <td class="py-2 pr-3">${escapeHtml(p.name||p.parameter||'')}</td>
        <td class="py-2 pr-3 text-slate-300">${escapeHtml(p.rationale||'')}</td>
        ${withWeight? `<td class="py-2 pr-3 text-right">${w!=null?Number(w).toFixed(0)+'%':''}</td>`:''}
        <td class="py-2 pr-3 text-right tabular-nums">${toNum(p.score)?.toFixed(2) ?? ''}</td>
      </tr>`;
    }).join("");
  }
  function rpmRows(){
    if(!rpmFactors.length) return `<tr><td class="py-2 text-slate-500" colspan="3">No factor breakdown supplied.</td></tr>`;
    return rpmFactors.map(f=>`
      <tr class="border-t border-white/5">
        <td class="py-2 pr-3">${escapeHtml(f.name||f.factor||'')}</td>
        <td class="py-2 pr-3 text-slate-300">${escapeHtml(f.rationale||'Not specified.')}</td>
        <td class="py-2 pr-3 text-right tabular-nums">${escapeHtml(String(f.value??f.multiplier??''))}</td>
      </tr>`).join("");
  }
  const coords=resolveCoordinates(it);
  const coordLine=coords? `${coords.lat.toFixed(4)}°, ${coords.lng.toFixed(4)}°` : '';
  const galleryHtml = images.length
    ? `<div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        ${images.slice(0,18).map(img=>`
          <div class="relative rounded-lg overflow-hidden border border-white/10 bg-slate-800 group">
            <img src="${img.url}" loading="lazy" onerror="this.src='${PLACEHOLDER_SVG}'" class="w-full h-32 md:h-40 object-cover group-hover:opacity-90" alt="upload">
            <span class="img-badge">${img.source}</span>
          </div>`).join("")}
      </div>`
    : `<div class="text-xs text-slate-500">No uploaded images yet.</div>`;
  app.innerHTML=`
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <a href="#/" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">← Home</a>
      <a href="#/list" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-sm">All Wrecks</a>
      <span class="ml-auto text-xs px-2 py-1 rounded-md bg-slate-800 border border-white/10 text-slate-300">Role: ${state.role}</span>
    </div>
    <div class="flex items-center justify-between mb-4 bg-slate-900/70 border border-white/10 rounded-lg px-4 py-2">
      <img src="${LOGO_LEFT}" alt="Logo Left" class="h-10 w-auto rounded border border-white/10">
      <h2 class="text-base md:text-lg font-semibold tracking-wide text-cyan-200 text-center flex-1">WERP Risk Report</h2>
      <img src="${LOGO_RIGHT}" alt="Logo Right" class="h-10 w-auto rounded border border-white/10">
    </div>
    <section class="bg-slate-900 border border-white/10 rounded-xl shadow-card overflow-hidden">
      <div class="p-5 border-b border-white/10 flex flex-col md:flex-row md:items-end gap-4 justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-cyan-200">${escapeHtml(vesselName(it))}</h1>
          <p class="text-slate-300 text-sm mt-1">${escapeHtml(vesselSummary(it))}</p>
          ${coordLine? `<p class="text-xs text-slate-500 mt-1">Coordinates: ${coordLine}</p>`:''}
        </div>
        <div class="flex gap-2 flex-wrap">
          <button id="btn-export-pdf" class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm">PDF</button>
          <button id="btn-export-html" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm">HTML</button>
          <button id="btn-export-md" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">MD</button>
          <button id="btn-export-json" class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm">JSON</button>
        </div>
      </div>
      <div class="p-5 grid grid-cols-1 lg:grid-cols-3 gap-6" id="report-export-root">
        <div class="space-y-6 lg:col-span-1">
          <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
            <h3 class="font-medium mb-3">Historical / Images</h3>
            <ul class="text-sm space-y-1 text-slate-300">
              ${it?.historical?.vesselType? `<li><span class="text-slate-400">Type:</span> ${escapeHtml(it.historical.vesselType)}</li>`:''}
              ${it?.historical?.vesselSizeTonnage? `<li><span class="text-slate-400">Size:</span> ${escapeHtml(it.historical.vesselSizeTonnage)}</li>`:''}
              ${it?.historical?.ageAndSinking?.launchedYear!=null? `<li><span class="text-slate-400">Launched:</span> ${escapeHtml(String(it.historical.ageAndSinking.launchedYear))}</li>`:''}
              ${it?.historical?.ageAndSinking?.sunkDate? `<li><span class="text-slate-400">Sunk:</span> ${escapeHtml(String(it.historical.ageAndSinking.sunkDate))}</li>`:''}
              ${it?.historical?.location?.depthMeters!=null? `<li><span class="text-slate-400">Depth (m):</span> ${escapeHtml(String(it.historical.location.depthMeters))}</li>`:''}
              ${coordLine? `<li><span class="text-slate-400">Coords:</span> ${coordLine}</li>`:''}
            </ul>
            <div class="mt-4">${galleryHtml}</div>
          </div>
          <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
            <h3 class="font-medium mb-3">Phase 2: In-situ Report</h3>
            <textarea id="phase2-notes" rows="4" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-600" placeholder="Enter new in-situ observation..."></textarea>
            <div class="flex gap-2 mt-3 flex-wrap">
              <input id="phase2-files" type="file" multiple class="hidden" />
              <button id="btn-select-files" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 text-sm">Select Files</button>
              <button id="btn-save-phase2" class="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-sm">Save Note</button>
              <span id="phase2-status" class="text-xs text-slate-400 self-center"></span>
            </div>
          </div>
        </div>
        <div class="space-y-6 lg:col-span-2">
          <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4 radar-wrapper">
            <h3 class="font-medium mb-3">Risk Radar</h3>
            <canvas id="werp-radar" class="w-full h-full"></canvas>
            <p class="mt-2 text-xs text-slate-400">
              WCS: ${Number(vWCS||0).toFixed(2)} • PHS: ${Number(vPHS||0).toFixed(2)} • ESI: ${Number(vESI||0).toFixed(2)} • RPM: ${Number(vRPM||1).toFixed(2)}×
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
              <h4 class="font-medium mb-3">WCS</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead class="text-left text-slate-300"><tr><th class="pr-3 pb-2">Parameter</th><th class="pr-3 pb-2">Rationale</th><th class="text-right pb-2">Score</th></tr></thead>
                  <tbody>${tableRows(wcsParams,false)}</tbody>
                </table>
              </div>
              <p class="text-sm text-slate-300 mt-2">Total: <span class="font-semibold">${Number(vWCS||0).toFixed(2)}</span></p>
            </div>
            <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
              <h4 class="font-medium mb-3">RPM</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead class="text-left text-slate-300"><tr><th class="pr-3 pb-2">Factor</th><th class="pr-3 pb-2">Rationale</th><th class="text-right pb-2">Value</th></tr></thead>
                  <tbody>${rpmRows()}</tbody>
                </table>
              </div>
              <p class="text-sm text-slate-300 mt-2">Final Multiplier: <span class="font-semibold">${Number(vRPM||1).toFixed(2)}×</span></p>
            </div>
          </div>
          <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
            <h4 class="font-medium mb-3">PHS (Pollution Hazard)</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-slate-300"><tr><th class="pr-3 pb-2">Parameter</th><th class="pr-3 pb-2">Rationale</th><th class="text-right pb-2">Weight (%)</th><th class="text-right pb-2">Score</th></tr></thead>
                <tbody>${tableRows(phsParams,true)}</tbody>
              </table>
            </div>
          </div>
          <div class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
            <h4 class="font-medium mb-3">ESI (Environmental Sensitivity)</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-slate-300"><tr><th class="pr-3 pb-2">Parameter</th><th class="pr-3 pb-2">Rationale</th><th class="text-right pb-2">Score</th></tr></thead>
                <tbody>${tableRows(esiParams,false)}</tbody>
              </table>
            </div>
          </div>
          <div id="phase2-entries-wrapper" class="bg-slate-800/50 border border-white/10 rounded-xl p-4">
            <h4 class="font-medium mb-3">In-situ Note Log</h4>
            <div id="phase2-entries" class="space-y-3 text-sm">
              ${(Array.isArray(it?.phase2?.entries)?[...it.phase2.entries]:[])
                 .sort((a,b)=>(b?.createdAtMs||0)-(a?.createdAtMs||0))
                 .map(e=>{
                   const ts=e?.createdAtMs? new Date(e.createdAtMs).toLocaleString(): '';
                   return `<div class="note-block rounded-lg p-3 space-y-1">
                     <div class="flex items-center justify-between">
                       <span class="text-xs uppercase tracking-wide px-2 py-0.5 rounded bg-cyan-600/20 text-cyan-300 border border-cyan-500/30">${escapeHtml(e.user||'user')}</span>
                       <span class="text-xs text-slate-400">${escapeHtml(ts)}</span>
                     </div>
                     <div class="text-slate-200 whitespace-pre-wrap leading-relaxed">${escapeHtml(e.text||'')}</div>
                   </div>`;
                 }).join('') || '<div class="text-xs text-slate-500">No entries yet.</div>'}
            </div>
          </div>
        </div>
      </div>
    </section>`;
  drawRadar(vWCS,vPHS,vESI,vRPM);
  wireExports(it);
  const isContributor=['admin','contributor'].includes(state.role);
  if(isContributor){
    $('#btn-save-phase2')?.addEventListener('click', savePhase2Entry);
    $('#btn-select-files')?.addEventListener('click',()=>{ $('#phase2-files').value=""; $('#phase2-files').click(); });
    $('#phase2-files')?.addEventListener('change', handleUploadSelection);
  } else {
    ['phase2-notes','btn-save-phase2','btn-select-files'].forEach(id=>$('#'+id)?.setAttribute('disabled','true'));
  }
  updateAuthUI();
}

/* ------------------------------ Router ------------------------------ */
const routes={ home:/^#\/?$/, report:/^#\/wreck\/([^/]+)$/, list:/^#\/list\/?$/ };
function parseRoute(){
  const h=location.hash||'#/';
  if(routes.home.test(h)) return { name:'home' };
  const m=h.match(routes.report); if(m) return { name:'report', id:decodeURIComponent(m[1]) };
  if(routes.list.test(h)) return { name:'list' };
  return { name:'home' };
}
window.addEventListener('hashchange',()=>renderApp());
function setActiveNav(route){
  const map={ home:'#nav-home', list:'#nav-list', report:'#nav-current-report' };
  document.querySelectorAll('nav a').forEach(a=>{ a.classList.remove('ring-2','ring-cyan-500'); a.removeAttribute('aria-current'); });
  const sel=map[route.name]; if(sel){ const el=document.querySelector(sel); if(el){ el.classList.add('ring-2','ring-cyan-500'); el.setAttribute('aria-current','page'); } }
  if(route.name==='report' && state.currentWreck){
    const cr=document.querySelector('#nav-current-report');
    cr?.classList.remove('hidden');
    cr.href=`#/wreck/${encodeURIComponent(state.currentWreck.id)}`;
  }
}

/* ------------------------------ Root Render ------------------------------ */
function renderApp(){
  const route=parseRoute();
  state.currentRoute=route;
  setActiveNav(route);
  if(route.name==='home') renderHome();
  else if(route.name==='report') renderReport(route);
  else if(route.name==='list') renderList();
  else renderHome();
  if(route.name==='home'){
    initLeaflet();
    refreshLeafletMarkers();
    renderReassessList();
  }
}

/* ------------------------------ Auth State ------------------------------ */
onAuthStateChanged(auth, async (user)=>{
  state.user=user;
  if(!user){
    state.role='user';
    updateAuthUI();
    renderApp();
    return;
  }
  state.role=await fetchRoleFor(user.uid);
  updateAuthUI();
  renderApp();
  startData();
});

/* ------------------------------ Initial ------------------------------ */
renderApp();

/* ------------------------------ Public API ------------------------------ */
window.ProjectGuardian={
  loadData(payload){
    if(!payload || !Array.isArray(payload.wrecks)) return;
    state.wrecks=payload.wrecks.map(w=>({...w, id:w.id || w.name || crypto.randomUUID()}));
    renderApp(); refreshLeafletMarkers();
  },
  setFilters({ band, stage, search }={}){
    if(band) state.filters.band=band;
    if(stage) state.filters.stage=stage;
    if(typeof search==='string') state.filters.search=search;
    renderApp(); refreshLeafletMarkers();
  },
  getState(){
    return {
      wrecks: state.wrecks.slice(),
      filters:{...state.filters},
      role: state.role,
      user: state.user?.email || null
    };
  },
  debugState(){ console.log("State", state); }
};
</script>
</body>
</html>